!function a(b,c,d){function e(g,h){if(!c[g]){if(!b[g]){var i="function"==typeof require&&require;if(!h&&i)return i(g,!0);if(f)return f(g,!0);var j=new Error("Cannot find module '"+g+"'");throw j.code="MODULE_NOT_FOUND",j}var k=c[g]={exports:{}};b[g][0].call(k.exports,function(a){var c=b[g][1][a];return e(c?c:a)},k,k.exports,a,b,c,d)}return c[g].exports}for(var f="function"==typeof require&&require,g=0;g<d.length;g++)e(d[g]);return e}({1:[function(a,b){function c(a){var b=siesta._.extend({},a.__values);b.collection=a.collectionName,b.model=a.modelName,b._id=a._id,a.removed&&(b._deleted=!0);var c=a._rev;return c&&(b._rev=c),b=_.reduce(a._relationshipNames,function(b,c){var d=a[c];return siesta.isArray(d)?b[c]=_.pluck(d,"_id"):d&&(b[c]=d._id),b},b)}function d(a,b){delete a.collection,delete a.model;var c=b._relationshipNames;return _.each(c,function(b){var c=a[b];a[b]=siesta.isArray(c)?_.map(c,function(a){return{_id:a}}):{_id:c}}),a}function e(a,b){var c=a.collectionName,e=a.modelName;if(u.trace){var f=c+"."+e;u.trace("Loading instances for "+f)}var g=k[c][e],h=function(a){"$1"==a.model&&"$2"==a.collection&&emit(a._id,a)}.toString().replace("$1",e).replace("$2",c);u.trace.isEnabled&&u.trace("Querying pouch"),p.query({map:h}).then(function(a){u.trace.isEnabled&&u.trace("Queried pouch succesffully");var c=siesta._.map(siesta._.pluck(a.rows,"value"),function(a){return d(a,g)});u.trace.isEnabled&&u.trace("Mapping data",c),g.map(c,{disableevents:!0,_ignoreInstalled:!0},function(a,c){a?u.error("Error loading models",a):u.trace&&u.trace("Loaded "+c.length.toString()+" instances for "+f),b(a,c)})}).catch(function(a){b(a)})}function f(a){var b=m.defer(a),c=k.collectionNames,d=[];return _.each(c,function(a){var b=k[a],c=Object.keys(b._models);_.each(c,function(b){d.push(function(c){e({collectionName:a,modelName:b},c)})})}),siesta.async.parallel(d,function(a,c){if(!a){var d=[];siesta._.each(c,function(a){d.concat(a)}),u.trace&&u.trace("Loaded "+d.length.toString()+" instances")}b.finish(a)}),b.promise}function g(a,b,c){p.allDocs({keys:_.pluck(a,"_id")}).then(function(d){for(var e=0;e<d.rows.length;e++)a[e]._rev=d.rows[e].value.rev;h(a,b,c)}).catch(function(a){c.reject(a)})}function h(a,b,d){var e=[];p.bulkDocs(_.map(a,c)).then(function(c){for(var f=0;f<c.length;f++){var h=c[f],i=a[f];h.ok?i._rev=h.rev:409==h.status?e.push(i):u.error('Error saving object with _id="'+i._id+'"',h)}e.length?g(e,b,d):(b(),d&&d.resolve())},function(a){b(a),d&&d.reject(a)})}function i(a){var b=m.defer(a);return siesta._afterInstall(function(){a=a||function(){};var c=q;q=[],r={},s={},u.trace&&u.trace("Saving objects",_.map(c,function(a){return a._dump()})),h(c,a,b)}),b.promise}if("undefined"==typeof siesta&&"undefined"==typeof b)throw new Error("Could not find window.siesta. Make sure you include siesta.core.js first.");var j=siesta._internal,k=(j.cache,j.CollectionRegistry),l=j.log,m=j.util,n=j.events,o="siesta",p=new PouchDB(o),q=[],r={},s={},t={},u=l.loggerWithName("Storage");u.setLevel(siesta.log.warn);var v=function(a){var b=a.obj,c=b._id;if(!b)throw new j.error.InternalSiestaError("No obj field in notification received by storage extension");if(!(c in r)){r[c]=b,q.push(b);var d=b.collectionName;s[d]||(s[d]={});var e=b.model.name;s[d][e]||(s[d][e]={}),s[d][e][c]=b}};siesta.on("Siesta",v),_.extend(t,{_load:f,save:i,_serialise:c,_reset:function(a){siesta.removeListener("Siesta",v),q=[],r={},p.destroy(function(b){b||(p=new PouchDB(o)),siesta.on("Siesta",v),u.warn("Reset complete"),a(b)})}}),Object.defineProperties(t,{_unsavedObjects:{get:function(){return q}},_unsavedObjectsHash:{get:function(){return r}},_unsavedObjectsByCollection:{get:function(){return s}},_pouch:{get:function(){return p}}}),siesta.ext||(siesta.ext={}),siesta.ext.storage=t,Object.defineProperties(siesta.ext,{storageEnabled:{get:function(){return void 0!==siesta.ext._storageEnabled?siesta.ext._storageEnabled:!!siesta.ext.storage},set:function(a){siesta.ext._storageEnabled=a},enumerable:!0}});var w,x,y=1e3;Object.defineProperties(siesta,{autosave:{get:function(){return!!w},set:function(a){a?w||(w=setInterval(function(){x||(x=!0,siesta.save(function(a){a||n.emit("saved"),x=!1}))},siesta.autosaveInterval)):w&&(clearInterval(w),w=null)}},autosaveInterval:{get:function(){return y},set:function(a){y=a,w&&(siesta.autosave=!1,siesta.autosave=!0)}},dirty:{get:function(){var a=siesta.ext.storage._unsavedObjectsByCollection;return!!Object.keys(a).length},enumerable:!0}}),_.extend(siesta,{save:i,setPouch:function(a){if(!siesta._canChange)throw new Error("Cannot change PouchDB instance when an object graph exists.");p=a}}),"undefined"==typeof PouchDB&&(siesta.ext.storageEnabled=!1,u.error("Storage extension is present but could not find PouchDB. Have you included pouchdb.js in your project? It must be present at window.PouchDB!")),b.exports=t},{}]},{},[1]);