!function a(b,c,d){function e(g,h){if(!c[g]){if(!b[g]){var i="function"==typeof require&&require;if(!h&&i)return i(g,!0);if(f)return f(g,!0);var j=new Error("Cannot find module '"+g+"'");throw j.code="MODULE_NOT_FOUND",j}var k=c[g]={exports:{}};b[g][0].call(k.exports,function(a){var c=b[g][1][a];return e(c?c:a)},k,k.exports,a,b,c,d)}return c[g].exports}for(var f="function"==typeof require&&require,g=0;g<d.length;g++)e(d[g]);return e}({1:[function(a,b){function c(a){d.call(this,a),this.indexAttribute="index"}{var d=a("./reactiveQuery"),e=a("./log"),f=a("./util"),g=a("./error"),h=g.InternalSiestaError,i=a("./querySet"),j=g.errorFactory(g.Components.ArrangedReactiveQuery),k=f._;e.loggerWithName("Query")}c.prototype=Object.create(d.prototype),k.extend(c.prototype,{_refreshIndexes:function(){var a=this.results,b=this.indexAttribute;if(!a)throw new h("ArrangedReactiveQuery must be initialised");for(var c=0;c<a.length;c++){var d=a[c];d[b]=c}},_mergeIndexes:function(){for(var a=this.results,b=[],c=[],d=[],e=0;e<a.length;e++){var f=a[e],g=f[this.indexAttribute];void 0==g?d.push(f):g>a.length?c.push(f):b[g]?d.push(f):b[g]=f}for(c=k.sortBy(c,function(a){return a[this.indexAttribute]}.bind(this)),e=0;e<c.length;e++){f=c[e];var h=this.results.length-c.length+e;f[this.indexAttribute]=h,b[h]=f}d=this._query._sortResults(d);for(var j=0;d.length;){for(f=d.shift();b[j];)j++;b[j]=f,f[this.indexAttribute]=j}this.results=i(b,this.model)},init:function(a){var b=f.defer(a);return d.prototype.init.call(this,function(a){a||(this.model.hasAttributeNamed(this.indexAttribute)?(this._mergeIndexes(),this._query.clearOrdering()):a=j('Model "'+this.model.name+'" does not have an attribute named "'+this.indexAttribute+'"')),b.finish(a,a?null:this.results)}.bind(this)),b.promise},_handleNotif:function(a){a.field!=this.indexAttribute&&(d.prototype._handleNotif.call(this,a),this._refreshIndexes())},validateIndex:function(a){var b=this.results.length-1,c=0;if(!(a>=c&&b>=a))throw new Error("Index "+a.toString()+" is out of bounds")},swapObjectsAtIndexes:function(a,b){this.validateIndex(a),this.validateIndex(b);var c=this.results[a],d=this.results[b];if(!c)throw new Error('No model at index "'+a.toString()+'"');if(!d)throw new Error('No model at index "'+b.toString()+'"');this.results[b]=c,this.results[a]=d,c[this.indexAttribute]=b,d[this.indexAttribute]=a},swapObjects:function(a,b){var c=this.results.indexOf(a),d=this.results.indexOf(b);this.swapObjectsAtIndexes(c,d)},move:function(a,b){this.validateIndex(a),this.validateIndex(b);var c=this.results.mutableCopy();(function(a,b){if(b>=this.length)for(var c=b-this.length;c--+1;)this.push(void 0);this.splice(b,0,this.splice(a,1)[0])}).call(c,a,b),this.results=c.asModelQuerySet(this.model),this._refreshIndexes()}}),b.exports=c},{"./error":11,"./log":14,"./querySet":21,"./reactiveQuery":22,"./util":25}],2:[function(a,b){function c(a){var b=this;this.model=a,d.subProperties(this,this.model,["collection","collectionName","_attributeNames",{name:"idField",property:"id"},{name:"modelName",property:"name"}]),Object.defineProperties(this,{_relationshipNames:{get:function(){var a=e.map(Object.keys(b.__proxies||{}),function(a){return b.__proxies[a]});return e.map(a,function(a){return a.isForward?a.forwardName:a.reverseName})},enumerable:!0,configurable:!0},dirty:{get:function(){return siesta.ext.storageEnabled?b._id in siesta.ext.storage._unsavedObjectsHash:void 0},enumerable:!0}}),this.removed=!1}var d=(a("./log"),a("./util")),e=d._,f=a("./error"),g=(f.InternalSiestaError,a("./modelEvents")),h=a("./events"),i=a("./cache");e.extend(c.prototype,{get:function(a){var b=d.defer(a);return a=b.finish.bind(b),a(null,this),b.promise},remove:function(a,b){b=null==b?!0:b;var c=d.defer(a);a=c.finish.bind(c),i.remove(this),this.removed=!0,b&&g.emit({collection:this.collectionName,model:this.model.name,_id:this._id,old:this,type:g.ModelEventType.Remove,obj:this});var e=this.model.remove;if(e){var f=d.paramNames(e);if(f.length){var h=this;e.call(this,function(b){a(b,h)})}else e.call(this),a(null,this)}else a(null,this);return c.promise},restore:function(a){var b=d.defer(a);a=b.finish.bind(b);var c=function(b){b||g.emit({collection:this.collectionName,model:this.model.name,_id:this._id,"new":this,type:g.ModelEventType.New,obj:this}),a(b,this)}.bind(this);if(this.removed){i.insert(this),this.removed=!1;var e=this.model.init;if(e){var f=d.paramNames(e);f.length?e.call(this,c):(e.call(this),c())}else c()}return b.promise}}),e.extend(c.prototype,{listen:function(a){return h.on(this._id,a),function(){this.removeListener(a)}.bind(this)},listenOnce:function(a){return h.once(this._id,a)},removeListener:function(a){return h.removeListener(this._id,a)}}),e.extend(c.prototype,{getAttributes:function(){return e.extend({},this.__values)},isInstanceOf:function(a){return this.model==a},isA:function(a){return this.model==a||this.model.isDescendantOf(a)}}),e.extend(c.prototype,{_dumpString:function(a){return JSON.stringify(this._dump(a,null,4))},_dump:function(){var a=e.extend({},this.__values);return a._rev=this._rev,a._id=this._id,a}}),b.exports=c},{"./cache":8,"./error":11,"./events":12,"./log":14,"./modelEvents":18,"./util":25}],3:[function(a,b){function c(a){d.call(this,a),this.isReverse&&(this.related=[])}var d=a("./RelationshipProxy"),e=(a("./store"),a("./util")),f=e._,g=(a("./error").InternalSiestaError,a("./modelEvents")),h=(a("./modelInstance"),a("./events")),i=h.wrapArray,j=a("../vendor/observe-js/src/observe").ArrayObserver,k=a("./modelEvents").ModelEventType;c.prototype=Object.create(d.prototype),f.extend(c.prototype,{clearReverse:function(a){var b=this;f.each(a,function(a){var c=b.reverseProxyForInstance(a);c.setIdAndRelated(null)})},setReverseOfAdded:function(a){var b=this;f.each(a,function(a){var c=b.reverseProxyForInstance(a);c.setIdAndRelated(b.object)})},wrapArray:function(a){var b=this;if(i(a,this.reverseName,this.object),!a.arrayObserver){a.arrayObserver=new j(a);var c=function(c){c.forEach(function(c){var d=c.addedCount?a.slice(c.index,c.index+c.addedCount):[],e=c.removed;b.clearReverse(e),b.setReverseOfAdded(d);var f=b.getForwardModel();g.emit({collection:f.collectionName,model:f.name,_id:b.object._id,field:b.getForwardName(),removed:e,added:d,type:k.Splice,index:c.index,obj:b.object})})};a.arrayObserver.open(c)}},get:function(a){var b=e.defer(a);return a=b.finish.bind(b),a(null,this.related),b.promise},validate:function(a){var b=Object.prototype.toString.call(a);if(this.isForward){if("[object Array]"==b)return"Cannot assign array forward oneToMany ("+b+"): "+this.forwardName}else if("[object Array]"!=b)return"Cannot scalar to reverse oneToMany ("+b+"): "+this.reverseName;return null},set:function(a,b){this.checkInstalled();var c=this;if(a){var d;if(d=this.validate(a))return d;this.clearReverseRelated(b),c.setIdAndRelated(a,b),c.isReverse&&this.wrapArray(c.related),c.setIdAndRelatedReverse(a,b)}else this.clearReverseRelated(b),c.setIdAndRelated(a,b)},install:function(a){d.prototype.install.call(this,a),this.isReverse&&(a["splice"+e.capitaliseFirstLetter(this.reverseName)]=f.bind(this.splice,this),this.wrapArray(this.related))}}),b.exports=c},{"../vendor/observe-js/src/observe":31,"./RelationshipProxy":6,"./error":11,"./events":12,"./modelEvents":18,"./modelInstance":19,"./store":23,"./util":25}],4:[function(a,b){function c(a){d.call(this,a)}{var d=a("./RelationshipProxy"),e=(a("./store"),a("./util"));a("./error").InternalSiestaError,a("./modelEvents").ModelEventType,a("./modelInstance")}c.prototype=Object.create(d.prototype),_.extend(c.prototype,{validate:function(a){return"[object Array]"==Object.prototype.toString.call(a)?"Cannot assign array to one to one relationship":null},set:function(a,b){if(console.log("related",this.object,this.related),console.log("set",this.object,a),this.checkInstalled(),a){var c;if(c=this.validate(a))return c;this.clearReverseRelated(b),this.setIdAndRelated(a,b),this.setIdAndRelatedReverse(a,b)}else this.clearReverseRelated(b),this.setIdAndRelated(a,b)},get:function(a){var b=e.defer(a);return a=b.finish.bind(b),a(null,this.related),b.promise}}),b.exports=c},{"./RelationshipProxy":6,"./error":11,"./modelEvents":18,"./modelInstance":19,"./store":23,"./util":25}],5:[function(a,b){function c(a,b){var c={};for(var d in b)b.hasOwnProperty(d)&&"__"==d.slice(0,2)&&(c[d.slice(2)]=b[d],delete b[d]);k.extend(this,{model:a,query:b,opts:c}),c.order=c.order||[],g.isArray(c.order)||(c.order=[c.order])}function d(a){var b,c=f._localCacheByType,d=a.name,e=a.collectionName,g=c[e];return g&&(b=g[d]||{}),b}var e=a("./log"),f=a("./cache"),g=a("./util"),h=a("./error"),i=a("./querySet"),j=h.errorFactory(h.Components.Query),k=g._,l=e.loggerWithName("Query");k.extend(c,{comparators:{e:function(a){var b=a.object[a.field];if(l.trace){var c;c=null===b?"null":void 0===b?"undefined":b.toString(),l.trace(a.field+": "+c+" == "+a.value.toString())}return b==a.value},lt:function(a){return a.invalid?!1:a.object[a.field]<a.value},gt:function(a){return a.invalid?!1:a.object[a.field]>a.value},lte:function(a){return a.invalid?!1:a.object[a.field]<=a.value},gte:function(a){return a.invalid?!1:a.object[a.field]>=a.value}},registerComparator:function(a,b){this.comparators[a]||(this.comparators[a]=b)}}),k.extend(c.prototype,{execute:function(a){var b=g.defer(a);return a=b.finish.bind(b),this._executeInMemory(a),b.promise},_dump:function(a){return a?"{}":{}},sortFunc:function(a){for(var b=function(a,b){return function(c,d){return a?c[b]-d[b]:d[b]-c[b]}},c=g,d=0;d<a.length;d++){var e=a[d];c=c.thenBy(b(e.ascending,e.field))}return c},_sortResults:function(a){var b=this.opts.order;if(a&&b){var c=k.map(b,function(a){var b=a.split("-"),c=!0,d=null;return b.length>1?(d=b[1],c=!1):d=b[0],{field:d,ascending:c}}.bind(this)),d=this.sortFunc(c);a.immutable&&(a=a.mutableCopy()),a.sort(d)}return a},_getCacheByLocalId:function(){return k.reduce(this.model.descendants,function(a,b){return k.extend(a,d(b))},k.extend({},d(this.model)))},_executeInMemory:function(a){var b=function(){for(var b,c=this._getCacheByLocalId(),d=Object.keys(c),e=this,f=[],g=0;g<d.length;g++){var h=d[g],k=c[h],l=e.objectMatchesQuery(k);if("string"==typeof l){b=j(l);break}l&&f.push(k)}f=this._sortResults(f),a(b,b?null:i(f,this.model))}.bind(this);this.opts.ignoreInstalled?b():siesta._afterInstall(b)},clearOrdering:function(){this.opts.order=null},objectMatchesOrQuery:function(a,b){for(var c in b)if(b.hasOwnProperty(c)){var d=b[c];if(this.objectMatchesBaseQuery(a,d))return!0}return!1},objectMatchesAndQuery:function(a,b){for(var c in b)if(b.hasOwnProperty(c)){var d=b[c];if(!this.objectMatchesBaseQuery(a,d))return!1}return!0},splitMatches:function(a,b,d){var e="e",f=b.split("."),g=f[f.length-1].split("__");if(2==g.length){var h=g[0];e=g[1]}else h=g[0];f[f.length-1]=h,k.each(f.slice(0,f.length-1),function(b){a=a[b]});var i=a[h],j=null===i||void 0===i,l=c.comparators[e],m={object:a,field:h,value:d,invalid:j};return l?l(m):'No comparator registered for query operation "'+e+'"'},objectMatches:function(a,b,c,d){if("$or"==b){if(!this.objectMatchesOrQuery(a,d.$or))return!1}else if("$and"==b){if(!this.objectMatchesAndQuery(a,d.$and))return!1}else{var e=this.splitMatches(a,b,c);if("boolean"!=typeof e)return e;if(!e)return!1}return!0},objectMatchesBaseQuery:function(a,b){for(var c=Object.keys(b),d=0;d<c.length;d++){var e=c[d],f=b[e],g=this.objectMatches(a,e,f,b);if("boolean"!=typeof g)return g;if(!g)return!1}return!0},objectMatchesQuery:function(a){return this.objectMatchesBaseQuery(a,this.query)}}),b.exports=c},{"./cache":8,"./error":11,"./log":14,"./querySet":21,"./util":25}],6:[function(a,b){function c(a){var b=this;a=a||{},f.extend(this,{object:null,related:null}),Object.defineProperties(this,{isForward:{get:function(){return!b.isReverse},set:function(a){b.isReverse=!a},enumerable:!0}}),e.extendFromOpts(this,a,{reverseModel:null,forwardModel:null,forwardName:null,reverseName:null,isReverse:null}),this.cancelListens={}}var d=a("./error").InternalSiestaError,e=(a("./store"),a("./util")),f=e._,g=(a("./query"),a("./log"),a("./cache"),a("./events")),h=g.wrapArray,i=a("../vendor/observe-js/src/observe").ArrayObserver,j=a("./modelEvents"),k=j.ModelEventType;f.extend(c,{}),f.extend(c.prototype,{install:function(a){if(!a)throw new d("No object passed to relationship install");if(this.object)throw new d("Already installed.");this.object=a;var b=this,c=this.getForwardName();Object.defineProperty(a,c,{get:function(){return b.related},set:function(a){b.set(a)},configurable:!0,enumerable:!0}),a.__proxies||(a.__proxies={}),a.__proxies[c]=this,a._proxies||(a._proxies=[]),a._proxies.push(this)}}),f.extend(c.prototype,{set:function(){throw new d("Must subclass RelationshipProxy")},get:function(){throw new d("Must subclass RelationshipProxy")}}),f.extend(c.prototype,{proxyForInstance:function(a,b){var c,g=b?this.getReverseName():this.getForwardName(),h=b?this.reverseModel:this.forwardModel;if(e.isArray(a))c=f.map(a,function(a){return a.__proxies[g]});else{var i=a.__proxies[g];if(!i){var j='No proxy with name "'+g+'" on mapping '+h.name;throw new d(j)}c=i}return c},reverseProxyForInstance:function(a){return this.proxyForInstance(a,!0)},getReverseName:function(){return this.isForward?this.reverseName:this.forwardName},getForwardName:function(){return this.isForward?this.forwardName:this.reverseName},getForwardModel:function(){return this.isForward?this.forwardModel:this.reverseModel},clearRemovalListener:function(a){console.log("clearRemovalListener",a);var b=a._id,c=this.cancelListens[b];c&&(c(),this.cancelListens[b]=null)},listenForRemoval:function(a){console.log("listenForRemoval",a),this.cancelListens[a._id]=a.listen(function(b){if(b.type==k.Remove){if(e.isArray(this.related)){var c=this.related.indexOf(a);this.splice(c,1)}else this.setIdAndRelated(null);this.clearRemovalListener(a)}}.bind(this))},setIdAndRelated:function(a,b){b=b||{},b.disableevents||this.registerSetChange(a);var c=this.related;c&&this.clearRemovalListener(c),a?e.isArray(a)?(this.related=a,a.forEach(function(a){this.listenForRemoval(a)}.bind(this))):(this.related=a,this.listenForRemoval(a)):this.related=null},checkInstalled:function(){if(!this.object)throw new d("Proxy must be installed on an object before can use it.")},splicer:function(a){return a=a||{},function(b,c){a=a||{},a.disableevents||this.registerSpliceChange.apply(this,arguments);var d=Array.prototype.slice.call(arguments,2);return f.partial(this.related.splice,b,c).apply(this.related,d)}.bind(this)},clearReverseRelated:function(a){a=a||{};var b=this;if(this.related){var c=this.reverseProxyForInstance(this.related),d=e.isArray(c)?c:[c];f.each(d,function(c){if(e.isArray(c.related)){var d=c.related.indexOf(b.object);c.makeChangesToRelatedWithoutObservations(function(){c.splicer(a)(d,1)})}else c.setIdAndRelated(null,a)})}},setIdAndRelatedReverse:function(a,b){var c=this,d=this.reverseProxyForInstance(a),g=e.isArray(d)?d:[d];f.each(g,function(a){e.isArray(a.related)?a.makeChangesToRelatedWithoutObservations(function(){a.splicer(b)(a.related.length,0,c.object)}):(a.clearReverseRelated(b),a.setIdAndRelated(c.object,b))})},makeChangesToRelatedWithoutObservations:function(a){this.related?(this.related.arrayObserver.close(),this.related.arrayObserver=null,a(),this.wrapArray(this.related)):a()},registerSetChange:function(a){var b=this.object;if(!b)throw new d("Proxy must have an object associated");var c=b.model.name,f=b.collectionName,g=this.related;e.isArray(g)&&!g.length&&(g=null),j.emit({collection:f,model:c,_id:b._id,field:this.getForwardName(),old:g,"new":a,type:k.Set,obj:b})},registerSpliceChange:function(a,b){var c=Array.prototype.slice.call(arguments,2),d=this.object.model.name,e=this.object.collectionName;j.emit({collection:e,model:d,_id:this.object._id,field:this.getForwardName(),index:a,removed:this.related?this.related.slice(a,a+b):null,added:c.length?c:[],type:k.Splice,obj:this.object})},wrapArray:function(a){var b=this;if(h(a,this.reverseName,this.object),!a.arrayObserver){a.arrayObserver=new i(a);var c=function(c){c.forEach(function(c){var d=c.addedCount?a.slice(c.index,c.index+c.addedCount):[],e=b.getForwardModel();j.emit({collection:e.collectionName,model:e.name,_id:b.object._id,field:b.getForwardName(),removed:c.removed,added:d,type:k.Splice,obj:b.object})})};a.arrayObserver.open(c)}},splice:function(){this.splicer({}).apply(this,arguments)}}),b.exports=c},{"../vendor/observe-js/src/observe":31,"./cache":8,"./error":11,"./events":12,"./log":14,"./modelEvents":18,"./query":20,"./store":23,"./util":25}],7:[function(a,b){b.exports={OneToMany:"OneToMany",OneToOne:"OneToOne",ManyToMany:"ManyToMany"}},{}],8:[function(a,b,c){function d(){x={},v={},w={}}function e(a){var b=v[a];return b?u.debug.isEnabled&&u.debug("Local cache hit: "+b._dump(!0)):u.debug.isEnabled&&u.debug("Local cache miss: "+a),b}function f(a){var b=a.name,c=a.collectionName,d=w[c];if(d){var e=d[b];if(e){var f=[];for(var g in e)e.hasOwnProperty(g)&&f.push(e[g]);if(f.length>1){var h="A singleton model has more than 1 object in the cache! This is a serious error. Either a model has been modified after objects have already been created, or something has gonevery wrong. Please file a bug report if the latter.";throw new s(h)}if(f.length)return f[0]}}return null}function g(a,b){var c=b.model.name,d=b.model.collectionName,e=x[d];if(e){var f=x[d][c];if(f){var g=f[a];return g?u.debug&&u.debug("Remote cache hit: "+g._dump(!0)):u.debug&&u.debug("Remote cache miss: "+a),g}}return u.debug&&u.debug("Remote cache miss: "+a),null}function h(a,b,c){if(!a){var d="Must pass an object when inserting to cache";throw u.error(d),new s(d)}var e=a.model.collectionName;if(!e)throw new s("Model has no collection",{model:a.model,obj:a});x[e]||(x[e]={});var f=a.model.name;if(!f)throw new s("Model has no type",{model:a.model,obj:a});x[e][f]||(x[e][f]={}),c&&(x[e][f][c]=null);var g=x[e][f][b];if(g){if(a!=g){var h="Object "+e.toString()+":"+f.toString()+"["+a.model.id+'="'+b+'"] already exists in the cache. This is a serious error, please file a bug report if you are experiencing this out in the wild';throw u.error(h,{obj:a,cachedObject:g}),new s(h)}u.debug.isEnabled&&u.debug("Object has already been inserted: "+a._dump(!0))}else x[e][f][b]=a,u.debug.isEnabled&&u.debug("Remote cache insert: "+a._dump(!0)),u.trace.isEnabled&&u.trace("Remote cache now looks like: "+i(!0))}function i(a){var b={};for(var c in x)if(x.hasOwnProperty(c)){var d={};b[c]=d;var e=x[c];for(var f in e)if(e.hasOwnProperty(f)){var g={};d[f]=g;var h=e[f];for(var i in h)h.hasOwnProperty(i)&&h[i]&&(g[i]=h[i]._dump())}}return a?t.prettyPrint(4):b}function j(a){var b={};for(var c in v)v.hasOwnProperty(c)&&(b[c]=v[c]._dump());return a?t.prettyPrint(4):b}function k(a){var b={localCache:j(),remoteCache:i()};return a?t.prettyPrint(4):b}function l(){return x}function m(){return v}function n(a){u.debug.isEnabled&&u.debug("get",a);var b,c,d,h=a._id;if(h)return b=e(h),b?b:a.model?(c=a.model.id,d=a[c],u.debug.isEnabled&&u.debug(c+"="+d),g(d,a)):null;if(a.model){if(c=a.model.id,d=a[c])return g(d,a);if(a.model.singleton)return f(a.model)}else u.warn("Invalid opts to cache",{opts:a});return null}function o(a){var b=a._id;if(b){var c=a.model.collectionName,d=a.model.name;if(u.debug.isEnabled&&u.debug("Local cache insert: "+a._dumpString()),v[b]){if(v[b]!=a){var e='Object with _id="'+b.toString()+'" is already in the cache. This is a serious error. Please file a bug report if you are experiencing this out in the wild';throw u.error(e),new s(e)}}else v[b]=a,u.trace.isEnabled&&u.trace("Local cache now looks like: "+j(!0)),w[c]||(w[c]={}),w[c][d]||(w[c][d]={}),w[c][d][b]=a}var f=a.idField,g=a[f];g?h(a,g):u.debug.isEnabled&&u.debug('No remote id ("'+f+'") so wont be placing in the remote cache',a)}function p(a){var b={_id:a._id},c=a.model;return c.id&&a[c.id]&&(b.model=c,b[c.id]=a[c.id]),!!n(b)}function q(a){if(!p(a))throw new s("Object was not in cache.");var b=a.model.collectionName,c=a.model.name,d=a._id;if(!c)throw s("No mapping name");if(!b)throw s("No collection name");if(!d)throw s("No _id");if(delete w[b][c][d],delete v[d],a.model.id){var e=a[a.model.id];e&&delete x[b][c][e]}}var r=a("./log"),s=a("./error").InternalSiestaError,t=a("./util"),u=r.loggerWithName("Cache"),v={},w={},x={};c._remoteCache=l,c._localCache=m,Object.defineProperty(c,"_localCacheByType",{get:function(){return w}}),c.get=n,c.insert=o,c.remoteInsert=h,c.reset=d,c._dump=k,c.contains=p,c.remove=q},{"./error":11,"./log":14,"./util":25}],9:[function(a,b){function c(a,b){var c=this;if(!a)throw new Error("Collection must have a name");j.extendFromOpts(this,b||{},{baseURL:""}),k.extend(this,{name:a,_rawModels:{},_models:{},installed:!1}),Object.defineProperties(this,{dirty:{get:function(){if(siesta.ext.storageEnabled){var a=siesta.ext.storage._unsavedObjectsByCollection,b=a[c.name]||{};return!!Object.keys(b).length}return void 0},enumerable:!0}}),e.register(this)}var d=a("./log"),e=a("./collectionRegistry").CollectionRegistry,f=a("./error").InternalSiestaError,g=a("./model"),h=a("extend"),i=(a("../vendor/observe-js/src/observe").Platform,a("./events")),j=a("./util"),k=j._,l=a("./error"),m=l.errorFactory(l.Components.Collection),n=(a("./cache"),["PUT","PATCH","POST","DELETE"]),o=d.loggerWithName("Collection");k.extend(c.prototype,{install:function(a){var b=j.defer(a),c=this;if(this.installed){var d=new f('Collection "'+this.name+'" has already been installed');c._finaliseInstallation(d,b.finish.bind(b))}else{var e=[];for(var g in this._models)if(this._models.hasOwnProperty(g)){var h=this._models[g];e.push(h)}if(o.info.isEnabled&&o.info("There are "+e.length.toString()+" mappings to install"),e.length){var i=k.map(e,function(a){return k.bind(a.install,a)});j.async.parallel(i,function(a){if(a)o.error("Failed to install collection",a),c._finaliseInstallation(a,b.finish.bind(b));else{c.installed=!0;var d=[];k.each(e,function(a){o.info.isEnabled&&o.info('Installing relationships for mapping with name "'+a.name+'"');var b=a.installRelationships();b&&d.push(b)}),d.length||k.each(e,function(a){o.info.isEnabled&&o.info('Installing reverse relationships for mapping with name "'+a.name+'"');var b=a.installReverseRelationships();b&&d.push(b)}),1==d.length?a=d[0]:d.length&&(a=d),c._finaliseInstallation(a,b.finish.bind(b))}})}else c._finaliseInstallation(null,b.finish.bind(b))}return b.promise},_finaliseInstallation:function(b,c){if(b&&(b=m("Errors were encountered whilst setting up the collection",{errors:b})),!b){this.installed=!0;var d=a("./index");d[this.name]=this}c(b)},_model:function(a,b){if(a){this._rawModels[a]=b,b=h(!0,{},b),b.name=a,b.collection=this;var c=new g(b);return this._models[a]=c,this[a]=c,c}throw new Error("No name specified when creating mapping")},model:function(){var a=!this.installed;if(!a)throw Error("Cannot create new models once the object graph is established!");var b=this;return arguments.length?1==arguments.length?j.isArray(arguments[0])?k.map(arguments[0],function(a){return b._model(a.name,a)}):this._model(arguments[0].name,arguments[0]):"string"==typeof arguments[0]?this._model(arguments[0],arguments[1]):k.map(arguments,function(a){return b._model(a.name,a)}):null},descriptor:function(a){var b=[];if(!siesta.ext.httpEnabled)throw new Error("HTTP module not installed.");a.collection=this;for(var c=siesta.ext.http._resolveMethod(a.method),d=[],e=[],f=0;f<c.length;f++){var g=c[f];n.indexOf(g)>-1?d.push(g):e.push(g)}if(d.length){var i=h({},a);i.method=d,i=new siesta.ext.http.RequestDescriptor(i),siesta.ext.http.DescriptorRegistry.registerRequestDescriptor(i),b.push(i)}if(e.length){var j=h({},a);j.method=e,j=new siesta.ext.http.ResponseDescriptor(j),siesta.ext.http.DescriptorRegistry.registerResponseDescriptor(j),b.push(j)}return b},_dump:function(a){var b={};return b.installed=this.installed,b.docId=this._docId,b.name=this.name,b.baseURL=this.baseURL,a?j.prettyPrint(b):b},count:function(a){var b=j.defer(a),c=k.map(this._models,function(a){return k.bind(a.count,a)});return j.async.parallel(c,function(a,c){var d;a||(d=k.reduce(c,function(a,b){return a+b},0)),b.finish(a,d)}),b.promise}}),k.extend(c.prototype,{listen:function(a){return i.on(this.name,a),function(){this.removeListener(a)}.bind(this)},listenOnce:function(a){return i.once(this.name,a)},removeListener:function(a){return i.removeListener(this.name,a)}}),b.exports=c},{"../vendor/observe-js/src/observe":31,"./cache":8,"./collectionRegistry":10,"./error":11,"./events":12,"./index":13,"./log":14,"./model":17,"./util":25,extend:30}],10:[function(a,b,c){function d(){return this?void(this.collectionNames=[]):new d}var e=a("./util")._;e.extend(d.prototype,{register:function(a){var b=a.name;this[b]=a,this.collectionNames.push(b)},reset:function(){var a=this;e.each(this.collectionNames,function(b){delete a[b]}),this.collectionNames=[]}}),c.CollectionRegistry=new d},{"./util":25}],11:[function(a,b){function c(a,b,c){this.message=a,this.context=b,c=c||arguments.callee,c&&Error.captureStackTrace&&Error.captureStackTrace(this,c)}function d(a,b,c){c=c||{},this.component=a,this.message=b;for(var d in c)c.hasOwnProperty(d)&&(this[d]=c[d]);this.isUserError=!0}c.prototype=Object.create(Error.prototype),c.prototype.name="InternalSiestaError",c.prototype.constructor=c;var e={Message:"message",Code:"code"},f={Unknown:0,NoDescriptorMatched:1},g={Mapping:"Mapping",HTTP:"HTTP",ReactiveQuery:"ReactiveQuery",ArrangedReactiveQuery:"ArrangedReactiveQuery",Collection:"Collection",Query:"Query"},h={};h[f.NoDescriptorMatched]="No descriptor matched the HTTP response/request.",b.exports={InternalSiestaError:c,SiestaUserError:d,ErrorCode:f,ErrorField:e,Message:h,Components:g,errorFactory:function(a){if(a in g)return function(b,d){return new c(a,b,d)};throw new c('No such component "'+a+'"')}}},{}],12:[function(a,b){var c=a("events").EventEmitter,d=a("../vendor/observe-js/src/observe").ArrayObserver,e=(a("./util")._,a("./modelEvents")),f=new c;f.wrapArray=function(a,b,c){a.observer||(a.observer=new d(a),a.observer.open(function(d){var f=c._attributeNames.indexOf(b)>-1;f&&d.forEach(function(d){e.emit({collection:c.collectionName,model:c.model.name,_id:c._id,index:d.index,removed:d.removed,added:d.addedCount?a.slice(d.index,d.index+d.addedCount):[],type:e.ModelEventType.Splice,field:b,obj:c})})}))},b.exports=f},{"../vendor/observe-js/src/observe":31,"./modelEvents":18,"./util":25,events:29}],13:[function(a,b){var c=a("./util"),d=a("./collectionRegistry").CollectionRegistry,e=a("./collection"),f=a("./cache"),g=a("./model"),h=a("./events"),i=a("./RelationshipType"),j=a("./reactiveQuery"),k=a("./modelEvents"),l=a("./Query"),m=a("./log"),n=c._;window.Q&&(window.q=window.Q);var o=function(a){return o.ext||(o.ext={}),n.extend(o.ext,a||{}),o};n.extend(o,{on:h.on.bind(h),off:h.removeListener.bind(h),once:h.once.bind(h),removeAllListeners:h.removeAllListeners.bind(h)}),n.extend(o,{removeListener:o.off,addListener:o.on}),n.extend(o,{RelationshipType:i,ModelEventType:k.ModelEventType,log:m.Level,InsertionPolicy:j.InsertionPolicy,_internal:{log:m,Model:g,model:a("./model"),error:a("./error"),ModelEventType:k.ModelEventType,siestaModel:a("./modelInstance"),extend:a("extend"),events:a("./events"),cache:a("./cache"),modelEvents:k,CollectionRegistry:a("./collectionRegistry").CollectionRegistry,Collection:e,utils:c,util:c,_:c._,query:a("./query"),store:a("./store")},_:c._,async:c.async,isArray:c.isArray,isString:c.isString}),o.ext={};var p=!1,q=!1;n.extend(o,{reset:function(a){p=!1,q=!1,delete this.queuedTasks,f.reset(),d.reset(),h.removeAllListeners(),o.ext.http.DescriptorRegistry.reset(),o.ext.storageEnabled?o.ext.storage._reset(a):a()},collection:function(a,b){return new e(a,b)},install:function(a){q=!0;var b=c.defer(a);a=b.finish.bind(b);var e=d.collectionNames,f=n.map(e,function(a){return function(b){d[a].install(b)}}),g=this;return o.async.series(f,function(b){if(b)q=!1,a(b);else{var c=function(b){if(b)q=!1,a(b);else{for(var c=[],f=0;f<e.length;f++)for(var h=d[e[f]],i=Object.keys(h._models),j=0;j<i.length;j++){var k=i[j],l=h[k],m=function(a){this.ensureSingletons(a)}.bind(l);c.push(m)}o.async.parallel(c,function(b,c){b||(p=!0,g.queuedTasks&&g.queuedTasks.execute()),q=!1,a(b,c)})}};o.ext.storageEnabled?o.ext.storage._load(c):c()}}),b.promise},_pushTask:function(a){this.queuedTasks||(this.queuedTasks=new function(){this.tasks=[],this.execute=function(){this.tasks.forEach(function(a){a()}),this.tasks=[]}.bind(this)}),this.queuedTasks.tasks.push(a)},_afterInstall:function(a){p?a():(q||this.install(function(a){a&&console.error("Error setting up siesta",a),delete this.queuedTasks}.bind(this)),p?a():this._pushTask(a))},setLogLevel:function(a,b){var c=m.loggerWithName(a);c.setLevel(b)},notify:c.next,registerComparator:l.bind(l)}),Object.defineProperties(o,{_canChange:{get:function(){return!(q||p)}}}),"undefined"!=typeof window&&(window.siesta=o),b.exports=o},{"./Query":5,"./RelationshipType":7,"./cache":8,"./collection":9,"./collectionRegistry":10,"./error":11,"./events":12,"./log":14,"./model":17,"./modelEvents":18,"./modelInstance":19,"./query":20,"./reactiveQuery":22,"./store":23,"./util":25,extend:30}],14:[function(a,b){function c(a){return this?(this.name=a,f[a]=c.Level.warn,this.trace=d(this,e.bind(console.debug?console.debug:console.log,console),c.Level.trace),this.debug=d(this,e.bind(console.debug?console.debug:console.log,console),c.Level.debug),this.info=d(this,e.bind(console.info?console.info:console.log,console),c.Level.info),this.log=d(this,e.bind(console.log?console.log:console.log,console),c.Level.info),this.warn=d(this,e.bind(console.warn?console.warn:console.log,console),c.Level.warning),this.error=d(this,e.bind(console.error?console.error:console.log,console),c.Level.error),void(this.fatal=d(this,e.bind(console.error?console.error:console.log,console),c.Level.fatal))):new c(a)}function d(a,b,c){var d=function(d){a.performLog(b,c,d,arguments)};return Object.defineProperty(d,"isEnabled",{get:function(){var b=a.currentLevel();return c>=b},enumerable:!0,configurable:!0}),d.f=b,d.logger=a,d.level=c,d}var e=a("./util")._,f={};c.Level={trace:0,debug:1,info:2,warning:3,warn:3,error:4,fatal:5},c.LevelText={},c.LevelText[c.Level.trace]="TRACE",c.LevelText[c.Level.debug]="DEBUG",c.LevelText[c.Level.info]="INFO ",c.LevelText[c.Level.warning]="WARN ",c.LevelText[c.Level.error]="ERROR",c.levelAsText=function(a){return this.LevelText[a]},c.loggerWithName=function(a){return new c(a)},c.prototype.currentLevel=function(){var a=f[this.name];return a?a:c.Level.trace},c.prototype.setLevel=function(a){f[this.name]=a},c.prototype.override=function(a,b,d){var e=c.levelAsText(a),f=this[e.trim().toLowerCase()],g=f.f,h=Array.prototype.slice.call(arguments,3,arguments.length);this.performLog(g,a,d,h,b)},c.prototype.performLog=function(a,b,d,f,g){var h=this,i=void 0!==g?g:this.currentLevel();if(b>=i){a=e.partial(a,c.levelAsText(b)+" ["+h.name+"]: "+d);for(var j=[],k=0;k<f.length;k++)j[k]=f[k];j.splice(0,1),a.apply(a,j)}},b.exports=c},{"./util":25}],15:[function(a,b){function c(a){d.call(this,a),this.related=[],this.relatedCancelListeners={}}var d=a("./RelationshipProxy"),e=(a("./store"),a("./util")),f=e._,g=(a("./error").InternalSiestaError,a("./modelEvents")),h=a("./events"),i=h.wrapArray,j=(a("./modelInstance"),a("../vendor/observe-js/src/observe").ArrayObserver),k=a("./modelEvents").ModelEventType;c.prototype=Object.create(d.prototype),f.extend(c.prototype,{clearReverse:function(a){var b=this;f.each(a,function(a){var c=b.reverseProxyForInstance(a),d=c.related.indexOf(b.object);c.makeChangesToRelatedWithoutObservations(function(){c.splice(d,1)})})},setReverseOfAdded:function(a){var b=this;f.each(a,function(a){var c=b.reverseProxyForInstance(a);c.makeChangesToRelatedWithoutObservations(function(){c.splice(0,0,b.object)})})},wrapArray:function(a){var b=this;if(i(a,this.reverseName,this.object),!a.arrayObserver){a.arrayObserver=new j(a);var c=function(c){c.forEach(function(c){var d=c.addedCount?a.slice(c.index,c.index+c.addedCount):[],e=c.removed;
b.clearReverse(e),b.setReverseOfAdded(d);var f=b.getForwardModel();g.emit({collection:f.collectionName,model:f.name,_id:b.object._id,field:b.getForwardName(),removed:e,added:d,type:k.Splice,index:c.index,obj:b.object})})};a.arrayObserver.open(c)}},get:function(a){var b=e.defer(a);return a=b.finish.bind(b),a(null,this.related),b.promise},validate:function(a){return"[object Array]"!=Object.prototype.toString.call(a)?"Cannot assign scalar to many to many":null},set:function(a,b){this.checkInstalled();var c=this;if(a){var d;if(d=this.validate(a))return d;this.clearReverseRelated(b),c.setIdAndRelated(a,b),this.wrapArray(a),c.setIdAndRelatedReverse(a,b)}else this.clearReverseRelated(b),c.setIdAndRelated(a,b)},install:function(a){d.prototype.install.call(this,a),this.wrapArray(this.related),a["splice"+e.capitaliseFirstLetter(this.reverseName)]=f.bind(this.splice,this)},registerRemovalListener:function(a){this.relatedCancelListeners[a._id]=a.listen(function(){}.bind(this))}}),b.exports=c},{"../vendor/observe-js/src/observe":31,"./RelationshipProxy":6,"./error":11,"./events":12,"./modelEvents":18,"./modelInstance":19,"./store":23,"./util":25}],16:[function(a,b){function c(a){this.opts=a}function d(a){this._opts=a,i.extendFromOpts(this,a,{model:null,data:null,objects:[],disableevents:!1,_ignoreInstalled:!1}),j.extend(this,{errors:[],subTaskResults:{},_newObjects:[]})}var e=a("./store"),f=a("./modelInstance"),g=a("./log"),h=(a("./error").InternalSiestaError,a("./query"),a("./cache")),i=a("./util"),j=i._,k=i.async,l=(a("./modelEvents").ModelEventType,g.loggerWithName("Mapping"));c.prototype.toString=function(){return JSON.stringify(this.opts,null,4)},j.extend(d.prototype,{mapAttributes:function(){for(var a=0;a<this.data.length;a++){var b=this.data[a],c=this.objects[a];if(b!=c&&c){var d=this.model._attributeNames;j.each(d,function(a){void 0!==b[a]&&(this.disableevents?c.__values[a]=b[a]:c[a]=b[a])}.bind(this)),b._rev&&(c._rev=b._rev)}}},_map:function(){var a,b=this;this.mapAttributes();var c=j.keys(b.subTaskResults);j.each(c,function(c){for(var d=b.subTaskResults[c],e=d.indexes,f=d.objects,g=b.getRelatedData(c).relatedData,h=i.unflattenArray(f,g),j=0;j<h.length;j++){var k=e[j],l=b.errors[k];if(a=l?l[c]:null,!a){var m=h[j],n=b.objects[k];n&&(a=n.__proxies[c].set(m,{disableevents:b.disableevents}),a&&(b.errors[k]||(b.errors[k]={}),b.errors[k][c]=a))}}})},_lookup:function(a){var b=i.defer(a);a=b.finish.bind(b);for(var c=this,d=[],g=[],k=0;k<this.data.length;k++)if(!this.objects[k]){var m,n=this.data[k],o="string"==typeof n||"number"==typeof n||n instanceof String;if(n)if(o)m={index:k,datum:{}},m.datum[c.model.id]=n,d.push(m);else if(n instanceof f)this.objects[k]=n;else if(n._id)g.push({index:k,datum:n});else if(n[c.model.id])d.push({index:k,datum:n});else{for(var p=Object.keys(n),q=j.reduce(Object.keys(c.model.relationships).concat(c.model._attributeNames),function(a,b){return a[b]={},a},{}),r=!1,s=0;s<p.length;s++)if(q[p[s]]){r=!0;break}r&&(this.objects[k]=c._new())}else this.objects[k]=null}return i.async.parallel([function(a){var b=j.pluck(j.pluck(g,"datum"),"_id");b.length?e.getMultipleLocal(b,function(d,e){if(!d)for(var f=0;f<b.length;f++){var i=e[f],j=b[f],k=g[f];i?c.objects[k.index]=i:(i=h.get({_id:j}),i||(i=c._new({_id:j},!c.disableevents)),c.objects[k.index]=i)}a(d)}):a()},function(a){var b=j.pluck(j.pluck(d,"datum"),c.model.id);b.length?(l.trace.isEnabled&&l.trace("Looking up remoteIdentifiers: "+i.prettyPrint(b)),e.getMultipleRemote(b,c.model,function(e,f){if(!e){if(l.trace.isEnabled){var g={};for(k=0;k<f.length;k++)g[b[k]]=f[k]?f[k]._id:null;l.trace("Results for remoteIdentifiers: "+i.prettyPrint(g))}for(k=0;k<f.length;k++){var j=f[k],m=d[k];if(j)c.objects[m.index]=j;else{var n={},o=b[k];n[c.model.id]=o;var p={model:c.model};p[c.model.id]=o;var q=h.get(p);q?c.objects[m.index]=q:(c.objects[m.index]=c._new(),c.objects[m.index][c.model.id]=o)}}}a(e)})):a()}],a),b.promise},_lookupSingleton:function(a){var b=i.defer(a);a=b.finish.bind(b);var c=this;return this.model.one({__ignoreInstalled:this._ignoreInstalled},function(b,d){var e,f=j.pluck(c.data,"_id");for(g=0;g<f.length;g++)if(f[g]){e={_id:f[g]};break}if(d||(d=c._new(e)),!b)for(var g=0;g<c.data.length;g++)c.objects[g]=d;a(b)}),b.promise},_new:function(){var a=this.model,b=a._new.apply(a,arguments);return this._newObjects.push(b),b},start:function(a){if(this.data.length){var b=this,c=[],d=this.model.singleton?this._lookupSingleton:this._lookup;c.push(j.bind(d,this)),c.push(j.bind(this._executeSubOperations,this)),i.async.parallel(c,function(){b._map();var c=j.reduce(b._newObjects,function(b,c){var d=c.model.init;if(d){var e=i.paramNames(d);e.length?b.push(j.bind(d,c,a)):d.call(c)}return b},[]);k.parallel(c,function(){a(b.errors.length?b.errors:null,b.objects)})})}else a(null,[])},getRelatedData:function(a){for(var b=[],c=[],d=0;d<this.data.length;d++){var e=this.data[d];e&&e[a]&&(b.push(d),c.push(e[a]))}return{indexes:b,relatedData:c}},processErrorsFromTask:function(a,b,c){if(b.length)for(var d=this.getRelatedData(a).relatedData,e=i.unflattenArray(b,d),f=0;f<e.length;f++){var g=c[f],h=e[f],k=h;i.isArray(h)&&(k=j.reduce(h,function(a,b){return a||b},!1)),k&&(this.errors[g]||(this.errors[g]={}),this.errors[g][a]=h)}},_executeSubOperations:function(a){var b=this,c=j.keys(this.model.relationships);if(c.length){var e=j.reduce(c,function(a,c){var e=b.model.relationships[c],f=e.forwardName==c?e.reverseModel:e.forwardModel,g=this.getRelatedData(c),h=g.indexes,j=g.relatedData;if(j.length)var k=i.flattenArray(j),l=new d({model:f,data:k,disableevents:b.disableevents,_ignoreInstalled:b._ignoreInstalled});if(l){var m;m=function(a){l.start(function(d,e){b.subTaskResults[c]={errors:d,objects:e,indexes:h},b.processErrorsFromTask(c,l.errors,h),a()})},a.push(m)}return a}.bind(this),[]);k.parallel(e,function(){a()})}else a()}}),b.exports=d},{"./cache":8,"./error":11,"./log":14,"./modelEvents":18,"./modelInstance":19,"./query":20,"./store":23,"./util":25}],17:[function(a,b){function c(a){var b=this;this._opts=a?v.extend({},a):{},k.extendFromOpts(this,a,{methods:{},attributes:[],collection:function(a){return k.isString(a)&&(a=e[a]),a},id:"id",relationships:[],name:null,indexes:[],singleton:!1,statics:this.installStatics.bind(this),properties:{},init:null,remove:null}),this.attributes=c._processAttributes(this.attributes),v.extend(this,{_installed:!1,_relationshipsInstalled:!1,_reverseRelationshipsInstalled:!1,children:[]}),Object.defineProperties(this,{_relationshipNames:{get:function(){return Object.keys(b.relationships)},enumerable:!0},_attributeNames:{get:function(){var a=[];return b.id&&a.push(b.id),v.each(b.attributes,function(b){a.push(b.name)}),a},enumerable:!0,configurable:!0},installed:{get:function(){return b._installed&&b._relationshipsInstalled&&b._reverseRelationshipsInstalled},enumerable:!0,configurable:!0},descendants:{get:function(){return v.reduce(b.children,function(a,b){return Array.prototype.concat.call(a,b.descendants)}.bind(b),v.extend([],b.children))},enumerable:!0},dirty:{get:function(){if(siesta.ext.storageEnabled){var a=siesta.ext.storage._unsavedObjectsByCollection,b=(a[this.collectionName]||{})[this.name]||{};return!!Object.keys(b).length}return void 0},enumerable:!0},collectionName:{get:function(){return this.collection.name},enumerable:!0}})}var d=a("./log"),e=a("./collectionRegistry").CollectionRegistry,f=a("./error").InternalSiestaError,g=a("./RelationshipType"),h=a("./query"),i=a("./mappingOperation"),j=a("./modelInstance"),k=a("./util"),l=a("./cache"),m=(a("./store"),a("extend")),n=a("./modelEvents"),o=a("./events"),p=a("./events").wrapArray,q=(a("./RelationshipProxy"),a("./OneToManyProxy")),r=a("./OneToOneProxy"),s=a("./manyToManyProxy"),t=a("./reactiveQuery"),u=a("./ArrangedReactiveQuery"),v=k._,w=k.guid,x=n.ModelEventType,y=d.loggerWithName("Model");v.extend(c,{_processAttributes:function(a){return v.reduce(a,function(a,b){return a.push("string"==typeof b?{name:b}:b),a},[])}}),v.extend(c.prototype,{installStatics:function(a){return a&&v.each(Object.keys(a),function(b){this[b]?y.error('Static method with name "'+b+'" already exists. Ignoring it.'):this[b]=a[b].bind(this)}.bind(this)),a},installRelationships:function(){if(this._relationshipsInstalled)throw new f('Relationships for "'+this.name+'" have already been installed');var a=this;if(a._relationships=[],a._opts.relationships)for(var b in a._opts.relationships)if(a._opts.relationships.hasOwnProperty(b)){var d=a._opts.relationships[b];if(!d.isReverse){if(y.debug.isEnabled&&y.debug(a.name+": configuring relationship "+b,d),d.type||(d.type=a.singleton?g.OneToOne:g.OneToMany),d.type!=g.OneToMany&&d.type!=g.OneToOne&&d.type!=g.ManyToMany)return"Relationship type "+d.type+" does not exist";var h=d.model;delete d.model;var i;if(h instanceof c)i=h;else{if(y.debug.isEnabled&&y.debug("reverseModelName",h),!a.collection)throw new f("Model must have collection");var j=a.collection;if(!j)throw new f("Collection "+a.collectionName+" not registered");i=j[h]}if(!i){var k=h.split(".");if(2==k.length){var l=k[0];h=k[1];var m=e[l];if(!m)return'Collection with name "'+l+'" does not exist.';i=m[h]}}if(y.debug.isEnabled&&y.debug("reverseModel",i),!i)return'Model with name "'+h.toString()+'" does not exist';d.reverseModel=i,d.forwardModel=this,d.forwardName=b,d.reverseName=d.reverse||"reverse_"+b,delete d.reverse,d.isReverse=!1}}return this._relationshipsInstalled=!0,null},installReverseRelationships:function(){if(this._reverseRelationshipsInstalled)throw new f('Reverse relationships for "'+this.name+'" have already been installed.');for(var a in this.relationships)if(this.relationships.hasOwnProperty(a)){var b=this.relationships[a];b=m(!0,{},b),b.isReverse=!0;var c=b.reverseModel,d=b.reverseName;y.debug.isEnabled&&y.debug(this.name+": configuring  reverse relationship "+d),c.relationships[d]=b}this._reverseRelationshipsInstalled=!0},ensureSingletons:function(a){this.singleton?this.one({__ignoreInstalled:!0},function(b,c){if(b)a(b);else if(c)y.trace&&y.trace('Singleton already exists for mapping "'+this.name+'"',c),a(null,c);else{var d={},e=this.relationships;d=v.reduce(Object.keys(e),function(a,b){var c=e[b];return c.isReverse&&(d[c.reverseName]={}),d},d),this.map(d,{_ignoreInstalled:!0},function(b,c){y.trace&&y.trace('Ensured singleton mapping "'+this.name+'"',c),a(b,c)}.bind(this))}}.bind(this)):a()},finaliseInstallation:function(a){this.singleton?this.ensureSingletons(a):a()},_query:function(a){var a=new h(this,a||{});return a},query:function(a,b){return this._query(a).execute(b)},reactiveQuery:function(a){return new t(new h(this,a||{}))},arrangedReactiveQuery:function(a){return new u(new h(this,a||{}))},one:function(a,b){a=a||{},"function"==typeof a&&(b=a,a={});var c=this._query(a);return function(a){var b=k.defer(a);return a=b.finish.bind(b),this._executeInMemory(function(b,c){b?a(b):c.length>1?a("More than one instance returned when executing get query!"):a(null,c.length?c[0]:null)}),b.promise}.call(c,b)},all:function(a,b){"function"==typeof a&&(b=a,a={}),a=a||{};var c={};return a.__order&&(c.__order=a.__order),new h(this,c).execute(b)},install:function(a){y.info.isEnabled&&y.info("Installing mapping "+this.name);var b=k.defer(a);if(a=b.finish.bind(b),this._installed)throw new f('Model "'+this.name+'" has already been installed');return this._installed=!0,a(),b.promise},map:function(a,b,c){"function"==typeof b&&(c=b),b=b||{};var d=k.defer(c),e=function(){var c=b.override;c&&(b.objects=k.isArray(c)?c:[c]),delete b.override,k.isArray(a)?this._mapBulk(a,b,d.finish.bind(d)):this._mapBulk([a],b,function(a,b){var c;b&&b.length&&(c=b[0]),d.finish(a?a[0]:null,c)})}.bind(this);return b._ignoreInstalled?e():siesta._afterInstall(e),d.promise},_mapBulk:function(a,b,c){v.extend(b,{model:this,data:a});var d=new i(b);d.start(function(a,b){a?c&&c(a):c(null,b)})},_countCache:function(){var a=l._localCacheByType[this.collectionName]||{},b=a[this.name]||{};return v.reduce(Object.keys(b),function(a,b){return a[b]={},a},{})},count:function(a){var b=k.defer(a);a=b.finish.bind(b);var c=this._countCache();return a(null,Object.keys(c).length),b.promise},_new:function(a,b){if(b=void 0===b?!0:b,this.installed){var c,d=this;c=a&&a._id?a._id:w();var e=new j(this);y.info.isEnabled&&y.info('New object created _id="'+c.toString()+'", type='+this.name,a),e._id=c;var h={};e.__values=h;var i=v.reduce(this.attributes,function(a,b){return void 0!==b.default&&(a[b.name]=b.default),a},{});v.extend(h,i),a&&v.extend(h,a);var m=this._attributeNames,o=m.indexOf(this.id);o>-1&&m.splice(o,1),v.each(m,function(a){Object.defineProperty(e,a,{get:function(){var b=e.__values[a];return void 0===b?null:b},set:function(b){var c=e.__values[a];e.__values[a]=b,n.emit({collection:d.collectionName,model:d.name,_id:e._id,"new":b,old:c,type:x.Set,field:a,obj:e}),k.isArray(b)&&p(b,a,e)},enumerable:!0,configurable:!0})}),v.each(Object.keys(this.methods),function(a){void 0===e[a]?e[a]=this.methods[a].bind(e):y.error('A method with name "'+a+'" already exists. Ignoring it.')}.bind(this)),v.each(Object.keys(this.properties),function(a){void 0===e[a]?Object.defineProperty(e,a,this.properties[a]):y.error('A property/method with name "'+a+'" already exists. Ignoring it.')}.bind(this)),Object.defineProperty(e,this.id,{get:function(){return e.__values[d.id]||null},set:function(a){var b=e[d.id];e.__values[d.id]=a,n.emit({collection:d.collectionName,model:d.name,_id:e._id,"new":a,old:b,type:x.Set,field:d.id,obj:e}),l.remoteInsert(e,a,b)},enumerable:!0,configurable:!0});for(var t in this.relationships){var u;if(this.relationships.hasOwnProperty(t)){var z=v.extend({},this.relationships[t]),A=z.type;if(delete z.type,A==g.OneToMany)u=new q(z);else if(A==g.OneToOne)u=new r(z);else{if(A!=g.ManyToMany)throw new f("No such relationship type: "+A);u=new s(z)}}u.install(e)}return l.insert(e),b&&n.emit({collection:this.collectionName,model:this.name,_id:e._id,"new":e,type:x.New,obj:e}),e}throw new f("Model must be fully installed before creating any models")},_dump:function(a){var b={};return b.name=this.name,b.attributes=this.attributes,b.id=this.id,b.collection=this.collectionName,b.relationships=v.map(this.relationships,function(a){return a.isForward?a.forwardName:a.reverseName}),a?k.prettyPrint(b):b},toString:function(){return"Model["+this.name+"]"}}),v.extend(c.prototype,{listen:function(a){return o.on(this.collectionName+":"+this.name,a),function(){this.removeListener(a)}.bind(this)},listenOnce:function(a){return o.once(this.collectionName+":"+this.name,a)},removeListener:function(a){return o.removeListener(this.collectionName+":"+this.name,a)}}),v.extend(c.prototype,{child:function(a,b){"string"==typeof a?b.name=a:b=name,v.extend(b,{attributes:Array.prototype.concat.call(b.attributes||[],this._opts.attributes),relationships:v.extend(b.relationships||{},this._opts.relationships),methods:v.extend(v.extend({},this._opts.methods)||{},b.methods),statics:v.extend(v.extend({},this._opts.statics)||{},b.statics),properties:v.extend(v.extend({},this._opts.properties)||{},b.properties),id:b.id||this._opts.id,init:b.init||this._opts.init,remove:b.remove||this._opts.remove});var c=this.collection.model(b.name,b);return c.parent=this,this.children.push(c),c},isChildOf:function(a){return this.parent==a},isParentOf:function(a){return this.children.indexOf(a)>-1},isDescendantOf:function(a){for(var b=this.parent;b;){if(b==a)return!0;b=b.parent}return!1},isAncestorOf:function(a){return this.descendants.indexOf(a)>-1},hasAttributeNamed:function(a){return this._attributeNames.indexOf(a)>-1}}),v.extend(c.prototype,{paginator:function(a){if(siesta.ext.httpEnabled){var b=siesta.ext.http.Paginator;return a=a||{},a.model=this,new b(a)}}}),b.exports=c},{"./ArrangedReactiveQuery":1,"./OneToManyProxy":3,"./OneToOneProxy":4,"./RelationshipProxy":6,"./RelationshipType":7,"./cache":8,"./collectionRegistry":10,"./error":11,"./events":12,"./log":14,"./manyToManyProxy":15,"./mappingOperation":16,"./modelEvents":18,"./modelInstance":19,"./query":20,"./reactiveQuery":22,"./store":23,"./util":25,extend:30}],18:[function(a,b,c){function d(a){this._opts=a||{},o.forEach(function(a){void 0!==this._opts[a]&&(this[a]=this._opts[a])}.bind(this))}function e(a,b,c){m.trace.isEnabled&&m.trace('Sending notification "'+a+'" of type '+c.type),h.emit(a,c);var d=a+":"+b;m.trace.isEnabled&&m.trace('Sending notification "'+d+'" of type '+c.type),h.emit(d,c);var e="Siesta";m.trace.isEnabled&&m.trace('Sending notification "'+e+'" of type '+c.type),h.emit(e,c);var f=c._id;m.trace.isEnabled&&m.trace('Sending notification "'+f+'" of type '+c.type),h.emit(f,c);var g,j=l[a];if(!j)throw g='No such collection "'+a+'"',m.error(g,l),new i(g);var k=j[b];if(!k)throw g='No such model "'+b+'"',m.error(g,l),new i(g);if(k.id&&c.obj[k.id]){var n=a+":"+b+":"+c.obj[k.id];m.trace.isEnabled&&m.trace('Sending notification "'+n+'" of type '+c.type),h.emit(n,c)}}function f(a){if(!a.model)throw new i("Must pass a model");if(!a.collection)throw new i("Must pass a collection");if(!a._id)throw new i("Must pass a local identifier");if(!a.obj)throw new i("Must pass the object")}function g(a){f(a);var b=a.collection,c=a.model,g=new d(a);return e(b,c,g),g}var h=a("./events"),i=a("./error").InternalSiestaError,j=a("./log"),k=a("./util")._.extend,l=a("./collectionRegistry").CollectionRegistry,m=j.loggerWithName("ModelEvents"),n={Set:"Set",Splice:"Splice",New:"New",Remove:"Remove"},o=["collection","model","_id","field","type","index","added","removed","new","old","obj"];d.prototype._dump=function(a){var b={};return b.collection="string"==typeof this.collection?this.collection:this.collection._dump(),b.model="string"==typeof this.model?this.model:this.model.name,b._id=this._id,b.field=this.field,b.type=this.type,this.index&&(b.index=this.index),this.added&&(b.added=_.map(this.added,function(a){return a._dump()})),this.removed&&(b.removed=_.map(this.removed,function(a){return a._dump()})),this.old&&(b.old=this.old),this.new&&(b.new=this.new),a?util.prettyPrint(b):b},k(c,{ModelEvent:d,emit:g,validateEventOpts:f,ModelEventType:n})},{"./collectionRegistry":10,"./error":11,"./events":12,"./log":14,"./util":25}],19:[function(a,b){b.exports=a(2)},{"./cache":8,"./error":11,"./events":12,"./log":14,"./modelEvents":18,"./util":25,"/Users/mtford/Playground/rest/core/ModelInstance.js":2}],20:[function(a,b){b.exports=a(5)},{"./cache":8,"./error":11,"./log":14,"./querySet":21,"./util":25,"/Users/mtford/Playground/rest/core/Query.js":5}],21:[function(a,b){function c(a){var b;return b="string"==typeof a||a instanceof String?r.concat(s):"number"==typeof a||a instanceof Number?p.concat(q):a.getOwnPropertyNames()}function d(a,b){b in a||Object.defineProperty(a,b,{get:function(){return h(n.pluck(a,b))},set:function(a){if(k.isArray(a)){if(this.length!=a.length)throw new l({message:"Must be same length"});for(var c=0;c<a.length;c++)this[c][b]=a[c]}else for(c=0;c<this.length;c++)this[c][b]=a}})}function e(a){return a.then&&a.catch}function f(a,b){b in a||(a[b]=function(){var a=arguments,c=this.map(function(c){return c[b].apply(c,a)}),d=!1;return c.length&&(d=e(c[0])),d?window.Q.all(c):h(c)})}function g(a,b){a=n.extend([],a);var c=b._attributeNames,e=b._relationshipNames,g=c.concat(e).concat(h);g.forEach(n.partial(d,a));var h=Object.keys(m.prototype);return h.forEach(n.partial(f,a)),j(a)}function h(a){if(a.length){var b=a[0],e=c(b);e.forEach(function(c){"function"==typeof b[c]?f(a,c,arguments):d(a,c)})}return j(a)}function i(){throw new Error("Cannot modify a query set")}function j(a){return o.forEach(function(b){a[b]=i}),a.immutable=!0,a.mutableCopy=a.asArray=function(){var a=n.map(this,function(a){return a});return a.asQuerySet=function(){return h(this)},a.asModelQuerySet=function(a){return g(this,a)},a},a}var k=a("./util"),l=a("./error").SiestaUserError,m=a("./ModelInstance"),n=a("./util")._,o=["push","sort","reverse","splice","shift","unshift"],p=["toString","toExponential","toFixed","toPrecision","valueOf"],q=["MAX_VALUE","MIN_VALUE","NEGATIVE_INFINITY","NaN","POSITIVE_INFINITY"],r=["charAt","charCodeAt","concat","fromCharCode","indexOf","lastIndexOf","localeCompare","match","replace","search","slice","split","substr","substring","toLocaleLowerCase","toLocaleUpperCase","toLowerCase","toString","toUpperCase","trim","valueOf"],s=["length"];b.exports=g},{"./ModelInstance":2,"./error":11,"./util":25}],22:[function(a,b){function c(a){var b=this;e.call(this),k.extend(this,{_query:a,results:i([],a.model),insertionPolicy:c.InsertionPolicy.Back,initialised:!1}),Object.defineProperties(this,{initialized:{get:function(){return this.initialised}},model:{get:function(){return b._query.model}},collection:{get:function(){return b.model.collectionName}}})}var d=a("./log"),e=(a("./query"),a("events").EventEmitter),f=a("./events"),g=a("./modelEvents"),h=a("./error").InternalSiestaError,i=a("./querySet"),j=a("./util"),k=j._,l=d.loggerWithName("Query");c.prototype=Object.create(e.prototype),k.extend(c,{InsertionPolicy:{Front:"Front",Back:"Back"}}),k.extend(c.prototype,{init:function(a){l.trace&&l.trace("init");var b=j.defer(a);return a=b.finish.bind(b),this.initialised?a(null,this.results):this._query.execute(function(b,c){if(b)a(b);else{if(this.results=c,!this.handler){var d=this._constructNotificationName(),e=function(a){this._handleNotif(a)}.bind(this);this.handler=e,f.on(d,e)}l.trace&&l.trace("Listening to "+d),this.initialised=!0,a(null,this.results)}}.bind(this)),b.promise},insert:function(a){var b=this.results.mutableCopy();if(this.insertionPolicy==c.InsertionPolicy.Back)var d=b.push(a);else d=b.unshift(a);return this.results=b.asModelQuerySet(this.model),d},_handleNotif:function(a){if(l.trace&&l.trace("_handleNotif",a),a.type==g.ModelEventType.New){var b=a.new;if(this._query.objectMatchesQuery(b)){l.trace&&l.trace("New object matches",b._dumpString());var c=this.insert(b);this.emit("change",this.results,{index:c,added:[b],type:g.ModelEventType.Splice,obj:this})}else l.trace&&l.trace("New object does not match",b._dumpString())}else if(a.type==g.ModelEventType.Set){b=a.obj;var d=this.results.indexOf(b),e=d>-1,f=this._query.objectMatchesQuery(b);if(f&&!e)l.trace&&l.trace("Updated object now matches!",b._dumpString()),c=this.insert(b),this.emit("change",this.results,{index:c,added:[b],type:g.ModelEventType.Splice,obj:this});else if(!f&&e){l.trace&&l.trace("Updated object no longer matches!",b._dumpString()),k=this.results.mutableCopy();var j=k.splice(d,1);this.results=k.asModelQuerySet(this.model),this.emit("change",this.results,{index:d,obj:this,"new":b,type:g.ModelEventType.Splice,removed:j})}else f||e?f&&e&&(l.trace&&l.trace("Matches but already contains",b._dumpString()),this.emit("change",this.results,a)):l.trace&&l.trace("Does not contain, but doesnt match so not inserting",b._dumpString())}else{if(a.type!=g.ModelEventType.Remove)throw new h('Unknown change type "'+a.type.toString()+'"');b=a.obj;var k=this.results.mutableCopy();d=k.indexOf(b),d>-1?(l.trace&&l.trace("Removing object",b._dumpString()),j=k.splice(d,1),this.results=i(k,this.model),this.emit("change",this.results,{index:d,obj:this,type:g.ModelEventType.Splice,removed:j})):l.trace&&l.trace("No modelEvents neccessary.",b._dumpString())}this.results=i(this._query._sortResults(this.results),this.model)},_constructNotificationName:function(){return this.model.collectionName+":"+this.model.name},terminate:function(){this.handler&&f.removeListener(this._constructNotificationName(),this.handler),this.results=null,this.handler=null},listen:function(a){return this.on("change",a),function(){this.removeListener("change",a)}.bind(this)},listenOnce:function(a){this.once("change",a)}}),b.exports=c},{"./error":11,"./events":12,"./log":14,"./modelEvents":18,"./query":20,"./querySet":21,"./util":25,events:29}],23:[function(a,b){function c(a,b){var c=i.defer(b);b=c.finish.bind(c),l.debug.isEnabled&&l.debug("get",a);var e;if(a._id){if(i.isArray(a._id))d(j.map(a._id,function(a){return{_id:a}}),b);else if(e=k.get(a))l.debug.isEnabled&&l.debug("Had cached object",{opts:a,obj:e}),b&&b(null,e);else if(i.isArray(a._id))d(j.map(a._id,function(a){return{_id:a}}),b);else if(b){var f=siesta.ext.storage;if(!f)throw new Error("Storage module not installed");f.store.getFromPouch(a,b)}}else{if(!a.model){var h={opts:a},m="Invalid options given to store";throw new g(m,h)}if(i.isArray(a[a.model.id]))d(j.map(a[a.model.id],function(b){var c={};return c[a.model.id]=b,c.model=a.model,c}),b);else if(e=k.get(a))l.debug.isEnabled&&l.debug("Had cached object",{opts:a,obj:e}),b&&b(null,e);else{var n=a.model;if(n.singleton)n.one(b);else{var o=n.id,p=a[o],q={};if(q[o]=p,!p)throw new g('Invalid options given to store. Missing "'+o.toString()+'."');n.one(q,function(a,c){a?b(a):c?b(null,c):b(null,null)})}}}return c.promise}function d(a,b){var d=i.defer(b);b=d.finish.bind(d);var e=[],f=[];return j.each(a,function(d){c(d,function(c,d){c?f.push(c):e.push(d),e.length+f.length==a.length&&b&&(f.length?b(f):b(null,e))})}),d.promise}function e(a,b){function c(c){b&&(c?b(c):b(null,j.map(a,function(a){return e.cached[a]})))}var d=i.defer(b);b=d.finish.bind(d);var e=j.reduce(a,function(a,b){var c=k.get({_id:b});return c?a.cached[b]=c:a.notCached.push(b),a},{cached:{},notCached:[]});return c(),d.promise}function f(a,b,c){function d(b){c&&(b?c(b):c(null,j.map(a,function(a){return f.cached[a]})))}var e=i.defer(c);c=e.finish.bind(e);var f=j.reduce(a,function(a,c){var d={model:b};d[b.id]=c;var e=k.get(d);return e?a.cached[c]=e:a.notCached.push(c),a},{cached:{},notCached:[]});return d(),e.promise}var g=a("./error").InternalSiestaError,h=a("./log"),i=a("./util"),j=i._,k=a("./cache"),l=h.loggerWithName("Store");b.exports={get:c,getMultiple:d,getMultipleLocal:e,getMultipleRemote:f}},{"./cache":8,"./error":11,"./log":14,"./util":25}],24:[function(a,b){function c(a){return function(){var b=Array.prototype.slice.call(arguments);return a.apply(null,[i].concat(b))}}function d(a,b){if(a.map)return a.map(b);var c=[];return i(a,function(a,d,e){c.push(b(a,d,e))}),c}function e(a,b,c,e){if(b=d(b,function(a,b){return{index:b,value:a}}),e){var f=[];a(b,function(a,b){c(a.value,function(c,d){f[a.index]=d,b(c)})},function(a){e(a,f)})}else a(b,function(a,b){c(a.value,function(a){b(a)})})}function f(a){return function(){var b=Array.prototype.slice.call(arguments);return a.apply(null,[g].concat(b))}}function g(a,b,c){if(c=c||function(){},!a.length)return c();var d=0,e=function(){b(a[d],function(b){b?(c(b),c=function(){}):(d+=1,d>=a.length?c():e())})};e()}function h(a,b){if(a.forEach)return a.forEach(b);for(var c=0;c<a.length;c+=1)b(a[c],c,a)}function i(a,b,c){function d(b){b?(c(b),c=function(){}):(e+=1,e>=a.length&&c())}if(c=c||function(){},!a.length)return c();var e=0;h(a,function(a){b(a,k(d))})}function j(a,b){if(b=b||function(){},n.isArray(a))q(a,function(a,b){a&&a(function(a){var c=Array.prototype.slice.call(arguments,1);c.length<=1&&(c=c[0]),b.call(null,a,c)})},b);else{var c={};g(o.keys(a),function(b,d){a[b](function(a){var e=Array.prototype.slice.call(arguments,1);e.length<=1&&(e=e[0]),c[b]=e,d(a)})},function(a){b(a,c)})}}function k(a){var b=!1;return function(){if(b)throw new Error("Callback was already called.");b=!0,a.apply(m,arguments)}}function l(a,b){r({map:p,each:i},a,b)}var m,n=a("./misc"),o=a("./underscore"),p=c(e),q=f(e),r=function(a,b,c){if(c=c||function(){},n.isArray(b))a.map(b,function(a,b){a&&a(function(a){var c=Array.prototype.slice.call(arguments,1);c.length<=1&&(c=c[0]),b.call(null,a,c)})},c);else{var d={};a.each(keys(b),function(a,c){b[a](function(b){var e=Array.prototype.slice.call(arguments,1);e.length<=1&&(e=e[0]),d[a]=e,c(b)})},function(a){c(a,d)})}};b.exports={series:j,parallel:l}},{"./misc":26,"./underscore":28}],25:[function(a,b){var c=a("./underscore"),d=a("./async"),e=a("./misc");c.extend(b.exports,{_:c,defer:a("./promise"),async:d}),c.extend(b.exports,e)},{"./async":24,"./misc":26,"./promise":27,"./underscore":28}],26:[function(a,b){function c(a,b){return function(c){a&&a.apply(a,arguments),b&&(c?b.reject(c):b.resolve.apply(b,Array.prototype.slice.call(arguments,1)))}}var d=a("../../vendor/observe-js/src/observe").Platform,e=a("./underscore"),f=a("./../error").InternalSiestaError,g=/^function\s*[^\(]*\(\s*([^\)]*)\)/m,h=/,/,i=/^\s*(_?)(.+?)\1\s*$/,j=/((\/\/.*$)|(\/\*[\s\S]*?\*\/))/gm,k=Array.isArray||function(a){return"[object Array]"===e.toString.call(a)},l=function(a){return"string"==typeof a||a instanceof String};e.extend(b.exports,{next:function(a){d.performMicrotaskCheckpoint(),setTimeout(a)},cb:c,guid:function(){function a(){return Math.floor(65536*(1+Math.random())).toString(16).substring(1)}return function(){return a()+a()+"-"+a()+"-"+a()+"-"+a()+"-"+a()+a()+a()}}(),assert:function(a,b,c){if(!a)throw b=b||"Assertion failed",c=c||{},new f(b,c)},thenBy:function(){function a(a){return a.thenBy=b,a}function b(b){var c=this;return a(function(a,d){return c(a,d)||b(a,d)})}return a}(),defer:function(a){var b;if(a=a||function(){},window.q){b=window.q.defer();var c=b.reject,d=b.resolve;e.extend(b,{reject:function(b){a(b),c.call(this,b)},resolve:function(b){a(null,b),d.call(this,b)},finish:function(b,e){a(b,e),b?c.call(this,b):d.call(this,e)}})}else b={promise:void 0,reject:function(b){a(b)},resolve:function(b){a(null,b)},finish:function(b,c){a(b,c)}};return b},defineSubProperty:function(a,b,c){return Object.defineProperty(this,a,{get:function(){return c?b[c]:b[a]},set:function(d){c?b[c]=d:b[a]=d},enumerable:!0,configurable:!0})},defineSubPropertyNoSet:function(a,b,c){return Object.defineProperty(this,a,{get:function(){return c?b[c]:b[a]},enumerable:!0,configurable:!0})},subProperties:function(a,b,c){k(c)||(c=Array.prototype.slice.call(arguments,2));for(var d=0;d<c.length;d++)!function(c){var d={set:!1,name:c,property:c};l(c)||e.extend(d,c);var f={get:function(){return b[d.property]},enumerable:!0,configurable:!0};d.set&&(f.set=function(a){b[d.property]=a}),Object.defineProperty(a,d.name,f)}(c[d])},capitaliseFirstLetter:function(a){return a.charAt(0).toUpperCase()+a.slice(1)},extendFromOpts:function(a,b,c,d){if(d=void 0==d?!0:d){var f=Object.keys(c),g=Object.keys(b),h=g.filter(function(a){return-1==f.indexOf(a)});if(h.length)throw Error("Unknown options: "+h.toString())}e.each(Object.keys(c),function(a){var d=c[a];"function"==typeof d&&(c[a]=d(b[a]),delete b[a])}),e.extend(c,b),e.extend(a,c)},isString:l,isArray:k,prettyPrint:function(a){return JSON.stringify(a,null,4)},flattenArray:function(a){return e.reduce(a,function(a,b){return k(b)?a=a.concat(b):a.push(b),a},[])},unflattenArray:function(a,b){for(var c=0,d=[],e=0;e<b.length;e++)if(k(b[e])){var f=[];d[e]=f;for(var g=0;g<b[e].length;g++)f.push(a[c]),c++}else d[e]=a[c],c++;return d},paramNames:function(a){var b,c,d=[];return b=a.toString().replace(j,""),c=b.match(g),c[1].split(h).forEach(function(a){a.replace(i,function(a,b,c){d.push(c)})}),d}})},{"../../vendor/observe-js/src/observe":31,"./../error":11,"./underscore":28}],27:[function(a,b){function c(a){return function(b){this.res=b;try{this.success.forEach(function(c){c(a?b:void 0)})}catch(c){e.call(this,c)}}}function d(a){this._fail=a,this.error=a,this.failure.forEach(function(b){b(a)}),this.errors.forEach(function(b){b(a)})}function e(a){this.error=a,this.errors.forEach(function(b){b(a)})}function f(){_.extend(this,{success:[],failure:[],errors:[],_nextPromise:null}),Object.defineProperty(this,"nextPromise",{get:function(){return this._nextPromise||(this._nextPromise=new f,this.success.push(c(!1).bind(this._nextPromise)),this.failure.push(d.bind(this._nextPromise)),this.errors.push(e.bind(this._nextPromise)),this._nextPromise._fail=this._fail,this._nextPromise.error=this.error,this._nextPromise.res=this.res),this._nextPromise}})}function g(a){_.extend(this,{cb:a||function(){},promise:new f})}var h=function(a){return a&&(this.error?a(this.error):this.errors.push(a)),this.nextPromise};_.extend(f.prototype,{then:function(a,b){return a&&(this.res?a(this.res):this.success.push(a)),b&&(this._fail?b(this._fail):this.failure.push(b)),this.nextPromise
},"catch":h,fail:h,done:function(a,b){this.then(a).catch(b)}}),_.extend(g.prototype,{resolve:function(a){c(!0).call(this.promise,a),this.cb(null,a)},reject:function(a){d.call(this.promise,a),this.cb(a?a:!0)},finish:function(a,b){if(this==window)throw"wtf";a?this.reject(a):this.resolve(b)}}),b.exports=function(a){return new g(a)}},{}],28:[function(a,b){function c(a){if(Object.keys)return Object.keys(a);var b=[];for(var c in a)a.hasOwnProperty(c)&&b.push(c);return b}var d={},e=Array.prototype,f=Function.prototype,g=e.forEach,h=e.map,i=e.reduce,j=f.bind,k=e.slice,l={},m=function(){};d.keys=c,d.each=d.forEach=function(a,b,c){if(null==a)return a;if(g&&a.forEach===g)a.forEach(b,c);else if(a.length===+a.length){for(var e=0,f=a.length;f>e;e++)if(b.call(c,a[e],e,a)===l)return}else for(var h=d.keys(a),e=0,f=h.length;f>e;e++)if(b.call(c,a[h[e]],h[e],a)===l)return;return a},d.map=d.collect=function(a,b,c){var e=[];return null==a?e:h&&a.map===h?a.map(b,c):(d.each(a,function(a,d,f){e.push(b.call(c,a,d,f))}),e)},d.partial=function(a){var b=k.call(arguments,1);return function(){for(var c=0,e=b.slice(),f=0,g=e.length;g>f;f++)e[f]===d&&(e[f]=arguments[c++]);for(;c<arguments.length;)e.push(arguments[c++]);return a.apply(this,e)}},d.pluck=function(a,b){return d.map(a,d.property(b))};var n="Reduce of empty array with no initial value";d.reduce=d.foldl=d.inject=function(a,b,c,e){var f=arguments.length>2;if(null==a&&(a=[]),i&&a.reduce===i)return e&&(b=d.bind(b,e)),f?a.reduce(b,c):a.reduce(b);if(d.each(a,function(a,d,g){f?c=b.call(e,c,a,d,g):(c=a,f=!0)}),!f)throw new TypeError(n);return c},d.property=function(a){return function(b){return b[a]}},"function"!=typeof/./&&(d.isFunction=function(a){return"function"==typeof a}),d.isObject=function(a){var b=typeof a;return"function"===b||"object"===b&&!!a};var o=function(a){return null==a?d.identity:d.isFunction(a)?a:d.property(a)};d.sortBy=function(a,b,c){return b=o(b),d.pluck(d.map(a,function(a,d,e){return{value:a,index:d,criteria:b.call(c,a,d,e)}}).sort(function(a,b){var c=a.criteria,d=b.criteria;if(c!==d){if(c>d||void 0===c)return 1;if(d>c||void 0===d)return-1}return a.index-b.index}),"value")},d.bind=function(a,b){var c,e;if(j&&a.bind===j)return j.apply(a,k.call(arguments,1));if(!d.isFunction(a))throw new TypeError;return c=k.call(arguments,2),e=function(){if(!(this instanceof e))return a.apply(b,c.concat(k.call(arguments)));m.prototype=a.prototype;var d=new m;m.prototype=null;var f=a.apply(d,c.concat(k.call(arguments)));return Object(f)===f?f:d}},d.identity=function(a){return a},d.zip=function(a){if(null==a)return[];for(var b=d.max(arguments,"length").length,c=Array(b),e=0;b>e;e++)c[e]=d.pluck(arguments,e);return c},d.max=function(a,b,c){var e,f,g=-1/0,h=-1/0;if(null==b&&null!=a){a=a.length===+a.length?a:d.values(a);for(var i=0,j=a.length;j>i;i++)e=a[i],e>g&&(g=e)}else b=d.iteratee(b,c),d.each(a,function(a,c,d){f=b(a,c,d),(f>h||f===-1/0&&g===-1/0)&&(g=a,h=f)});return g},d.iteratee=function(a,b,c){return null==a?d.identity:d.isFunction(a)?createCallback(a,b,c):d.isObject(a)?d.matches(a):d.property(a)},d.pairs=function(a){for(var b=d.keys(a),c=b.length,e=Array(c),f=0;c>f;f++)e[f]=[b[f],a[b[f]]];return e},d.matches=function(a){var b=d.pairs(a),c=b.length;return function(a){if(null==a)return!c;a=new Object(a);for(var d=0;c>d;d++){var e=b[d],f=e[0];if(e[1]!==a[f]||!(f in a))return!1}return!0}},d.some=function(a,b,c){if(null==a)return!1;b=d.iteratee(b,c);var e,f,g=a.length!==+a.length&&d.keys(a),h=(g||a).length;for(e=0;h>e;e++)if(f=g?g[e]:e,b(a[f],f,a))return!0;return!1},d.extend=function(a){if(!d.isObject(a))return a;for(var b,c,e=1,f=arguments.length;f>e;e++){b=arguments[e];for(c in b)hasOwnProperty.call(b,c)&&(a[c]=b[c])}return a},b.exports=d},{}],29:[function(a,b){function c(){this._events=this._events||{},this._maxListeners=this._maxListeners||void 0}function d(a){return"function"==typeof a}function e(a){return"number"==typeof a}function f(a){return"object"==typeof a&&null!==a}function g(a){return void 0===a}b.exports=c,c.EventEmitter=c,c.prototype._events=void 0,c.prototype._maxListeners=void 0,c.defaultMaxListeners=10,c.prototype.setMaxListeners=function(a){if(!e(a)||0>a||isNaN(a))throw TypeError("n must be a positive number");return this._maxListeners=a,this},c.prototype.emit=function(a){var b,c,e,h,i,j;if(this._events||(this._events={}),"error"===a&&(!this._events.error||f(this._events.error)&&!this._events.error.length)){if(b=arguments[1],b instanceof Error)throw b;throw TypeError('Uncaught, unspecified "error" event.')}if(c=this._events[a],g(c))return!1;if(d(c))switch(arguments.length){case 1:c.call(this);break;case 2:c.call(this,arguments[1]);break;case 3:c.call(this,arguments[1],arguments[2]);break;default:for(e=arguments.length,h=new Array(e-1),i=1;e>i;i++)h[i-1]=arguments[i];c.apply(this,h)}else if(f(c)){for(e=arguments.length,h=new Array(e-1),i=1;e>i;i++)h[i-1]=arguments[i];for(j=c.slice(),e=j.length,i=0;e>i;i++)j[i].apply(this,h)}return!0},c.prototype.addListener=function(a,b){var e;if(!d(b))throw TypeError("listener must be a function");if(this._events||(this._events={}),this._events.newListener&&this.emit("newListener",a,d(b.listener)?b.listener:b),this._events[a]?f(this._events[a])?this._events[a].push(b):this._events[a]=[this._events[a],b]:this._events[a]=b,f(this._events[a])&&!this._events[a].warned){var e;e=g(this._maxListeners)?c.defaultMaxListeners:this._maxListeners,e&&e>0&&this._events[a].length>e&&(this._events[a].warned=!0,console.error("(node) warning: possible EventEmitter memory leak detected. %d listeners added. Use emitter.setMaxListeners() to increase limit.",this._events[a].length),"function"==typeof console.trace&&console.trace())}return this},c.prototype.on=c.prototype.addListener,c.prototype.once=function(a,b){function c(){this.removeListener(a,c),e||(e=!0,b.apply(this,arguments))}if(!d(b))throw TypeError("listener must be a function");var e=!1;return c.listener=b,this.on(a,c),this},c.prototype.removeListener=function(a,b){var c,e,g,h;if(!d(b))throw TypeError("listener must be a function");if(!this._events||!this._events[a])return this;if(c=this._events[a],g=c.length,e=-1,c===b||d(c.listener)&&c.listener===b)delete this._events[a],this._events.removeListener&&this.emit("removeListener",a,b);else if(f(c)){for(h=g;h-->0;)if(c[h]===b||c[h].listener&&c[h].listener===b){e=h;break}if(0>e)return this;1===c.length?(c.length=0,delete this._events[a]):c.splice(e,1),this._events.removeListener&&this.emit("removeListener",a,b)}return this},c.prototype.removeAllListeners=function(a){var b,c;if(!this._events)return this;if(!this._events.removeListener)return 0===arguments.length?this._events={}:this._events[a]&&delete this._events[a],this;if(0===arguments.length){for(b in this._events)"removeListener"!==b&&this.removeAllListeners(b);return this.removeAllListeners("removeListener"),this._events={},this}if(c=this._events[a],d(c))this.removeListener(a,c);else for(;c.length;)this.removeListener(a,c[c.length-1]);return delete this._events[a],this},c.prototype.listeners=function(a){var b;return b=this._events&&this._events[a]?d(this._events[a])?[this._events[a]]:this._events[a].slice():[]},c.listenerCount=function(a,b){var c;return c=a._events&&a._events[b]?d(a._events[b])?1:a._events[b].length:0}},{}],30:[function(a,b){var c,d=Object.prototype.hasOwnProperty,e=Object.prototype.toString,f=function(a){"use strict";if(!a||"[object Object]"!==e.call(a)||a.nodeType||a.setInterval)return!1;var b=d.call(a,"constructor"),f=a.constructor&&a.constructor.prototype&&d.call(a.constructor.prototype,"isPrototypeOf");if(a.constructor&&!b&&!f)return!1;var g;for(g in a);return g===c||d.call(a,g)};b.exports=function g(){"use strict";var a,b,d,e,h,i,j=arguments[0],k=1,l=arguments.length,m=!1;for("boolean"==typeof j?(m=j,j=arguments[1]||{},k=2):("object"!=typeof j&&"function"!=typeof j||j==c)&&(j={});l>k;++k)if(null!=(a=arguments[k]))for(b in a)d=j[b],e=a[b],j!==e&&(m&&e&&(f(e)||(h=Array.isArray(e)))?(h?(h=!1,i=d&&Array.isArray(d)?d:[]):i=d&&f(d)?d:{},j[b]=g(m,i,e)):e!==c&&(j[b]=e));return j}},{}],31:[function(require,module,exports){(function(global){!function(global){"use strict";function detectObjectObserve(){function a(a){b=a}if("function"!=typeof Object.observe||"function"!=typeof Array.observe)return!1;var b=[],c={},d=[];return Object.observe(c,a),Array.observe(d,a),c.id=1,c.id=2,delete c.id,d.push(1,2),d.length=0,Object.deliverChangeRecords(a),5!==b.length?!1:"add"!=b[0].type||"update"!=b[1].type||"delete"!=b[2].type||"splice"!=b[3].type||"splice"!=b[4].type?!1:(Object.unobserve(c,a),Array.unobserve(d,a),!0)}function detectEval(){if("undefined"!=typeof chrome&&chrome.app&&chrome.app.runtime)return!1;if(navigator.getDeviceStorage)return!1;try{var a=new Function("","return true;");return a()}catch(b){return!1}}function isIndex(a){return+a===a>>>0&&""!==a}function toNumber(a){return+a}function isObject(a){return a===Object(a)}function areSameValue(a,b){return a===b?0!==a||1/a===1/b:numberIsNaN(a)&&numberIsNaN(b)?!0:a!==a&&b!==b}function getPathCharType(a){if(void 0===a)return"eof";var b=a.charCodeAt(0);switch(b){case 91:case 93:case 46:case 34:case 39:case 48:return a;case 95:case 36:return"ident";case 32:case 9:case 10:case 13:case 160:case 65279:case 8232:case 8233:return"ws"}return b>=97&&122>=b||b>=65&&90>=b?"ident":b>=49&&57>=b?"number":"else"}function noop(){}function parsePath(a){function b(){if(!(k>=a.length)){var b=a[k+1];return"inSingleQuote"==l&&"'"==b||"inDoubleQuote"==l&&'"'==b?(k++,d=b,m.append(),!0):void 0}}for(var c,d,e,f,g,h,i,j=[],k=-1,l="beforePath",m={push:function(){void 0!==e&&(j.push(e),e=void 0)},append:function(){void 0===e?e=d:e+=d}};l;)if(k++,c=a[k],"\\"!=c||!b(l)){if(f=getPathCharType(c),i=pathStateMachine[l],g=i[f]||i["else"]||"error","error"==g)return;if(l=g[0],h=m[g[1]]||noop,d=void 0===g[2]?c:g[2],h(),"afterPath"===l)return j}}function isIdent(a){return identRegExp.test(a)}function Path(a,b){if(b!==constructorIsPrivate)throw Error("Use Path.get to retrieve path objects");for(var c=0;c<a.length;c++)this.push(String(a[c]));hasEval&&this.length&&(this.getValueFrom=this.compiledGetValueFromFn())}function getPath(a){if(a instanceof Path)return a;if((null==a||0==a.length)&&(a=""),"string"!=typeof a){if(isIndex(a.length))return new Path(a,constructorIsPrivate);a=String(a)}var b=pathCache[a];if(b)return b;var c=parsePath(a);if(!c)return invalidPath;var b=new Path(c,constructorIsPrivate);return pathCache[a]=b,b}function formatAccessor(a){return isIndex(a)?"["+a+"]":'["'+a.replace(/"/g,'\\"')+'"]'}function dirtyCheck(a){for(var b=0;MAX_DIRTY_CHECK_CYCLES>b&&a.check_();)b++;return testingExposeCycleCount&&(global.dirtyCheckCycleCount=b),b>0}function objectIsEmpty(a){for(var b in a)return!1;return!0}function diffIsEmpty(a){return objectIsEmpty(a.added)&&objectIsEmpty(a.removed)&&objectIsEmpty(a.changed)}function diffObjectFromOldObject(a,b){var c={},d={},e={};for(var f in b){var g=a[f];(void 0===g||g!==b[f])&&(f in a?g!==b[f]&&(e[f]=g):d[f]=void 0)}for(var f in a)f in b||(c[f]=a[f]);return Array.isArray(a)&&a.length!==b.length&&(e.length=a.length),{added:c,removed:d,changed:e}}function runEOMTasks(){if(!eomTasks.length)return!1;for(var a=0;a<eomTasks.length;a++)eomTasks[a]();return eomTasks.length=0,!0}function newObservedObject(){function a(a){b&&b.state_===OPENED&&!d&&b.check_(a)}var b,c,d=!1,e=!0;return{open:function(c){if(b)throw Error("ObservedObject in use");e||Object.deliverChangeRecords(a),b=c,e=!1},observe:function(b,d){c=b,d?Array.observe(c,a):Object.observe(c,a)},deliver:function(b){d=b,Object.deliverChangeRecords(a),d=!1},close:function(){b=void 0,Object.unobserve(c,a),observedObjectCache.push(this)}}}function getObservedObject(a,b,c){var d=observedObjectCache.pop()||newObservedObject();return d.open(a),d.observe(b,c),d}function newObservedSet(){function a(b,f){b&&(b===d&&(e[f]=!0),h.indexOf(b)<0&&(h.push(b),Object.observe(b,c)),a(Object.getPrototypeOf(b),f))}function b(a){for(var b=0;b<a.length;b++){var c=a[b];if(c.object!==d||e[c.name]||"setPrototype"===c.type)return!1}return!0}function c(c){if(!b(c)){for(var d,e=0;e<g.length;e++)d=g[e],d.state_==OPENED&&d.iterateObjects_(a);for(var e=0;e<g.length;e++)d=g[e],d.state_==OPENED&&d.check_()}}var d,e,f=0,g=[],h=[],i={object:void 0,objects:h,open:function(b,c){d||(d=c,e={}),g.push(b),f++,b.iterateObjects_(a)},close:function(){if(f--,!(f>0)){for(var a=0;a<h.length;a++)Object.unobserve(h[a],c),Observer.unobservedCount++;g.length=0,h.length=0,d=void 0,e=void 0,observedSetCache.push(this)}}};return i}function getObservedSet(a,b){return lastObservedSet&&lastObservedSet.object===b||(lastObservedSet=observedSetCache.pop()||newObservedSet(),lastObservedSet.object=b),lastObservedSet.open(a,b),lastObservedSet}function Observer(){this.state_=UNOPENED,this.callback_=void 0,this.target_=void 0,this.directObserver_=void 0,this.value_=void 0,this.id_=nextObserverId++}function addToAll(a){Observer._allObserversCount++,collectObservers&&allObservers.push(a)}function removeFromAll(){Observer._allObserversCount--}function ObjectObserver(a){Observer.call(this),this.value_=a,this.oldObject_=void 0}function ArrayObserver(a){if(!Array.isArray(a))throw Error("Provided object is not an Array");ObjectObserver.call(this,a)}function PathObserver(a,b){Observer.call(this),this.object_=a,this.path_=getPath(b),this.directObserver_=void 0}function CompoundObserver(a){Observer.call(this),this.reportChangesOnOpen_=a,this.value_=[],this.directObserver_=void 0,this.observed_=[]}function identFn(a){return a}function ObserverTransform(a,b,c,d){this.callback_=void 0,this.target_=void 0,this.value_=void 0,this.observable_=a,this.getValueFn_=b||identFn,this.setValueFn_=c||identFn,this.dontPassThroughSet_=d}function diffObjectFromChangeRecords(a,b,c){for(var d={},e={},f=0;f<b.length;f++){var g=b[f];expectedRecordTypes[g.type]?(g.name in c||(c[g.name]=g.oldValue),"update"!=g.type&&("add"!=g.type?g.name in d?(delete d[g.name],delete c[g.name]):e[g.name]=!0:g.name in e?delete e[g.name]:d[g.name]=!0)):(console.error("Unknown changeRecord type: "+g.type),console.error(g))}for(var h in d)d[h]=a[h];for(var h in e)e[h]=void 0;var i={};for(var h in c)if(!(h in d||h in e)){var j=a[h];c[h]!==j&&(i[h]=j)}return{added:d,removed:e,changed:i}}function newSplice(a,b,c){return{index:a,removed:b,addedCount:c}}function ArraySplice(){}function calcSplices(a,b,c,d,e,f){return arraySplice.calcSplices(a,b,c,d,e,f)}function intersect(a,b,c,d){return c>b||a>d?-1:b==c||d==a?0:c>a?d>b?b-c:d-c:b>d?d-a:b-a}function mergeSplice(a,b,c,d){for(var e=newSplice(b,c,d),f=!1,g=0,h=0;h<a.length;h++){var i=a[h];if(i.index+=g,!f){var j=intersect(e.index,e.index+e.removed.length,i.index,i.index+i.addedCount);if(j>=0){a.splice(h,1),h--,g-=i.addedCount-i.removed.length,e.addedCount+=i.addedCount-j;var k=e.removed.length+i.removed.length-j;if(e.addedCount||k){var c=i.removed;if(e.index<i.index){var l=e.removed.slice(0,i.index-e.index);Array.prototype.push.apply(l,c),c=l}if(e.index+e.removed.length>i.index+i.addedCount){var m=e.removed.slice(i.index+i.addedCount-e.index);Array.prototype.push.apply(c,m)}e.removed=c,i.index<e.index&&(e.index=i.index)}else f=!0}else if(e.index<i.index){f=!0,a.splice(h,0,e),h++;var n=e.addedCount-e.removed.length;i.index+=n,g+=n}}}f||a.push(e)}function createInitialSplices(a,b){for(var c=[],d=0;d<b.length;d++){var e=b[d];switch(e.type){case"splice":mergeSplice(c,e.index,e.removed.slice(),e.addedCount);break;case"add":case"update":case"delete":if(!isIndex(e.name))continue;var f=toNumber(e.name);if(0>f)continue;mergeSplice(c,f,[e.oldValue],1);break;default:console.error("Unexpected record type: "+JSON.stringify(e))}}return c}function projectArraySplices(a,b){var c=[];return createInitialSplices(a,b).forEach(function(b){return 1==b.addedCount&&1==b.removed.length?void(b.removed[0]!==a[b.index]&&c.push(b)):void(c=c.concat(calcSplices(a,b.index,b.index+b.addedCount,b.removed,0,b.removed.length)))}),c}var testingExposeCycleCount=global.testingExposeCycleCount,hasObserve=detectObjectObserve(),hasEval=detectEval(),numberIsNaN=global.Number.isNaN||function(a){return"number"==typeof a&&global.isNaN(a)},createObject="__proto__"in{}?function(a){return a}:function(a){var b=a.__proto__;if(!b)return a;var c=Object.create(b);return Object.getOwnPropertyNames(a).forEach(function(b){Object.defineProperty(c,b,Object.getOwnPropertyDescriptor(a,b))}),c},identStart="[$_a-zA-Z]",identPart="[$_a-zA-Z0-9]",identRegExp=new RegExp("^"+identStart+"+"+identPart+"*$"),pathStateMachine={beforePath:{ws:["beforePath"],ident:["inIdent","append"],"[":["beforeElement"],eof:["afterPath"]},inPath:{ws:["inPath"],".":["beforeIdent"],"[":["beforeElement"],eof:["afterPath"]},beforeIdent:{ws:["beforeIdent"],ident:["inIdent","append"]},inIdent:{ident:["inIdent","append"],0:["inIdent","append"],number:["inIdent","append"],ws:["inPath","push"],".":["beforeIdent","push"],"[":["beforeElement","push"],eof:["afterPath","push"]},beforeElement:{ws:["beforeElement"],0:["afterZero","append"],number:["inIndex","append"],"'":["inSingleQuote","append",""],'"':["inDoubleQuote","append",""]},afterZero:{ws:["afterElement","push"],"]":["inPath","push"]},inIndex:{0:["inIndex","append"],number:["inIndex","append"],ws:["afterElement"],"]":["inPath","push"]},inSingleQuote:{"'":["afterElement"],eof:["error"],"else":["inSingleQuote","append"]},inDoubleQuote:{'"':["afterElement"],eof:["error"],"else":["inDoubleQuote","append"]},afterElement:{ws:["afterElement"],"]":["inPath","push"]}},constructorIsPrivate={},pathCache={};Path.get=getPath,Path.prototype=createObject({__proto__:[],valid:!0,toString:function(){for(var a="",b=0;b<this.length;b++){var c=this[b];a+=isIdent(c)?b?"."+c:c:formatAccessor(c)}return a},getValueFrom:function(a){for(var b=0;b<this.length;b++){if(null==a)return;a=a[this[b]]}return a},iterateObjects:function(a,b){for(var c=0;c<this.length;c++){if(c&&(a=a[this[c-1]]),!isObject(a))return;b(a,this[0])}},compiledGetValueFromFn:function(){var a="",b="obj";a+="if (obj != null";for(var c,d=0;d<this.length-1;d++)c=this[d],b+=isIdent(c)?"."+c:formatAccessor(c),a+=" &&\n     "+b+" != null";a+=")\n";var c=this[d];return b+=isIdent(c)?"."+c:formatAccessor(c),a+="  return "+b+";\nelse\n  return undefined;",new Function("obj",a)},setValueFrom:function(a,b){if(!this.length)return!1;for(var c=0;c<this.length-1;c++){if(!isObject(a))return!1;a=a[this[c]]}return isObject(a)?(a[this[c]]=b,!0):!1}});var invalidPath=new Path("",constructorIsPrivate);invalidPath.valid=!1,invalidPath.getValueFrom=invalidPath.setValueFrom=function(){};var MAX_DIRTY_CHECK_CYCLES=1e3,eomTasks=[],runEOM=hasObserve?function(){var a={pingPong:!0},b=!1;return Object.observe(a,function(){runEOMTasks(),b=!1}),function(c){eomTasks.push(c),b||(b=!0,a.pingPong=!a.pingPong)}}():function(){return function(a){eomTasks.push(a)}}(),observedObjectCache=[],observedSetCache=[],lastObservedSet,UNOPENED=0,OPENED=1,CLOSED=2,RESETTING=3,nextObserverId=1;Observer.prototype={open:function(a,b){if(this.state_!=UNOPENED)throw Error("Observer has already been opened.");return addToAll(this),this.callback_=a,this.target_=b,this.connect_(),this.state_=OPENED,this.value_},close:function(){this.state_==OPENED&&(removeFromAll(this),this.disconnect_(),this.value_=void 0,this.callback_=void 0,this.target_=void 0,this.state_=CLOSED)},deliver:function(){this.state_==OPENED&&dirtyCheck(this)},report_:function(a){try{this.callback_.apply(this.target_,a)}catch(b){Observer._errorThrownDuringCallback=!0,console.error("Exception caught during observer callback: "+(b.stack||b))}},discardChanges:function(){return this.check_(void 0,!0),this.value_}};var collectObservers=!hasObserve,allObservers;Observer._allObserversCount=0,collectObservers&&(allObservers=[]);var runningMicrotaskCheckpoint=!1,hasDebugForceFullDelivery=hasObserve&&hasEval&&function(){try{return eval("%RunMicrotasks()"),!0}catch(ex){return!1}}();global.Platform=global.Platform||{},global.Platform.performMicrotaskCheckpoint=function(){if(!runningMicrotaskCheckpoint){if(hasDebugForceFullDelivery)return void eval("%RunMicrotasks()");if(collectObservers){runningMicrotaskCheckpoint=!0;var cycles=0,anyChanged,toCheck;do{cycles++,toCheck=allObservers,allObservers=[],anyChanged=!1;for(var i=0;i<toCheck.length;i++){var observer=toCheck[i];observer.state_==OPENED&&(observer.check_()&&(anyChanged=!0),allObservers.push(observer))}runEOMTasks()&&(anyChanged=!0)}while(MAX_DIRTY_CHECK_CYCLES>cycles&&anyChanged);testingExposeCycleCount&&(global.dirtyCheckCycleCount=cycles),runningMicrotaskCheckpoint=!1}}},collectObservers&&(global.Platform.clearObservers=function(){allObservers=[]}),ObjectObserver.prototype=createObject({__proto__:Observer.prototype,arrayObserve:!1,connect_:function(){hasObserve?this.directObserver_=getObservedObject(this,this.value_,this.arrayObserve):this.oldObject_=this.copyObject(this.value_)},copyObject:function(a){var b=Array.isArray(a)?[]:{};for(var c in a)b[c]=a[c];return Array.isArray(a)&&(b.length=a.length),b},check_:function(a){var b,c;if(hasObserve){if(!a)return!1;c={},b=diffObjectFromChangeRecords(this.value_,a,c)}else c=this.oldObject_,b=diffObjectFromOldObject(this.value_,this.oldObject_);return diffIsEmpty(b)?!1:(hasObserve||(this.oldObject_=this.copyObject(this.value_)),this.report_([b.added||{},b.removed||{},b.changed||{},function(a){return c[a]}]),!0)},disconnect_:function(){hasObserve?(this.directObserver_.close(),this.directObserver_=void 0):this.oldObject_=void 0},deliver:function(){this.state_==OPENED&&(hasObserve?this.directObserver_.deliver(!1):dirtyCheck(this))},discardChanges:function(){return this.directObserver_?this.directObserver_.deliver(!0):this.oldObject_=this.copyObject(this.value_),this.value_}}),ArrayObserver.prototype=createObject({__proto__:ObjectObserver.prototype,arrayObserve:!0,copyObject:function(a){return a.slice()},check_:function(a){var b;if(hasObserve){if(!a)return!1;b=projectArraySplices(this.value_,a)}else b=calcSplices(this.value_,0,this.value_.length,this.oldObject_,0,this.oldObject_.length);return b&&b.length?(hasObserve||(this.oldObject_=this.copyObject(this.value_)),this.report_([b]),!0):!1}}),ArrayObserver.applySplices=function(a,b,c){c.forEach(function(c){for(var d=[c.index,c.removed.length],e=c.index;e<c.index+c.addedCount;)d.push(b[e]),e++;Array.prototype.splice.apply(a,d)})},PathObserver.prototype=createObject({__proto__:Observer.prototype,get path(){return this.path_},connect_:function(){hasObserve&&(this.directObserver_=getObservedSet(this,this.object_)),this.check_(void 0,!0)},disconnect_:function(){this.value_=void 0,this.directObserver_&&(this.directObserver_.close(this),this.directObserver_=void 0)},iterateObjects_:function(a){this.path_.iterateObjects(this.object_,a)},check_:function(a,b){var c=this.value_;return this.value_=this.path_.getValueFrom(this.object_),b||areSameValue(this.value_,c)?!1:(this.report_([this.value_,c,this]),!0)},setValue:function(a){this.path_&&this.path_.setValueFrom(this.object_,a)}});var observerSentinel={};CompoundObserver.prototype=createObject({__proto__:Observer.prototype,connect_:function(){if(hasObserve){for(var a,b=!1,c=0;c<this.observed_.length;c+=2)if(a=this.observed_[c],a!==observerSentinel){b=!0;break}b&&(this.directObserver_=getObservedSet(this,a))}this.check_(void 0,!this.reportChangesOnOpen_)},disconnect_:function(){for(var a=0;a<this.observed_.length;a+=2)this.observed_[a]===observerSentinel&&this.observed_[a+1].close();this.observed_.length=0,this.value_.length=0,this.directObserver_&&(this.directObserver_.close(this),this.directObserver_=void 0)},addPath:function(a,b){if(this.state_!=UNOPENED&&this.state_!=RESETTING)throw Error("Cannot add paths once started.");var b=getPath(b);if(this.observed_.push(a,b),this.reportChangesOnOpen_){var c=this.observed_.length/2-1;this.value_[c]=b.getValueFrom(a)}},addObserver:function(a){if(this.state_!=UNOPENED&&this.state_!=RESETTING)throw Error("Cannot add observers once started.");if(this.observed_.push(observerSentinel,a),this.reportChangesOnOpen_){var b=this.observed_.length/2-1;this.value_[b]=a.open(this.deliver,this)}},startReset:function(){if(this.state_!=OPENED)throw Error("Can only reset while open");this.state_=RESETTING,this.disconnect_()},finishReset:function(){if(this.state_!=RESETTING)throw Error("Can only finishReset after startReset");return this.state_=OPENED,this.connect_(),this.value_},iterateObjects_:function(a){for(var b,c=0;c<this.observed_.length;c+=2)b=this.observed_[c],b!==observerSentinel&&this.observed_[c+1].iterateObjects(b,a)},check_:function(a,b){for(var c,d=0;d<this.observed_.length;d+=2){var e,f=this.observed_[d],g=this.observed_[d+1];if(f===observerSentinel){var h=g;e=this.state_===UNOPENED?h.open(this.deliver,this):h.discardChanges()}else e=g.getValueFrom(f);b?this.value_[d/2]=e:areSameValue(e,this.value_[d/2])||(c=c||[],c[d/2]=this.value_[d/2],this.value_[d/2]=e)}return c?(this.report_([this.value_,c,this.observed_]),!0):!1}}),ObserverTransform.prototype={open:function(a,b){return this.callback_=a,this.target_=b,this.value_=this.getValueFn_(this.observable_.open(this.observedCallback_,this)),this.value_},observedCallback_:function(a){if(a=this.getValueFn_(a),!areSameValue(a,this.value_)){var b=this.value_;this.value_=a,this.callback_.call(this.target_,this.value_,b)}},discardChanges:function(){return this.value_=this.getValueFn_(this.observable_.discardChanges()),this.value_},deliver:function(){return this.observable_.deliver()},setValue:function(a){return a=this.setValueFn_(a),!this.dontPassThroughSet_&&this.observable_.setValue?this.observable_.setValue(a):void 0},close:function(){this.observable_&&this.observable_.close(),this.callback_=void 0,this.target_=void 0,this.observable_=void 0,this.value_=void 0,this.getValueFn_=void 0,this.setValueFn_=void 0}};var expectedRecordTypes={add:!0,update:!0,"delete":!0},EDIT_LEAVE=0,EDIT_UPDATE=1,EDIT_ADD=2,EDIT_DELETE=3;ArraySplice.prototype={calcEditDistances:function(a,b,c,d,e,f){for(var g=f-e+1,h=c-b+1,i=new Array(g),j=0;g>j;j++)i[j]=new Array(h),i[j][0]=j;for(var k=0;h>k;k++)i[0][k]=k;for(var j=1;g>j;j++)for(var k=1;h>k;k++)if(this.equals(a[b+k-1],d[e+j-1]))i[j][k]=i[j-1][k-1];else{var l=i[j-1][k]+1,m=i[j][k-1]+1;i[j][k]=m>l?l:m}return i},spliceOperationsFromEditDistances:function(a){for(var b=a.length-1,c=a[0].length-1,d=a[b][c],e=[];b>0||c>0;)if(0!=b)if(0!=c){var f,g=a[b-1][c-1],h=a[b-1][c],i=a[b][c-1];f=i>h?g>h?h:g:g>i?i:g,f==g?(g==d?e.push(EDIT_LEAVE):(e.push(EDIT_UPDATE),d=g),b--,c--):f==h?(e.push(EDIT_DELETE),b--,d=h):(e.push(EDIT_ADD),c--,d=i)}else e.push(EDIT_DELETE),b--;else e.push(EDIT_ADD),c--;return e.reverse(),e},calcSplices:function(a,b,c,d,e,f){var g=0,h=0,i=Math.min(c-b,f-e);if(0==b&&0==e&&(g=this.sharedPrefix(a,d,i)),c==a.length&&f==d.length&&(h=this.sharedSuffix(a,d,i-g)),b+=g,e+=g,c-=h,f-=h,c-b==0&&f-e==0)return[];if(b==c){for(var j=newSplice(b,[],0);f>e;)j.removed.push(d[e++]);return[j]}if(e==f)return[newSplice(b,[],c-b)];for(var k=this.spliceOperationsFromEditDistances(this.calcEditDistances(a,b,c,d,e,f)),j=void 0,l=[],m=b,n=e,o=0;o<k.length;o++)switch(k[o]){case EDIT_LEAVE:j&&(l.push(j),j=void 0),m++,n++;break;case EDIT_UPDATE:j||(j=newSplice(m,[],0)),j.addedCount++,m++,j.removed.push(d[n]),n++;break;case EDIT_ADD:j||(j=newSplice(m,[],0)),j.addedCount++,m++;break;case EDIT_DELETE:j||(j=newSplice(m,[],0)),j.removed.push(d[n]),n++}return j&&l.push(j),l},sharedPrefix:function(a,b,c){for(var d=0;c>d;d++)if(!this.equals(a[d],b[d]))return d;return c},sharedSuffix:function(a,b,c){for(var d=a.length,e=b.length,f=0;c>f&&this.equals(a[--d],b[--e]);)f++;return f},calculateSplices:function(a,b){return this.calcSplices(a,0,a.length,b,0,b.length)},equals:function(a,b){return a===b}};var arraySplice=new ArraySplice,expose=global;"undefined"!=typeof exports&&("undefined"!=typeof module&&module.exports&&(expose=exports=module.exports),expose=exports),expose.Observer=Observer,expose.Observer.runEOM_=runEOM,expose.Observer.observerSentinel_=observerSentinel,expose.Observer.hasObjectObserve=hasObserve,expose.ArrayObserver=ArrayObserver,expose.ArrayObserver.calculateSplices=function(a,b){return arraySplice.calculateSplices(a,b)},expose.Platform=global.Platform,expose.ArraySplice=ArraySplice,expose.ObjectObserver=ObjectObserver,expose.PathObserver=PathObserver,expose.CompoundObserver=CompoundObserver,expose.Path=Path,expose.ObserverTransform=ObserverTransform}("undefined"!=typeof global&&global&&"undefined"!=typeof module&&module?global:this||window)}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{}]},{},[13]),function b(a,c,d){function e(g,h){if(!c[g]){if(!a[g]){var i="function"==typeof require&&require;if(!h&&i)return i(g,!0);if(f)return f(g,!0);var j=new Error("Cannot find module '"+g+"'");throw j.code="MODULE_NOT_FOUND",j}var k=c[g]={exports:{}};a[g][0].call(k.exports,function(b){var c=a[g][1][b];return e(c?c:b)},k,k.exports,b,a,c,d)}return c[g].exports}for(var f="function"==typeof require&&require,g=0;g<d.length;g++)e(d[g]);return e}({1:[function(a,b,c){function d(a){return a?"*"==a||a.indexOf("*")>-1?a=p:i.isArray(a)||(a=[a]):a=["GET"],n.map(a,function(a){return a.toUpperCase()})}function e(a){if(!this)return new e(a);this._rawOpts=m(!0,{},a),this._opts=a;var b=function(a){return a instanceof RegExp||(a=new RegExp(a,"g")),a}.bind(this);if(this._opts.path){var c=this._opts.path;i.isArray(c)||(c=[c]),this._opts.path=[],n.each(c,function(a){this._opts.path.push(b.call(this,a))}.bind(this))}else this._opts.path=[""];if(this._opts.method=d(this._opts.method),!this._opts.model)throw new Error("Descriptors must be initialised with a model",{opts:a,descriptor:this});if("string"==typeof this._opts.model){if(!this._opts.collection)throw new Error("Passed model as string, but did not specify the collection it belongs to",{opts:a,descriptor:this});var f;if(f="string"==typeof this._opts.collection?l[this._opts.collection]:this._opts.collection,!f)throw new Error("Collection "+this._opts.collection+" does not exist",{opts:a,descriptor:this});var g=f[this._opts.model];if(!g)throw new Error("Model "+this._opts.model+" does not exist",{opts:a,descriptor:this});this._opts.model=g}var h=this._opts.data;if(h&&h.length){var j,o=h.split(".");if(1==o.length)j=o[0];else{var p={};j=p;for(var q=o[0],r=1;r<o.length;r++){var s=o[r];if(r==o.length-1)p[q]=s;else{var t={};p[q]=t,p=t,q=s}}}this._opts.data=j}k.call(this,"path",this._opts),k.call(this,"method",this._opts),k.call(this,"model",this._opts),k.call(this,"data",this._opts),k.call(this,"transforms",this._opts)}var f=siesta._internal,g=f.log,h=f.error.InternalSiestaError,i=f.util,j=i.assert,k=i.defineSubProperty,l=f.CollectionRegistry,m=f.extend,n=i._,o=g.loggerWithName("Descriptor"),p=["POST","PATCH","PUT","HEAD","GET","DELETE","OPTIONS","TRACE","CONNECT"];n.extend(e.prototype,{httpMethods:p,_matchPath:function(a){var b;for(b=0;b<this._opts.path.length;b++){var c=this._opts.path[b];o.trace.isEnabled&&o.trace("Matching path",a,c.toString());var d=c.exec(a);if(o.trace.isEnabled&&(d?o.trace("Matched path successfully",a,c.toString()):o.trace("Failed to match path",a,c.toString())),d)return!0}return!1},_matchMethod:function(a){for(var b=0;b<this.method.length;b++)if(a.toUpperCase()==this.method[b])return!0;return!1},bury:function(a,b){var c=b,d=Object.keys(b);j(1==d.length);for(var e=d[0],f=b;"string"!=typeof f[e];)f=f[e],d=Object.keys(f),j(1==d.length),e=d[0];var g=f[e],h={};return f[e]=h,h[g]=a,c},_embedData:function(a){if(this.data){var b;return"string"==typeof this.data?(b={},b[this.data]=a):b=this.bury(a,m(!0,{},this.data)),b}return a},_extractData:function(a){if(o.debug.isEnabled&&o.debug("_extractData",a),this.data){if("string"==typeof this.data)return a[this.data];var b=Object.keys(this.data);j(1==b.length);for(var c=a,d=this.data;"string"!=typeof d;){b=Object.keys(d),j(1==b.length);var e=b[0];if(d=d[e],c=c[e],!c)break}return c?c[d]:null}return a},_matchConfig:function(a){var b=a.type?this._matchMethod(a.type):{};
return b&&(b=a.url?this._matchPath(a.url):{}),b},_matchData:function(a){var b=null;return this.data?a&&(b=this._extractData(a)):b=a,b},match:function(a,b){var c=this._matchConfig(a),d=!!c,e=!1;return d&&(e=this._matchData(b)),e},_transformData:function(a){var b=this.transforms;if("function"==typeof b)a=b(a);else for(var c in b)if(b.hasOwnProperty(c)&&a[c]){var d=b[c],e=a[c];if("string"==typeof d){var f=d.split(".");if(delete a[c],1==f.length)a[f[0]]=e;else{a[f[0]]={};for(var g=a[f[0]],j=1;j<f.length-1;j++){var k=f[j];g[k]={},g=g[k]}g[f[f.length-1]]=e}}else{if("function"!=typeof d)throw new h("Invalid transformer");var l=d(e);i.isArray(l)?(delete a[c],a[l[0]]=l[1]):a[c]=l}}return a}}),c.Descriptor=e,c.resolveMethod=d},{}],2:[function(a,b,c){function d(){return this?(this.requestDescriptors={},void(this.responseDescriptors={})):new d(opts)}function e(a,b){var c=b.model,d=c.collectionName;a[d]||(a[d]=[]),a[d].push(b)}function f(a,b){var c;return c="string"==typeof b?a[b]||[]:a[b.name]||[]}var g=siesta._internal,h=g.util,i=h._,j=g.log,k=j.loggerWithName("Descriptor");i.extend(d.prototype,{registerRequestDescriptor:function(a){e(this.requestDescriptors,a)},registerResponseDescriptor:function(a){k.trace.isEnabled&&k.trace("registerResponseDescriptor"),e(this.responseDescriptors,a)},requestDescriptorsForCollection:function(a){return f(this.requestDescriptors,a)},responseDescriptorsForCollection:function(a){var b=f(this.responseDescriptors,a);return b.length||k.debug.isEnabled&&k.debug("No response descriptors for collection ",this.responseDescriptors),b},reset:function(){this.requestDescriptors={},this.responseDescriptors={}}}),c.DescriptorRegistry=new d},{}],3:[function(a,b){function c(a,b,c){if(z.debug.isEnabled){var d=z.debug,e=a.type+" "+b.status+" "+a.url;z.trace.isEnabled&&c&&(d=z.trace,e+=": "+t.prettyPrint(c)),d(e)}}function d(a){if(z.debug.isEnabled){var b=z.debug,c=a.type+" "+a.url;z.trace.isEnabled&&(b=z.trace),b(c)}}function e(a,b,e,f){var g=this,h=Array.prototype.slice.call(arguments,2),i={},j=this.name;"function"==typeof h[0]?f=h[0]:"object"==typeof h[0]&&(i=h[0],f=h[1]);var k=t.defer();if(i.type=a,!i.url){var l=this.baseURL;i.url=l+b}return void 0===i.parseResponse&&(i.parseResponse=!0),i.success=function(a,b,d){c(i,d,a);var e={data:a,status:b,xhr:d};if(i.parseResponse){for(var h,k,l=y.responseDescriptorsForCollection(g),m=0;m<l.length;m++){var n=l[m];if(k=n.match(i,a)){h=n;break}}if(h)if(z.trace.isEnabled&&z.trace("Model _constructSubOperation data: "+t.prettyPrint(k)),"object"==typeof k){var o=h.model;o.map(k,{override:i.obj},function(a,b){f&&f(a,b,e)})}else f(null,!0,e);else if(f){if(!j)throw new x("Unnamed collection");var p={},q=u.ErrorCode.NoDescriptorMatched;p[u.ErrorField.Code]=q,p[u.ErrorField.Message]=u.Message[q],f(p,null,e)}}else f(null,null,e)},i.error=function(a,b,c){var d={xhr:a,status:b,error:c};f&&f(d,null,d)},d(i),siesta.ext.http.ajax(i),k.promise}function f(a,b,c){this._serialise(b,function(b,d){var e=d;a.fields&&(e={},v.each(a.fields,function(a){e[a]=d[a]})),c(b,e)})}function g(a,b,c){var d,g=this,h=Array.prototype.slice.call(arguments,3),i={};"function"==typeof h[0]?d=h[0]:"object"==typeof h[0]&&(i=h[0],d=h[1]);var j=t.defer(d);d=j.finish.bind(j),h=Array.prototype.slice.call(h,2);var k,l=y.requestDescriptorsForCollection(this);i.type=a;var m=this.baseURL;i.url=m+b;for(var n=0;n<l.length;n++){var o=l[n];if(o._matchConfig(i)){k=o;break}}return k?(z.trace.isEnabled&&z.trace("Matched descriptor: "+k._dump(!0)),f.call(k,c,i,function(f,j){z.trace.isEnabled&&z.trace("_serialise",{err:f,data:j}),f?d&&d(f,null,null):(i.data=j,i.obj=c,v.partial(e,a,b,i,d).apply(g,h))})):d&&(z.trace.isEnabled&&z.trace("Did not match descriptor"),d("No descriptor matched",null,null)),j.promise}function h(a,b){var c,d=Array.prototype.slice.call(arguments,2),f={};"function"==typeof d[0]?c=d[0]:"object"==typeof d[0]&&(f=d[0],c=d[1]);var g=t.defer(c),h=f.deletionMode||"restore";return void 0===f.parseResponse&&(f.parseResponse=!1),e.call(this,"DELETE",a,f,function(a,d,e,f){a?"restore"==h&&b.restore():"success"==h&&b.remove(),c(a,d,e,f),g.finish(a,{x:d,y:e,z:f})}),("now"==h||"restore"==h)&&b.remove(),g.promise}function i(a,b){var c=Array.prototype.slice.call(arguments,2);return v.partial(a?g:e,b).apply(this,c)}function j(){return v.partial(i,!1,"GET").apply(this,arguments)}function k(){return v.partial(i,!1,"OPTIONS").apply(this,arguments)}function l(){return v.partial(i,!1,"TRACE").apply(this,arguments)}function m(){return v.partial(i,!1,"HEAD").apply(this,arguments)}function n(){return v.partial(i,!0,"POST").apply(this,arguments)}function o(){return v.partial(i,!0,"PUT").apply(this,arguments)}function p(){return v.partial(i,!0,"PATCH").apply(this,arguments)}if("undefined"==typeof siesta&&"undefined"==typeof b)throw new Error("Could not find window.siesta. Make sure you include siesta.core.js first.");var q=siesta._internal,r=q.Collection,s=q.log,t=q.util,u=q.error,v=t._,w=a("./descriptor"),x=q.error.InternalSiestaError,y=a("./descriptorRegistry").DescriptorRegistry,z=s.loggerWithName("HTTP"),A={RequestDescriptor:a("./requestDescriptor").RequestDescriptor,ResponseDescriptor:a("./responseDescriptor").ResponseDescriptor,Descriptor:w.Descriptor,_resolveMethod:w.resolveMethod,Serialiser:a("./serialiser"),DescriptorRegistry:a("./descriptorRegistry").DescriptorRegistry,_httpResponse:e,_httpRequest:g,DELETE:h,HTTP_METHOD:i,GET:j,TRACE:l,OPTIONS:k,HEAD:m,POST:n,PUT:o,PATCH:p,_serialiseObject:f,Paginator:a("./paginator")};Object.defineProperty(A,"ajax",{get:function(){var a=B||($?$.ajax:null)||(jQuery?jQuery.ajax:null);if(!a)throw new x("ajax has not been defined and could not find $.ajax or jQuery.ajax");return a},set:function(a){B=a}}),v.extend(r.prototype,{DELETE:h,GET:j,TRACE:l,OPTIONS:k,HEAD:m,POST:n,PUT:o,PATCH:p}),siesta.ext||(siesta.ext={}),siesta.ext.http=A,Object.defineProperties(siesta.ext,{httpEnabled:{get:function(){return void 0!==siesta.ext._httpEnabled?siesta.ext._httpEnabled:!!siesta.ext.http},set:function(a){siesta.ext._httpEnabled=a},enumerable:!0}});var B,C={};v.extend(siesta,{setAjax:function(a){B=a},getAjax:function(){return siesta.ext.http.ajax},serialisers:C,serializers:C}),Object.defineProperties(C,{id:{get:function(){return console.log(siesta.ext.httpEnabled),siesta.ext.httpEnabled?siesta.ext.http.Serialiser.idSerialiser:null}},depth:{get:function(){return siesta.ext.httpEnabled?siesta.ext.http.Serialiser.depthSerializer:null}}}),"undefined"!=typeof b&&(b.exports=A)},{"./descriptor":1,"./descriptorRegistry":2,"./paginator":4,"./requestDescriptor":5,"./responseDescriptor":6,"./serialiser":7}],4:[function(a,b){function c(a){this.opts={},f.extendFromOpts(this.opts,a,{path:"/",model:null,page:"page",queryParams:!0,pageSize:"pageSize",numPages:"numPages",dataPath:"data",count:"count",type:"GET",dataType:"json"},!1),g.extend(this,{numPages:null,count:null}),this.validate()}var d=siesta._internal,e=(d.log,d.error.InternalSiestaError),f=d.util,g=f._,h=a("querystring");g.extend(c.prototype,{_extract:function(a,b,c){if(a)if("function"==typeof a)b=a(b,c);else for(var d=a.split("."),e=0;e<d.length;e++){var f=d[e];b=b[f]}return b},_extractData:function(a,b){return this._extract(this.opts.dataPath,a,b)},_extractNumPages:function(a,b){return this._extract(this.opts.numPages,a,b)},_extractCount:function(a,b){return this._extract(this.opts.count,a,b)},_parseURL:function(a){var b=document.createElement("a");return b.href=a,b},page:function(a,b){var c=this,d={};"function"==typeof a?b=a:a&&(d=a);var e=f.defer(b),i=d.page,j=d.pageSize;b=e.finish.bind(e);var k=siesta.ext.http.ajax,l=g.extend({},this.opts),m=this.opts.model.collection,n=m.baseURL+this.opts.path;if(this.opts.queryParams){var o=this._parseURL(n),p=o.search,q=p.split("?");q.length>1&&(p=q[1]);var r=h.parse(p);i&&(r[this.opts.page]=i),j&&(r[this.opts.pageSize]=j),Object.keys(r).length&&(o.search="?"+h.stringify(r)),n=o.href}else{var s={};i&&(s[this.opts.page]=i),j&&(s[this.opts.pageSize]=j),l.data=s}return g.extend(l,{url:n,success:function(a,d,e){var f=c._extractData(a,e),g=c._extractCount(a,e),h=c._extractNumPages(a,e);c.opts.model.map(f,function(f,i){f?b(f):(c.count=g,c.numPages=h,b(null,i,{data:a,textStatus:d,jqXHR:e}))})},fail:b}),k(l),e.promise},validate:function(){if(!this.opts.model)throw new e("Paginator must have a model")}}),b.exports=c},{querystring:10}],5:[function(a,b,c){function d(a){return this?(e.call(this,a),this._opts.serializer&&(this._opts.serialiser=this._opts.serializer),this._opts.serialiser||(this._opts.serialiser=f.depthSerializer(0)),k.call(this,"serialiser",this._opts),void k.call(this,"serializer",this._opts,"serialiser")):new d(a)}var e=a("./descriptor").Descriptor,f=a("./serialiser"),g=siesta._internal,h=g.util,i=h._,j=g.log,k=h.defineSubProperty,l=j.loggerWithName("Descriptor");d.prototype=Object.create(e.prototype),i.extend(d.prototype,{_serialise:function(a,b){var c=h.defer(b);b=c.finish.bind(c);var d=this;l.trace.isEnabled&&l.trace("_serialise");var e,f=this.serialiser(a,function(a,c){e||(c=d._transformData(c),b&&b(a,d._embedData(c)))});return void 0!==f?(l.trace.isEnabled&&l.trace("serialiser doesnt use a callback"),e=!0,f=d._transformData(f),b&&b(null,d._embedData(f))):l.trace.isEnabled&&l.trace("serialiser uses a callback",this.serialiser),c.promise},_dump:function(a){var b={};b.methods=this.method,b.model=this.model.name,b.path=this._rawOpts.path;var c;c="function"==typeof this._rawOpts.serialiser?"function () { ... }":this._rawOpts.serialiser,b.serialiser=c;var d={};for(var e in this.transforms)if(this.transforms.hasOwnProperty(e)){var f=this.transforms[e];d[e]="function"==typeof f?"function () { ... }":this.transforms[e]}return b.transforms=d,a?h.prettyPrint(b):b}}),c.RequestDescriptor=d},{"./descriptor":1,"./serialiser":7}],6:[function(a,b,c){function d(a){return this?void e.call(this,a):new d(a)}var e=a("./descriptor").Descriptor;d.prototype=Object.create(e.prototype),_.extend(d.prototype,{_extractData:function(a){var b=e.prototype._extractData.call(this,a);return b&&(b=this._transformData(b)),b},_matchData:function(a){var b=e.prototype._matchData.call(this,a);return b&&(b=this._transformData(b)),b},_dump:function(a){var b={};b.methods=this.method,b.model=this.model.name,b.path=this._rawOpts.path;var c={};for(var d in this.transforms)if(this.transforms.hasOwnProperty(d)){var e=this.transforms[d];c[d]="function"==typeof e?"function () { ... }":this.transforms[d]}return b.transforms=c,a?util.prettyPrint(b):b}}),c.ResponseDescriptor=d},{"./descriptor":1}],7:[function(a,b,c){function d(a){var b=a.model.id;return b?a[b]?a[b]:null:void(i.debug.isEnabled&&i.debug("No idfield"))}function e(a,b,c){c=c||function(){},i.trace.isEnabled&&i.trace("depthSerialiser");var d={};j.each(b._attributeNames,function(a){i.trace.isEnabled&&i.trace("field",a),b[a]&&(d[a]=b[a])});var f=[],g=[],h={},k=[];j.each(b._relationshipNames,function(j){i.trace.isEnabled&&i.trace("relationshipField",j);var l=b.__proxies[j];l.isForward&&(i.debug.isEnabled&&i.debug(j),f.push(j),l.get(function(l,m){i.trace.isEnabled&&i.trace("proxy.get",j),i.debug.isEnabled&&i.debug(j,m),l?(g.push(l),k.push(j),h[j]={err:l,v:m}):m?a?e(a-1,m,function(a,b,e){a?g.push(a):d[j]=b,k.push(j),h[j]={err:a,v:m,resp:e},f.length==k.length&&c&&c(g.length?g:null,d,h)}):(k.push(j),d[j]=m[b.__proxies[j].forwardModel.id],h[j]={err:l,v:m},f.length==k.length&&c&&c(g.length?g:null,d,h)):(i.debug.isEnabled&&i.debug("no value for "+j),k.push(j),h[j]={err:l,v:m},f.length==k.length&&c&&c(g.length?g:null,d,h))}))}),f.length||c(null,d,{})}var f=siesta._internal,g=f.log,h=f.util,i=g.loggerWithName("Serialisation"),j=h._;c.depthSerialiser=function(a){return j.partial(e,a)},c.depthSerializer=function(a){return j.partial(e,a)},c.idSerializer=d,c.idSerialiser=d},{}],8:[function(a,b){"use strict";function c(a,b){return Object.prototype.hasOwnProperty.call(a,b)}b.exports=function(a,b,e,f){b=b||"&",e=e||"=";var g={};if("string"!=typeof a||0===a.length)return g;var h=/\+/g;a=a.split(b);var i=1e3;f&&"number"==typeof f.maxKeys&&(i=f.maxKeys);var j=a.length;i>0&&j>i&&(j=i);for(var k=0;j>k;++k){var l,m,n,o,p=a[k].replace(h,"%20"),q=p.indexOf(e);q>=0?(l=p.substr(0,q),m=p.substr(q+1)):(l=p,m=""),n=decodeURIComponent(l),o=decodeURIComponent(m),c(g,n)?d(g[n])?g[n].push(o):g[n]=[g[n],o]:g[n]=o}return g};var d=Array.isArray||function(a){return"[object Array]"===Object.prototype.toString.call(a)}},{}],9:[function(a,b){"use strict";function c(a,b){if(a.map)return a.map(b);for(var c=[],d=0;d<a.length;d++)c.push(b(a[d],d));return c}var d=function(a){switch(typeof a){case"string":return a;case"boolean":return a?"true":"false";case"number":return isFinite(a)?a:"";default:return""}};b.exports=function(a,b,g,h){return b=b||"&",g=g||"=",null===a&&(a=void 0),"object"==typeof a?c(f(a),function(f){var h=encodeURIComponent(d(f))+g;return e(a[f])?c(a[f],function(a){return h+encodeURIComponent(d(a))}).join(b):h+encodeURIComponent(d(a[f]))}).join(b):h?encodeURIComponent(d(h))+g+encodeURIComponent(d(a)):""};var e=Array.isArray||function(a){return"[object Array]"===Object.prototype.toString.call(a)},f=Object.keys||function(a){var b=[];for(var c in a)Object.prototype.hasOwnProperty.call(a,c)&&b.push(c);return b}},{}],10:[function(a,b,c){"use strict";c.decode=c.parse=a("./decode"),c.encode=c.stringify=a("./encode")},{"./decode":8,"./encode":9}]},{},[3]),function c(a,b,d){function e(g,h){if(!b[g]){if(!a[g]){var i="function"==typeof require&&require;if(!h&&i)return i(g,!0);if(f)return f(g,!0);var j=new Error("Cannot find module '"+g+"'");throw j.code="MODULE_NOT_FOUND",j}var k=b[g]={exports:{}};a[g][0].call(k.exports,function(b){var c=a[g][1][b];return e(c?c:b)},k,k.exports,c,a,b,d)}return b[g].exports}for(var f="function"==typeof require&&require,g=0;g<d.length;g++)e(d[g]);return e}({1:[function(a,b){function c(a){var b=siesta._.extend({},a.__values);b.collection=a.collectionName,b.model=a.modelName,b._id=a._id,a.removed&&(b._deleted=!0);var c=a._rev;return c&&(b._rev=c),b=n.reduce(a._relationshipNames,function(b,c){var d=a[c];return siesta.isArray(d)?b[c]=n.pluck(d,"_id"):d&&(b[c]=d._id),b},b)}function d(a,b){delete a.collection,delete a.model;var c=b._relationshipNames;return n.each(c,function(b){var c=a[b];a[b]=siesta.isArray(c)?n.map(c,function(a){return{_id:a}}):{_id:c}}),a}function e(a,b){var c=a.collectionName,e=a.modelName;if(v.trace){var f=c+"."+e;v.trace("Loading instances for "+f)}var g=k[c][e],h=function(a){"$1"==a.model&&"$2"==a.collection&&emit(a._id,a)}.toString().replace("$1",e).replace("$2",c);v.trace.isEnabled&&v.trace("Querying pouch"),q.query({map:h}).then(function(a){v.trace.isEnabled&&v.trace("Queried pouch succesffully");var c=siesta._.map(siesta._.pluck(a.rows,"value"),function(a){return d(a,g)});v.trace.isEnabled&&v.trace("Mapping data",c),g.map(c,{disableevents:!0,_ignoreInstalled:!0},function(a,c){a?v.error("Error loading models",a):v.trace&&v.trace("Loaded "+c.length.toString()+" instances for "+f),b(a,c)})}).catch(function(a){b(a)})}function f(a){var b=m.defer(a),c=k.collectionNames,d=[];return n.each(c,function(a){var b=k[a],c=Object.keys(b._models);n.each(c,function(b){d.push(function(c){e({collectionName:a,modelName:b},c)})})}),siesta.async.parallel(d,function(a,c){if(!a){var d=[];siesta._.each(c,function(a){d.concat(a)}),v.trace&&v.trace("Loaded "+d.length.toString()+" instances")}b.finish(a)}),b.promise}function g(a,b,c){q.allDocs({keys:n.pluck(a,"_id")}).then(function(d){for(var e=0;e<d.rows.length;e++)a[e]._rev=d.rows[e].value.rev;h(a,b,c)}).catch(function(a){c.reject(a)})}function h(a,b,d){var e=[];q.bulkDocs(n.map(a,c)).then(function(c){for(var f=0;f<c.length;f++){var h=c[f],i=a[f];h.ok?i._rev=h.rev:409==h.status?e.push(i):v.error('Error saving object with _id="'+i._id+'"',h)}e.length?g(e,b,d):(b(),d&&d.resolve())},function(a){b(a),d&&d.reject(a)})}function i(a){var b=m.defer(a);return siesta._afterInstall(function(){a=a||function(){};var c=r;r=[],s={},t={},v.trace&&v.trace("Saving objects",n.map(c,function(a){return a._dump()})),h(c,a,b)}),b.promise}if("undefined"==typeof siesta&&"undefined"==typeof b)throw new Error("Could not find window.siesta. Make sure you include siesta.core.js first.");var j=siesta._internal,k=(j.cache,j.CollectionRegistry),l=j.log,m=j.util,n=m._,o=j.events,p="siesta",q=new PouchDB(p),r=[],s={},t={},u={},v=l.loggerWithName("Storage");v.setLevel(siesta.log.warn);var w=function(a){var b=a.obj,c=b._id;if(!b)throw new j.error.InternalSiestaError("No obj field in notification received by storage extension");if(!(c in s)){s[c]=b,r.push(b);var d=b.collectionName;t[d]||(t[d]={});var e=b.model.name;t[d][e]||(t[d][e]={}),t[d][e][c]=b}};siesta.on("Siesta",w),n.extend(u,{_load:f,save:i,_serialise:c,_reset:function(a){siesta.removeListener("Siesta",w),r=[],s={},q.destroy(function(b){b||(q=new PouchDB(p)),siesta.on("Siesta",w),v.warn("Reset complete"),a(b)})}}),Object.defineProperties(u,{_unsavedObjects:{get:function(){return r}},_unsavedObjectsHash:{get:function(){return s}},_unsavedObjectsByCollection:{get:function(){return t}},_pouch:{get:function(){return q}}}),siesta.ext||(siesta.ext={}),siesta.ext.storage=u,Object.defineProperties(siesta.ext,{storageEnabled:{get:function(){return void 0!==siesta.ext._storageEnabled?siesta.ext._storageEnabled:!!siesta.ext.storage},set:function(a){siesta.ext._storageEnabled=a},enumerable:!0}});var x,y,z=1e3;Object.defineProperties(siesta,{autosave:{get:function(){return!!x},set:function(a){a?x||(x=setInterval(function(){y||(y=!0,siesta.save(function(a){a||o.emit("saved"),y=!1}))},siesta.autosaveInterval)):x&&(clearInterval(x),x=null)}},autosaveInterval:{get:function(){return z},set:function(a){z=a,x&&(siesta.autosave=!1,siesta.autosave=!0)}},dirty:{get:function(){var a=siesta.ext.storage._unsavedObjectsByCollection;return!!Object.keys(a).length},enumerable:!0}}),n.extend(siesta,{save:i,setPouch:function(a){if(!siesta._canChange)throw new Error("Cannot change PouchDB instance when an object graph exists.");q=a}}),"undefined"==typeof PouchDB&&(siesta.ext.storageEnabled=!1,v.error("Storage extension is present but could not find PouchDB. Have you included pouchdb.js in your project? It must be present at window.PouchDB!")),b.exports=u},{}]},{},[1]);