!function a(b,c,d){function e(g,h){if(!c[g]){if(!b[g]){var i="function"==typeof require&&require;if(!h&&i)return i(g,!0);if(f)return f(g,!0);var j=new Error("Cannot find module '"+g+"'");throw j.code="MODULE_NOT_FOUND",j}var k=c[g]={exports:{}};b[g][0].call(k.exports,function(a){var c=b[g][1][a];return e(c?c:a)},k,k.exports,a,b,c,d)}return c[g].exports}for(var f="function"==typeof require&&require,g=0;g<d.length;g++)e(d[g]);return e}({1:[function(a,b){!function(){function c(a){d.call(this,a),this.indexAttribute="index"}{var d=a("./ReactiveQuery"),e=a("./log"),f=a("./util"),g=a("./error"),h=a("./modelEvents"),i=g.InternalSiestaError,j=a("./QuerySet"),k=f._;e("Query")}c.prototype=Object.create(d.prototype),k.extend(c.prototype,{_refreshIndexes:function(){var a=this.results,b=this.indexAttribute;if(!a)throw new i("ArrangedReactiveQuery must be initialised");for(var c=0;c<a.length;c++){var d=a[c];d[b]=c}},_mergeIndexes:function(){for(var a=this.results,b=[],c=[],d=[],e=0;e<a.length;e++){var f=a[e],g=f[this.indexAttribute];void 0==g?d.push(f):g>a.length?c.push(f):b[g]?d.push(f):b[g]=f}for(c=k.sortBy(c,function(a){return a[this.indexAttribute]}.bind(this)),e=0;e<c.length;e++){f=c[e];var h=this.results.length-c.length+e;f[this.indexAttribute]=h,b[h]=f}d=this._query._sortResults(d);for(var i=0;d.length;){for(f=d.shift();b[i];)i++;b[i]=f,f[this.indexAttribute]=i}this.results=j(b,this.model)},init:function(a){return f.promise(a,function(a){d.prototype.init.call(this,function(b){b||(this.model.hasAttributeNamed(this.indexAttribute)?(this._mergeIndexes(),this._query.clearOrdering()):b=g('Model "'+this.model.name+'" does not have an attribute named "'+this.indexAttribute+'"')),a(b,b?null:this.results)}.bind(this))}.bind(this))},_handleNotif:function(a){a.field!=this.indexAttribute&&(d.prototype._handleNotif.call(this,a),this._refreshIndexes())},validateIndex:function(a){var b=this.results.length-1,c=0;if(!(a>=c&&b>=a))throw new Error("Index "+a.toString()+" is out of bounds")},swapObjectsAtIndexes:function(a,b){this.validateIndex(a),this.validateIndex(b);var c=this.results[a],d=this.results[b];if(!c)throw new Error('No model at index "'+a.toString()+'"');if(!d)throw new Error('No model at index "'+b.toString()+'"');this.results[b]=c,this.results[a]=d,c[this.indexAttribute]=b,d[this.indexAttribute]=a},swapObjects:function(a,b){var c=this.results.indexOf(a),d=this.results.indexOf(b);this.swapObjectsAtIndexes(c,d)},move:function(a,b){this.validateIndex(a),this.validateIndex(b);var c=this.results.mutableCopy();(function(a,b){if(b>=this.length)for(var c=b-this.length;c--+1;)this.push(void 0)}).call(c,a,b);var d=c.splice(a,1)[0];this.results=c.asModelQuerySet(this.model),this.emit("change",{index:a,removed:[d],type:h.ModelEventType.Splice,obj:this,field:"results"}),c.splice(b,0,d),this.results=c.asModelQuerySet(this.model),this.emit("change",{index:b,added:[d],type:h.ModelEventType.Splice,obj:this,field:"results"}),this._refreshIndexes()}}),b.exports=c}()},{"./QuerySet":7,"./ReactiveQuery":8,"./error":14,"./log":18,"./modelEvents":21,"./util":24}],2:[function(a,b){!function(){function c(a){d.call(this,a),this.related=[],this.relatedCancelListeners={}}var d=a("./RelationshipProxy"),e=(a("./store"),a("./util")),f=e._,g=(a("./error").InternalSiestaError,a("./modelEvents")),h=a("./events"),i=h.wrapArray,j=(a("./ModelInstance"),a("../vendor/observe-js/src/observe").ArrayObserver),k=a("./modelEvents").ModelEventType;c.prototype=Object.create(d.prototype),f.extend(c.prototype,{clearReverse:function(a){var b=this;f.each(a,function(a){var c=b.reverseProxyForInstance(a),d=c.related.indexOf(b.object);c.makeChangesToRelatedWithoutObservations(function(){c.splice(d,1)})})},setReverseOfAdded:function(a){var b=this;f.each(a,function(a){var c=b.reverseProxyForInstance(a);c.makeChangesToRelatedWithoutObservations(function(){c.splice(0,0,b.object)})})},wrapArray:function(a){var b=this;if(i(a,this.reverseName,this.object),!a.arrayObserver){a.arrayObserver=new j(a);var c=function(c){c.forEach(function(c){var d=c.addedCount?a.slice(c.index,c.index+c.addedCount):[],e=c.removed;b.clearReverse(e),b.setReverseOfAdded(d);var f=b.getForwardModel();g.emit({collection:f.collectionName,model:f.name,_id:b.object._id,field:b.getForwardName(),removed:e,added:d,type:k.Splice,index:c.index,obj:b.object})})};a.arrayObserver.open(c)}},get:function(a){return e.promise(a,function(a){a(null,this.related)}.bind(this))},validate:function(a){return"[object Array]"!=Object.prototype.toString.call(a)?"Cannot assign scalar to many to many":null},set:function(a,b){this.checkInstalled();var c=this;if(a){var d;if(d=this.validate(a))return d;this.clearReverseRelated(b),c.setIdAndRelated(a,b),this.wrapArray(a),c.setIdAndRelatedReverse(a,b)}else this.clearReverseRelated(b),c.setIdAndRelated(a,b)},install:function(a){d.prototype.install.call(this,a),this.wrapArray(this.related),a["splice"+e.capitaliseFirstLetter(this.reverseName)]=f.bind(this.splice,this)},registerRemovalListener:function(a){this.relatedCancelListeners[a._id]=a.listen(function(){}.bind(this))}}),b.exports=c}()},{"../vendor/observe-js/src/observe":53,"./ModelInstance":3,"./RelationshipProxy":9,"./error":14,"./events":15,"./modelEvents":21,"./store":22,"./util":24}],3:[function(a,b){!function(){function c(a){var b=this;this.model=a,d.subProperties(this,this.model,["collection","collectionName","_attributeNames",{name:"idField",property:"id"},{name:"modelName",property:"name"}]),h.ProxyEventEmitter.call(this),Object.defineProperties(this,{_relationshipNames:{get:function(){var a=e.map(Object.keys(b.__proxies||{}),function(a){return b.__proxies[a]});return e.map(a,function(a){return a.isForward?a.forwardName:a.reverseName})},enumerable:!0,configurable:!0},dirty:{get:function(){return siesta.ext.storageEnabled?b._id in siesta.ext.storage._unsavedObjectsHash:void 0},enumerable:!0},event:{get:function(){return this._id}}}),this.removed=!1}var d=(a("./log"),a("./util")),e=d._,f=a("./error"),g=(f.InternalSiestaError,a("./modelEvents")),h=a("./events"),i=a("./cache");c.prototype=Object.create(h.ProxyEventEmitter.prototype),e.extend(c.prototype,{get:function(a){return d.promise(a,function(a){a(null,this)}.bind(this))},emit:function(a,b){"object"==typeof a?b=a:b.type=a,b=b||{},e.extend(b,{collection:this.collectionName,model:this.model.name,_id:this._id,obj:this}),g.emit(b)},remove:function(a,b){return b=null==b?!0:b,d.promise(a,function(a){i.remove(this),this.removed=!0,b&&this.emit(g.ModelEventType.Remove,{old:this});var c=this.model.remove;if(c){var e=d.paramNames(c);if(e.length){var f=this;c.call(this,function(b){a(b,f)})}else c.call(this),a(null,this)}else a(null,this)}.bind(this))},restore:function(a){return d.promise(a,function(a){var b=function(b){b||this.emit(g.ModelEventType.New,{"new":this}),a(b,this)}.bind(this);if(this.removed){i.insert(this),this.removed=!1;var c=this.model.init;if(c){var e=d.paramNames(c),f=!0;e.length>1?c.call(this,f,b):(c.call(this,f),b())}else b()}}.bind(this))}}),e.extend(c.prototype,{getAttributes:function(){return e.extend({},this.__values)},isInstanceOf:function(a){return this.model==a},isA:function(a){return this.model==a||this.model.isDescendantOf(a)}}),e.extend(c.prototype,{_dumpString:function(a){return JSON.stringify(this._dump(a,null,4))},_dump:function(){var a=e.extend({},this.__values);return a._rev=this._rev,a._id=this._id,a}}),b.exports=c}()},{"./cache":11,"./error":14,"./events":15,"./log":18,"./modelEvents":21,"./util":24}],4:[function(a,b){!function(){function c(a){d.call(this,a),this.isReverse&&(this.related=[])}var d=a("./RelationshipProxy"),e=(a("./store"),a("./util")),f=e._,g=(a("./error").InternalSiestaError,a("./modelEvents")),h=a("./events"),i=h.wrapArray,j=a("../vendor/observe-js/src/observe").ArrayObserver,k=a("./modelEvents").ModelEventType;c.prototype=Object.create(d.prototype),f.extend(c.prototype,{clearReverse:function(a){var b=this;f.each(a,function(a){var c=b.reverseProxyForInstance(a);c.setIdAndRelated(null)})},setReverseOfAdded:function(a){var b=this;f.each(a,function(a){var c=b.reverseProxyForInstance(a);c.setIdAndRelated(b.object)})},wrapArray:function(a){var b=this;if(i(a,this.reverseName,this.object),!a.arrayObserver){a.arrayObserver=new j(a);var c=function(c){c.forEach(function(c){var d=c.addedCount?a.slice(c.index,c.index+c.addedCount):[],e=c.removed;b.clearReverse(e),b.setReverseOfAdded(d);var f=b.getForwardModel();g.emit({collection:f.collectionName,model:f.name,_id:b.object._id,field:b.getForwardName(),removed:e,added:d,type:k.Splice,index:c.index,obj:b.object})})};a.arrayObserver.open(c)}},get:function(a){return e.promise(a,function(a){a(null,this.related)}.bind(this))},validate:function(a){var b=Object.prototype.toString.call(a);if(this.isForward){if("[object Array]"==b)return"Cannot assign array forward oneToMany ("+b+"): "+this.forwardName}else if("[object Array]"!=b)return"Cannot scalar to reverse oneToMany ("+b+"): "+this.reverseName;return null},set:function(a,b){this.checkInstalled();var c=this;if(a){var d;if(d=this.validate(a))return d;this.clearReverseRelated(b),c.setIdAndRelated(a,b),c.isReverse&&this.wrapArray(c.related),c.setIdAndRelatedReverse(a,b)}else this.clearReverseRelated(b),c.setIdAndRelated(a,b)},install:function(a){d.prototype.install.call(this,a),this.isReverse&&(a["splice"+e.capitaliseFirstLetter(this.reverseName)]=f.bind(this.splice,this),this.wrapArray(this.related))}}),b.exports=c}()},{"../vendor/observe-js/src/observe":53,"./RelationshipProxy":9,"./error":14,"./events":15,"./modelEvents":21,"./store":22,"./util":24}],5:[function(a,b){!function(){function c(a){d.call(this,a)}{var d=a("./RelationshipProxy"),e=a("./util"),f=e._;a("./ModelInstance")}c.prototype=Object.create(d.prototype),f.extend(c.prototype,{validate:function(a){return"[object Array]"==Object.prototype.toString.call(a)?"Cannot assign array to one to one relationship":null},set:function(a,b){if(this.checkInstalled(),a){var c;if(c=this.validate(a))return c;this.clearReverseRelated(b),this.setIdAndRelated(a,b),this.setIdAndRelatedReverse(a,b)}else this.clearReverseRelated(b),this.setIdAndRelated(a,b)},get:function(a){return e.promise(a,function(a){a(null,this.related)}.bind(this))}}),b.exports=c}()},{"./ModelInstance":3,"./RelationshipProxy":9,"./util":24}],6:[function(a,b){!function(){function c(a,b){var c={};for(var d in b)b.hasOwnProperty(d)&&"__"==d.slice(0,2)&&(c[d.slice(2)]=b[d],delete b[d]);j.extend(this,{model:a,query:b,opts:c}),c.order=c.order||[],g.isArray(c.order)||(c.order=[c.order])}function d(a){var b,c=f._localCacheByType,d=a.name,e=a.collectionName,g=c[e];return g&&(b=g[d]||{}),b}var e=a("./log")("Query"),f=a("./cache"),g=a("./util"),h=a("./error"),i=a("./QuerySet"),j=g._,k={e:function(a){var b=a.object[a.field];if(e.enabled){var c;c=null===b?"null":void 0===b?"undefined":b.toString(),e(a.field+": "+c+" == "+a.value.toString())}return b==a.value},lt:function(a){return a.invalid?!1:a.object[a.field]<a.value},gt:function(a){return a.invalid?!1:a.object[a.field]>a.value},lte:function(a){return a.invalid?!1:a.object[a.field]<=a.value},gte:function(a){return a.invalid?!1:a.object[a.field]>=a.value},contains:function(a){if(!a.invalid){var b=a.object[a.field];if(g.isArray(b)||g.isString(b))return b.indexOf(a.value)>-1}return!1}};j.extend(c,{comparators:k,registerComparator:function(a,b){k[a]||(k[a]=b)}}),j.extend(c.prototype,{execute:function(a){return g.promise(a,function(a){this._executeInMemory(a)}.bind(this))},_dump:function(a){return a?"{}":{}},sortFunc:function(a){for(var b=function(a,b){return function(c,d){var e,f=c[b],g=d[b];return"string"==typeof f||f instanceof String&&"string"==typeof g||g instanceof String?e=a?f.localeCompare(g):g.localeCompare(f):(f instanceof Date&&(f=f.getTime()),g instanceof Date&&(g=g.getTime()),e=a?f-g:g-f),e}},c=g,d=0;d<a.length;d++){var e=a[d];c=c.thenBy(b(e.ascending,e.field))}return c==g?null:c},_sortResults:function(a){var b=this.opts.order;if(a&&b){var c=j.map(b,function(a){var b=a.split("-"),c=!0,d=null;return b.length>1?(d=b[1],c=!1):d=b[0],{field:d,ascending:c}}.bind(this)),d=this.sortFunc(c);a.immutable&&(a=a.mutableCopy()),d&&a.sort(d)}return a},_getCacheByLocalId:function(){return j.reduce(this.model.descendants,function(a,b){return j.extend(a,d(b))},j.extend({},d(this.model)))},_executeInMemory:function(a){var b=function(){for(var b,c=this._getCacheByLocalId(),d=Object.keys(c),f=this,g=[],j=0;j<d.length;j++){var k=d[j],l=c[k],m=f.objectMatchesQuery(l);if("string"==typeof m){b=h(m);break}m&&g.push(l)}g=this._sortResults(g),b&&e("Error executing query",b),a(b,b?null:i(g,this.model))}.bind(this);this.opts.ignoreInstalled?b():siesta._afterInstall(b)},clearOrdering:function(){this.opts.order=null},objectMatchesOrQuery:function(a,b){for(var c in b)if(b.hasOwnProperty(c)){var d=b[c];if(this.objectMatchesBaseQuery(a,d))return!0}return!1},objectMatchesAndQuery:function(a,b){for(var c in b)if(b.hasOwnProperty(c)){var d=b[c];if(!this.objectMatchesBaseQuery(a,d))return!1}return!0},splitMatches:function(a,b,d){var e="e",f=b.split("."),g=f[f.length-1].split("__");if(2==g.length){var h=g[0];e=g[1]}else h=g[0];f[f.length-1]=h,j.each(f.slice(0,f.length-1),function(b){a=a[b]});var i=void 0!=a;if(i){var k=a[h],l=null===k||void 0===k,m=c.comparators[e],n={object:a,field:h,value:d,invalid:l};return m?m(n):'No comparator registered for query operation "'+e+'"'}return!1},objectMatches:function(a,b,c,d){if("$or"==b){if(!this.objectMatchesOrQuery(a,d.$or))return!1}else if("$and"==b){if(!this.objectMatchesAndQuery(a,d.$and))return!1}else{var e=this.splitMatches(a,b,c);if("boolean"!=typeof e)return e;if(!e)return!1}return!0},objectMatchesBaseQuery:function(a,b){for(var c=Object.keys(b),d=0;d<c.length;d++){var e=c[d],f=b[e],g=this.objectMatches(a,e,f,b);if("boolean"!=typeof g)return g;if(!g)return!1}return!0},objectMatchesQuery:function(a){return this.objectMatchesBaseQuery(a,this.query)}}),b.exports=c}()},{"./QuerySet":7,"./cache":11,"./error":14,"./log":18,"./util":24}],7:[function(a,b){function c(a){var b;return b="string"==typeof a||a instanceof String?r.concat(s):"number"==typeof a||a instanceof Number?p.concat(q):a.getOwnPropertyNames()}function d(a,b){b in a||Object.defineProperty(a,b,{get:function(){return h(n.pluck(a,b))},set:function(a){if(k.isArray(a)){if(this.length!=a.length)throw l({message:"Must be same length"});for(var c=0;c<a.length;c++)this[c][b]=a[c]}else for(c=0;c<this.length;c++)this[c][b]=a}})}function e(a){return a.then&&a.catch}function f(a,b){b in a||(a[b]=function(){var a=arguments,c=this.map(function(c){return c[b].apply(c,a)}),d=!1;return c.length&&(d=e(c[0])),d?siesta.q.all(c):h(c)})}function g(a,b){a=n.extend([],a);var c=b._attributeNames,e=b._relationshipNames,g=c.concat(e).concat(h);g.forEach(n.partial(d,a));var h=Object.keys(m.prototype);return h.forEach(n.partial(f,a)),j(a)}function h(a){if(a.length){var b=a[0],e=c(b);e.forEach(function(c){"function"==typeof b[c]?f(a,c,arguments):d(a,c)})}return j(a)}function i(){throw new Error("Cannot modify a query set")}function j(a){return o.forEach(function(b){a[b]=i}),a.immutable=!0,a.mutableCopy=a.asArray=function(){var a=n.map(this,function(a){return a});return a.asQuerySet=function(){return h(this)},a.asModelQuerySet=function(a){return g(this,a)},a},a}var k=a("./util"),l=a("./error"),m=a("./ModelInstance"),n=a("./util")._,o=["push","sort","reverse","splice","shift","unshift"],p=["toString","toExponential","toFixed","toPrecision","valueOf"],q=["MAX_VALUE","MIN_VALUE","NEGATIVE_INFINITY","NaN","POSITIVE_INFINITY"],r=["charAt","charCodeAt","concat","fromCharCode","indexOf","lastIndexOf","localeCompare","match","replace","search","slice","split","substr","substring","toLocaleLowerCase","toLocaleUpperCase","toLowerCase","toString","toUpperCase","trim","valueOf"],s=["length"];b.exports=g},{"./ModelInstance":3,"./error":14,"./util":24}],8:[function(a,b){!function(){function c(a){var b=this;e.call(this),k.extend(this,{_query:a,results:i([],a.model),insertionPolicy:c.InsertionPolicy.Back,initialised:!1}),Object.defineProperties(this,{initialized:{get:function(){return this.initialised}},model:{get:function(){return b._query.model}},collection:{get:function(){return b.model.collectionName}}})}var d=a("./log")("Query"),e=(a("./Query"),a("events").EventEmitter),f=a("./events"),g=a("./modelEvents"),h=a("./error").InternalSiestaError,i=a("./QuerySet"),j=a("./util"),k=j._;c.prototype=Object.create(e.prototype),k.extend(c,{InsertionPolicy:{Front:"Front",Back:"Back"}}),k.extend(c.prototype,{init:function(a,b){return d&&d("init"),j.promise(a,function(a){!this.initialised||b?this._query.execute(function(b,c){if(b)a(b);else{if(this.results=c,!this.handler){var e=this._constructNotificationName(),g=function(a){this._handleNotif(a)}.bind(this);this.handler=g,f.on(e,g)}d&&d("Listening to "+e),this.initialised=!0,a(null,this.results)}}.bind(this)):a(null,this.results)}.bind(this))},insert:function(a){var b=this.results.mutableCopy();if(this.insertionPolicy==c.InsertionPolicy.Back)var d=b.push(a);else d=b.unshift(a);return this.results=b.asModelQuerySet(this.model),d},update:function(a){return this.init(a,!0)},_handleNotif:function(a){if(d("_handleNotif",a),a.type==g.ModelEventType.New){var b=a.new;if(this._query.objectMatchesQuery(b)){d("New object matches",b._dumpString());var c=this.insert(b);this.emit("change",{index:c,added:[b],type:g.ModelEventType.Splice,obj:this})}else d("New object does not match",b._dumpString())}else if(a.type==g.ModelEventType.Set){b=a.obj;var e=this.results.indexOf(b),f=e>-1,j=this._query.objectMatchesQuery(b);if(j&&!f)d("Updated object now matches!",b._dumpString()),c=this.insert(b),this.emit("change",{index:c,added:[b],type:g.ModelEventType.Splice,obj:this});else if(!j&&f){d("Updated object no longer matches!",b._dumpString()),l=this.results.mutableCopy();var k=l.splice(e,1);this.results=l.asModelQuerySet(this.model),this.emit("change",{index:e,obj:this,"new":b,type:g.ModelEventType.Splice,removed:k})}else j||f?j&&f&&(d("Matches but already contains",b._dumpString()),this.emit("change",a)):d("Does not contain, but doesnt match so not inserting",b._dumpString())}else{if(a.type!=g.ModelEventType.Remove)throw new h('Unknown change type "'+a.type.toString()+'"');b=a.obj;var l=this.results.mutableCopy();e=l.indexOf(b),e>-1?(d("Removing object",b._dumpString()),k=l.splice(e,1),this.results=i(l,this.model),this.emit("change",{index:e,obj:this,type:g.ModelEventType.Splice,removed:k})):d("No modelEvents neccessary.",b._dumpString())}this.results=i(this._query._sortResults(this.results),this.model)},_constructNotificationName:function(){return this.model.collectionName+":"+this.model.name},terminate:function(){this.handler&&f.removeListener(this._constructNotificationName(),this.handler),this.results=null,this.handler=null},listen:function(a){return this.on("change",a),function(){this.removeListener("change",a)}.bind(this)},listenOnce:function(a){this.once("change",a)}}),b.exports=c}()},{"./Query":6,"./QuerySet":7,"./error":14,"./events":15,"./log":18,"./modelEvents":21,"./util":24,events:29}],9:[function(a,b){!function(){function c(a){var b=this;a=a||{},f.extend(this,{object:null,related:null}),Object.defineProperties(this,{isForward:{get:function(){return!b.isReverse},set:function(a){b.isReverse=!a},enumerable:!0}}),e.extendFromOpts(this,a,{reverseModel:null,forwardModel:null,forwardName:null,reverseName:null,isReverse:null}),this.cancelListens={}}var d=a("./error").InternalSiestaError,e=(a("./store"),a("./util")),f=e._,g=(a("./Query"),a("./log"),a("./cache"),a("./events")),h=g.wrapArray,i=a("../vendor/observe-js/src/observe").ArrayObserver,j=a("./modelEvents"),k=j.ModelEventType;f.extend(c,{}),f.extend(c.prototype,{install:function(a){if(!a)throw new d("No object passed to relationship install");if(this.object)throw new d("Already installed.");this.object=a;var b=this,c=this.getForwardName();Object.defineProperty(a,c,{get:function(){return b.related},set:function(a){b.set(a)},configurable:!0,enumerable:!0}),a.__proxies||(a.__proxies={}),a.__proxies[c]=this,a._proxies||(a._proxies=[]),a._proxies.push(this)}}),f.extend(c.prototype,{set:function(){throw new d("Must subclass RelationshipProxy")},get:function(){throw new d("Must subclass RelationshipProxy")}}),f.extend(c.prototype,{proxyForInstance:function(a,b){var c,g=b?this.getReverseName():this.getForwardName(),h=b?this.reverseModel:this.forwardModel;if(e.isArray(a))c=f.map(a,function(a){return a.__proxies[g]});else{var i=a.__proxies[g];if(!i){var j='No proxy with name "'+g+'" on mapping '+h.name;throw new d(j)}c=i}return c},reverseProxyForInstance:function(a){return this.proxyForInstance(a,!0)},getReverseName:function(){return this.isForward?this.reverseName:this.forwardName},getForwardName:function(){return this.isForward?this.forwardName:this.reverseName},getForwardModel:function(){return this.isForward?this.forwardModel:this.reverseModel},clearRemovalListener:function(a){var b=a._id,c=this.cancelListens[b];c&&(c(),this.cancelListens[b]=null)},listenForRemoval:function(a){this.cancelListens[a._id]=a.listen(function(b){if(b.type==k.Remove){if(e.isArray(this.related)){var c=this.related.indexOf(a);this.splice(c,1)}else this.setIdAndRelated(null);this.clearRemovalListener(a)}}.bind(this))},setIdAndRelated:function(a,b){b=b||{},b.disableevents||this.registerSetChange(a);var c=this.related;c&&this.clearRemovalListener(c),a?e.isArray(a)?(this.related=a,a.forEach(function(a){this.listenForRemoval(a)}.bind(this))):(this.related=a,this.listenForRemoval(a)):this.related=null},checkInstalled:function(){if(!this.object)throw new d("Proxy must be installed on an object before can use it.")},splicer:function(a){return a=a||{},function(b,c){a=a||{},a.disableevents||this.registerSpliceChange.apply(this,arguments);var d=Array.prototype.slice.call(arguments,2);return f.partial(this.related.splice,b,c).apply(this.related,d)}.bind(this)},clearReverseRelated:function(a){a=a||{};var b=this;if(this.related){var c=this.reverseProxyForInstance(this.related),d=e.isArray(c)?c:[c];f.each(d,function(c){if(e.isArray(c.related)){var d=c.related.indexOf(b.object);c.makeChangesToRelatedWithoutObservations(function(){c.splicer(a)(d,1)})}else c.setIdAndRelated(null,a)})}},setIdAndRelatedReverse:function(a,b){var c=this,d=this.reverseProxyForInstance(a),g=e.isArray(d)?d:[d];f.each(g,function(a){e.isArray(a.related)?a.makeChangesToRelatedWithoutObservations(function(){a.splicer(b)(a.related.length,0,c.object)}):(a.clearReverseRelated(b),a.setIdAndRelated(c.object,b))})},makeChangesToRelatedWithoutObservations:function(a){this.related?(this.related.arrayObserver.close(),this.related.arrayObserver=null,a(),this.wrapArray(this.related)):a()},registerSetChange:function(a){var b=this.object;if(!b)throw new d("Proxy must have an object associated");var c=b.model.name,f=b.collectionName,g=this.related;e.isArray(g)&&!g.length&&(g=null),j.emit({collection:f,model:c,_id:b._id,field:this.getForwardName(),old:g,"new":a,type:k.Set,obj:b})},registerSpliceChange:function(a,b){var c=Array.prototype.slice.call(arguments,2),d=this.object.model.name,e=this.object.collectionName;j.emit({collection:e,model:d,_id:this.object._id,field:this.getForwardName(),index:a,removed:this.related?this.related.slice(a,a+b):null,added:c.length?c:[],type:k.Splice,obj:this.object})},wrapArray:function(a){var b=this;if(h(a,this.reverseName,this.object),!a.arrayObserver){a.arrayObserver=new i(a);var c=function(c){c.forEach(function(c){var d=c.addedCount?a.slice(c.index,c.index+c.addedCount):[],e=b.getForwardModel();j.emit({collection:e.collectionName,model:e.name,_id:b.object._id,field:b.getForwardName(),removed:c.removed,added:d,type:k.Splice,obj:b.object})})};a.arrayObserver.open(c)}},splice:function(){this.splicer({}).apply(this,arguments)}}),b.exports=c}()},{"../vendor/observe-js/src/observe":53,"./Query":6,"./cache":11,"./error":14,"./events":15,"./log":18,"./modelEvents":21,"./store":22,"./util":24}],10:[function(a,b){!function(){b.exports={OneToMany:"OneToMany",OneToOne:"OneToOne",ManyToMany:"ManyToMany"}}()},{}],11:[function(a,b,c){!function(){function b(){v={},t={},u={}}function d(a){var b=t[a];return q(b?"Local cache hit: "+b._dump(!0):"Local cache miss: "+a),b}function e(a){var b=a.name,c=a.collectionName,d=u[c];if(d){var e=d[b];if(e){var f=[];for(var g in e)e.hasOwnProperty(g)&&f.push(e[g]);if(f.length>1){var h="A singleton model has more than 1 object in the cache! This is a serious error. Either a model has been modified after objects have already been created, or something has gonevery wrong. Please file a bug report if the latter.";throw new r(h)}if(f.length)return f[0]}}return null}function f(a,b){var c=b.model.name,d=b.model.collectionName,e=v[d];if(e){var f=v[d][c];if(f){var g=f[a];return q(g?"Remote cache hit: "+g._dump(!0):"Remote cache miss: "+a),g}}return q("Remote cache miss: "+a),null}function g(a,b,c){if(!a){var d="Must pass an object when inserting to cache";throw q(d),new r(d)}var e=a.model.collectionName;if(!e)throw new r("Model has no collection",{model:a.model,obj:a});v[e]||(v[e]={});var f=a.model.name;if(!f)throw new r("Model has no type",{model:a.model,obj:a});v[e][f]||(v[e][f]={}),c&&(v[e][f][c]=null);var g=v[e][f][b];if(g){if(a!=g){var i="Object "+e.toString()+":"+f.toString()+"["+a.model.id+'="'+b+'"] already exists in the cache. This is a serious error, please file a bug report if you are experiencing this out in the wild';throw q(i,{obj:a,cachedObject:g}),new r(i)}q("Object has already been inserted: "+a._dump(!0))}else v[e][f][b]=a,q("Remote cache insert: "+a._dump(!0)),q("Remote cache now looks like: "+h(!0))}function h(a){var b={};for(var c in v)if(v.hasOwnProperty(c)){var d={};b[c]=d;var e=v[c];for(var f in e)if(e.hasOwnProperty(f)){var g={};d[f]=g;var h=e[f];for(var i in h)h.hasOwnProperty(i)&&h[i]&&(g[i]=h[i]._dump())}}return a?s.prettyPrint(4):b}function i(a){var b={};for(var c in t)t.hasOwnProperty(c)&&(b[c]=t[c]._dump());return a?s.prettyPrint(4):b}function j(a){var b={localCache:i(),remoteCache:h()};return a?s.prettyPrint(4):b}function k(){return v}function l(){return t}function m(a){q("get",a);var b,c,g,h=a._id;if(h)return b=d(h),b?b:a.model?(c=a.model.id,g=a[c],q(c+"="+g),f(g,a)):null;if(a.model){if(c=a.model.id,g=a[c])return f(g,a);if(a.model.singleton)return e(a.model)}else q("Invalid opts to cache",{opts:a});return null}function n(a){var b=a._id;if(b){var c=a.model.collectionName,d=a.model.name;if(q("Local cache insert: "+a._dumpString()),t[b]){if(t[b]!=a){var e='Object with _id="'+b.toString()+'" is already in the cache. This is a serious error. Please file a bug report if you are experiencing this out in the wild';throw q(e),new r(e)}}else t[b]=a,q("Local cache now looks like: "+i(!0)),u[c]||(u[c]={}),u[c][d]||(u[c][d]={}),u[c][d][b]=a}var f=a.idField,h=a[f];h?g(a,h):q('No remote id ("'+f+'") so wont be placing in the remote cache',a)}function o(a){var b={_id:a._id},c=a.model;return c.id&&a[c.id]&&(b.model=c,b[c.id]=a[c.id]),!!m(b)}function p(a){if(!o(a))throw new r("Object was not in cache.");var b=a.model.collectionName,c=a.model.name,d=a._id;if(!c)throw r("No mapping name");if(!b)throw r("No collection name");if(!d)throw r("No _id");if(delete u[b][c][d],delete t[d],a.model.id){var e=a[a.model.id];e&&delete v[b][c][e]}}var q=a("./log")("Cache"),r=a("./error").InternalSiestaError,s=a("./util"),t={},u={},v={};c._remoteCache=k,c._localCache=l,Object.defineProperty(c,"_localCacheByType",{get:function(){return u}}),c.get=m,c.insert=n,c.remoteInsert=g,c.reset=b,c._dump=j,c.contains=o,c.remove=p,c.getSingleton=e}()},{"./error":14,"./log":18,"./util":24}],12:[function(a,b){!function(){function c(a,b){var c=this;if(!a)throw new Error("Collection must have a name");b=b||{},j.extendFromOpts(this,b,{baseURL:""}),k.extend(this,{name:a,_rawModels:{},_models:{},_opts:b,installed:!1}),Object.defineProperties(this,{dirty:{get:function(){if(siesta.ext.storageEnabled){var a=siesta.ext.storage._unsavedObjectsByCollection,b=a[c.name]||{};return!!Object.keys(b).length}return void 0},enumerable:!0}}),e.register(this),i.ProxyEventEmitter.call(this,this.name)}{var d=a("./log")("Collection"),e=a("./collectionRegistry").CollectionRegistry,f=a("./error").InternalSiestaError,g=a("./model"),h=a("extend"),i=(a("../vendor/observe-js/src/observe").Platform,a("./events")),j=a("./util"),k=j._,l=a("./error");a("./cache")}c.prototype=Object.create(i.ProxyEventEmitter.prototype),k.extend(c.prototype,{install:function(a){return j.promise(a,function(a){var b=this;if(this.installed)throw new f('Collection "'+this.name+'" has already been installed');var c=[];for(var e in this._models)if(this._models.hasOwnProperty(e)){var g=this._models[e];c.push(g)}if(d("There are "+c.length.toString()+" mappings to install"),c.length){var h=k.map(c,function(a){return k.bind(a.install,a)});j.async.parallel(h,function(e){if(e)d("Failed to install collection",e),b._finaliseInstallation(e,a);else{b.installed=!0;var f=[];k.each(c,function(a){d('Installing relationships for mapping with name "'+a.name+'"');var b=a.installRelationships();b&&f.push(b)}),f.length||k.each(c,function(a){d('Installing reverse relationships for mapping with name "'+a.name+'"');var b=a.installReverseRelationships();b&&f.push(b)}),1==f.length?e=f[0]:f.length&&(e=f),b._finaliseInstallation(e,a)}})}else b._finaliseInstallation(null,a)}.bind(this))},_finaliseInstallation:function(b,c){if(b&&(b=l("Errors were encountered whilst setting up the collection",{errors:b})),!b){this.installed=!0;var d=a("./index");d[this.name]=this}c(b)},_model:function(a,b){if(a){this._rawModels[a]=b,b=h(!0,{},b),b.name=a,b.collection=this;var c=new g(b);return this._models[a]=c,this[a]=c,c}throw new Error("No name specified when creating mapping")},model:function(){var a=!this.installed;if(!a)throw Error("Cannot create new models once the object graph is established!");var b=this;if(arguments.length){if(1==arguments.length){if(j.isArray(arguments[0]))return k.map(arguments[0],function(a){return b._model(a.name,a)});var c,d;return j.isString(arguments[0])?(c=arguments[0],d={}):(d=arguments[0],c=d.name),this._model(c,d)}return"string"==typeof arguments[0]?this._model(arguments[0],arguments[1]):k.map(arguments,function(a){return b._model(a.name,a)})}return null},_dump:function(a){var b={};return b.installed=this.installed,b.docId=this._docId,b.name=this.name,b.baseURL=this.baseURL,a?j.prettyPrint(b):b},count:function(a){return j.promise(a,function(a){var b=k.map(this._models,function(a){return k.bind(a.count,a)});j.async.parallel(b,function(b,c){var d;b||(d=k.reduce(c,function(a,b){return a+b},0)),a(b,d)})}.bind(this))}}),b.exports=c}()},{"../vendor/observe-js/src/observe":53,"./cache":11,"./collectionRegistry":13,"./error":14,"./events":15,"./index":16,"./log":18,"./model":20,"./util":24,extend:33}],13:[function(a,b,c){!function(){function b(){return this?void(this.collectionNames=[]):new b}var d=a("./util")._;d.extend(b.prototype,{register:function(a){var b=a.name;this[b]=a,this.collectionNames.push(b)},reset:function(){var a=this;d.each(this.collectionNames,function(b){delete a[b]}),this.collectionNames=[]}}),c.CollectionRegistry=new b}()},{"./util":24}],14:[function(a,b){!function(){function a(a,b,c){this.message=a,this.context=b,c=c||arguments.callee,c&&Error.captureStackTrace&&Error.captureStackTrace(this,c)}function c(a){return"object"==typeof a?"error"in a&&"ok"in a&&"reason"in a:!1}a.prototype=Object.create(Error.prototype),a.prototype.name="InternalSiestaError",a.prototype.constructor=a,b.exports=function(a,b){if(c(a))return a;var d={reason:a,error:!0,ok:!1};for(var e in b||{})b.hasOwnProperty(e)&&(d[e]=b[e]);return d.toString=function(){return JSON.stringify(this)},d},b.exports.InternalSiestaError=a}()},{}],15:[function(a,b){!function(){function c(a){f.extend(this,{event:a,listeners:{}})}var d=a("events").EventEmitter,e=a("../vendor/observe-js/src/observe").ArrayObserver,f=a("./util")._,g=a("./modelEvents"),h=new d;
h.setMaxListeners(100),f.extend(c.prototype,{listen:function(a,b){if("function"==typeof a)b=a,a=null;else{var c=b;b=function(b){b=b||{},a?b.type==a&&c(b):c(b)};var d=this.listeners;a&&(d[a]||(d[a]=[]),d[a].push(b))}return h.on(this.event,b),function(){this._removeListener(b,a)}.bind(this)},listenOnce:function(a,b){var c=this.event;if("function"==typeof a)b=a,a=null;else{var d=b;b=function(e){e=e||{},a?e.type==a&&(h.removeListener(c,b),d(e)):d(e)}}return a?h.on(c,b):h.once(c,b)},_removeListener:function(a,b){if(b){var c=this.listeners[b],d=c.indexOf(a);c.splice(d,1)}return h.removeListener(this.event,a)},emit:function(a,b){"object"==typeof a?(b=a,a=null):(b=b||{},b.type=a),h.emit.call(h,this.event,b)},_removeAllListeners:function(a){(this.listeners[a]||[]).forEach(function(a){h.removeListener(this.event,a)}.bind(this)),this.listeners[a]=[]},removeAllListeners:function(a){if(a)this._removeAllListeners(a);else for(a in this.listeners)this.listeners.hasOwnProperty(a)&&this._removeAllListeners(a)}}),f.extend(c.prototype,{on:c.prototype.listen}),f.extend(h,{ProxyEventEmitter:c,wrapArray:function(a,b,c){a.observer||(a.observer=new e(a),a.observer.open(function(d){var e=c._attributeNames.indexOf(b)>-1;e&&d.forEach(function(d){g.emit({collection:c.collectionName,model:c.model.name,_id:c._id,index:d.index,removed:d.removed,added:d.addedCount?a.slice(d.index,d.index+d.addedCount):[],type:g.ModelEventType.Splice,field:b,obj:c})})}))}}),b.exports=h}()},{"../vendor/observe-js/src/observe":53,"./modelEvents":21,"./util":24,events:29}],16:[function(a,b){!function(){var c=a("./util"),d=a("./collectionRegistry").CollectionRegistry,e=a("./collection"),f=a("./cache"),g=a("./model"),h=a("./error"),i=a("./events"),j=a("./RelationshipType"),k=a("./ReactiveQuery"),l=a("./ManyToManyProxy"),m=a("./OneToOneProxy"),n=a("./OneToManyProxy"),o=a("./RelationshipProxy"),p=a("./modelEvents"),q=a("./Query"),r=a("./QuerySet"),s=a("./log"),t=c._;c._patchBind();var u=function(a){return u.ext||(u.ext={}),t.extend(u.ext,a||{}),u};Object.defineProperty(u,"q",{get:function(){return this._q||window.q||window.Q},set:function(a){this._q=a}}),t.extend(u,{on:i.on.bind(i),off:i.removeListener.bind(i),once:i.once.bind(i),removeAllListeners:i.removeAllListeners.bind(i)}),t.extend(u,{removeListener:u.off,addListener:u.on}),t.extend(u,{RelationshipType:j,ModelEventType:p.ModelEventType,log:s.Level,InsertionPolicy:k.InsertionPolicy,_internal:{log:s,Model:g,error:h,ModelEventType:p.ModelEventType,ModelInstance:a("./ModelInstance"),extend:a("extend"),MappingOperation:a("./mappingOperation"),events:i,ProxyEventEmitter:i.ProxyEventEmitter,cache:a("./cache"),modelEvents:p,CollectionRegistry:a("./collectionRegistry").CollectionRegistry,Collection:e,utils:c,util:c,_:c._,querySet:r,observe:a("../vendor/observe-js/src/observe"),Query:q,Store:a("./store"),ManyToManyProxy:l,OneToManyProxy:n,OneToOneProxy:m,RelationshipProxy:o},_:c._,async:c.async,isArray:c.isArray,isString:c.isString}),u.ext={};var v=!1,w=!1;t.extend(u,{reset:function(a){v=!1,w=!1,delete this.queuedTasks,f.reset(),d.reset(),i.removeAllListeners(),u.ext.storageEnabled?u.ext.storage._reset(a):a()},collection:function(a,b){return new e(a,b)},install:function(a){return w||v?void a(h("already installing")):c.promise(a,function(a){w=!0;var b=d.collectionNames,c=t.map(b,function(a){return d[a].install.bind(d[a])}),e=u.ext.storageEnabled;e&&(c=c.concat([u.ext.storage.ensureIndexesForAll,u.ext.storage._load])),c.push(function(a){v=!0,this.queuedTasks&&this.queuedTasks.execute(),a()}.bind(this)),u.async.series(c,a)}.bind(this))},_pushTask:function(a){this.queuedTasks||(this.queuedTasks=new function(){this.tasks=[],this.execute=function(){this.tasks.forEach(function(a){a()}),this.tasks=[]}.bind(this)}),this.queuedTasks.tasks.push(a)},_afterInstall:function(a){v?a():(w||this.install(function(a){a&&console.error("Error setting up siesta",a),delete this.queuedTasks}.bind(this)),v?a():this._pushTask(a))},setLogLevel:function(a,b){var c=s.loggerWithName(a);c.setLevel(b)},notify:c.next,registerComparator:q.registerComparator.bind(q)}),Object.defineProperties(u,{_canChange:{get:function(){return!(w||v)}}}),"undefined"!=typeof window&&(window.siesta=u),u.log=a("debug"),b.exports=u,function(){a("../storage")}()}()},{"../storage":52,"../vendor/observe-js/src/observe":53,"./ManyToManyProxy":2,"./ModelInstance":3,"./OneToManyProxy":4,"./OneToOneProxy":5,"./Query":6,"./QuerySet":7,"./ReactiveQuery":8,"./RelationshipProxy":9,"./RelationshipType":10,"./cache":11,"./collection":12,"./collectionRegistry":13,"./error":14,"./events":15,"./log":18,"./mappingOperation":19,"./model":20,"./modelEvents":21,"./store":22,"./util":24,debug:30,extend:33}],17:[function(a,b){!function(){function c(a){this.model=a}var d=a("./log")("Model"),e=a("./error").InternalSiestaError,f=a("./RelationshipType"),g=(a("./Query"),a("./ModelInstance")),h=a("./util"),i=h._,j=h.guid,k=a("./cache"),l=(a("./store"),a("extend"),a("./modelEvents")),m=a("./events").wrapArray,n=a("./OneToManyProxy"),o=a("./OneToOneProxy"),p=a("./ManyToManyProxy"),q=(a("./ReactiveQuery"),a("./ArrangedReactiveQuery"),l.ModelEventType);c.prototype={_getLocalId:function(a){var b;return b=a&&a._id?a._id:j()},_installAttributes:function(a,b){var c=this.model,d=c._attributeNames,e=d.indexOf(c.id);i.extend(a,{__values:i.extend(i.reduce(c.attributes,function(a,b){return void 0!==b.default&&(a[b.name]=b.default),a},{}),b||{})}),e>-1&&d.splice(e,1),i.each(d,function(b){Object.defineProperty(a,b,{get:function(){var c=a.__values[b];return void 0===c?null:c},set:function(d){var e=a.__values[b],f=this._propertyDependencies[b];f=i.map(f,function(a){return{prop:a,old:this[a]}}.bind(this)),a.__values[b]=d,f.forEach(function(b){var d=b.prop,e=this[d];l.emit({collection:c.collectionName,model:c.name,_id:a._id,"new":e,old:b.old,type:q.Set,field:d,obj:a})}.bind(this));var g={collection:c.collectionName,model:c.name,_id:a._id,"new":d,old:e,type:q.Set,field:b,obj:a};window.lastEmission=g,l.emit(g),h.isArray(d)&&m(d,b,a)},enumerable:!0,configurable:!0})})},_installMethods:function(a){var b=this.model;i.each(Object.keys(b.methods),function(c){void 0===a[c]?a[c]=b.methods[c].bind(a):d('A method with name "'+c+'" already exists. Ignoring it.')}.bind(this))},_installProperties:function(a){var b=Object.keys(this.model.properties),c={};i.each(b,function(b){var e=this.model.properties[b],f=e.dependencies||[];f.forEach(function(a){c[a]||(c[a]=[]),c[a].push(b)}),delete e.dependencies,void 0===a[b]?Object.defineProperty(a,b,e):d('A property/method with name "'+b+'" already exists. Ignoring it.')}.bind(this)),a._propertyDependencies=c},_installRemoteId:function(a){var b=this.model;Object.defineProperty(a,this.model.id,{get:function(){return a.__values[b.id]||null},set:function(c){var d=a[b.id];a.__values[b.id]=c,l.emit({collection:b.collectionName,model:b.name,_id:a._id,"new":c,old:d,type:q.Set,field:b.id,obj:a}),k.remoteInsert(a,c,d)},enumerable:!0,configurable:!0})},_installRelationships:function(a){var b=this.model;for(var c in b.relationships){var d;if(b.relationships.hasOwnProperty(c)){var g=i.extend({},b.relationships[c]),h=g.type;if(delete g.type,h==f.OneToMany)d=new n(g);else if(h==f.OneToOne)d=new o(g);else{if(h!=f.ManyToMany)throw new e("No such relationship type: "+h);d=new p(g)}}d.install(a)}},_registerInstance:function(a,b){k.insert(a),b=void 0===b?!0:b,b&&l.emit({collection:this.model.collectionName,model:this.model.name,_id:a._id,"new":a,type:q.New,obj:a})},_installLocalId:function(a,b){a._id=this._getLocalId(b)},_instance:function(a,b){if(this.model.installed){var c=new g(this.model);return this._installLocalId(c,a),this._installAttributes(c,a),this._installMethods(c),this._installProperties(c),this._installRemoteId(c),this._installRelationships(c),this._registerInstance(c,b),c}throw new e("Model must be fully installed before creating any models")}},b.exports=function(a){var b=new c(a);return b._instance.bind(b)}}()},{"./ArrangedReactiveQuery":1,"./ManyToManyProxy":2,"./ModelInstance":3,"./OneToManyProxy":4,"./OneToOneProxy":5,"./Query":6,"./ReactiveQuery":8,"./RelationshipType":10,"./cache":11,"./error":14,"./events":15,"./log":18,"./modelEvents":21,"./store":22,"./util":24,extend:33}],18:[function(a,b){!function(){var c=a("debug"),d=a("argsarray");b.exports=function(a){var b=c(a),e=d(function(a){b.call(b,a)});return Object.defineProperty(e,"enabled",{get:function(){return c.enabled(a)}}),e}}()},{argsarray:27,debug:30}],19:[function(a,b){!function(){function c(a){this.opts=a}function d(a){this._opts=a,i.extendFromOpts(this,a,{model:null,data:null,objects:[],disableevents:!1,_ignoreInstalled:!1,fromStorage:!1}),j.extend(this,{errors:[],subTaskResults:{},_newObjects:[]})}var e=a("./store"),f=a("./ModelInstance"),g=a("./log")("Mapping"),h=a("./cache"),i=a("./util"),j=i._,k=i.async;c.prototype.toString=function(){return JSON.stringify(this.opts,null,4)},j.extend(d.prototype,{mapAttributes:function(){for(var a=0;a<this.data.length;a++){var b=this.data[a],c=this.objects[a];if(b!=c&&c){var d=this.model._attributeNames;j.each(d,function(a){void 0!==b[a]&&(this.disableevents?c.__values[a]=b[a]:c[a]=b[a])}.bind(this)),b._rev&&(c._rev=b._rev)}}},_map:function(){var a,b=this;this.mapAttributes();var c=j.keys(b.subTaskResults);j.each(c,function(c){for(var d=b.subTaskResults[c],e=d.indexes,f=d.objects,g=b.getRelatedData(c).relatedData,h=i.unflattenArray(f,g),j=0;j<h.length;j++){var k=e[j],l=b.errors[k];if(a=l?l[c]:null,!a){var m=h[j],n=b.objects[k];n&&(a=n.__proxies[c].set(m,{disableevents:b.disableevents}),a&&(b.errors[k]||(b.errors[k]={}),b.errors[k][c]=a))}}})},_lookup:function(a){return i.promise(a,function(a){for(var b=this,c=[],d=[],k=0;k<this.data.length;k++)if(!this.objects[k]){var l,m=this.data[k],n="string"==typeof m||"number"==typeof m||m instanceof String;m?n?(l={index:k,datum:{}},l.datum[b.model.id]=m,c.push(l)):m instanceof f?this.objects[k]=m:m._id?d.push({index:k,datum:m}):m[b.model.id]?c.push({index:k,datum:m}):this.objects[k]=b._instance():this.objects[k]=null}i.async.parallel([function(a){var c=j.pluck(j.pluck(d,"datum"),"_id");c.length?e.getMultipleLocal(c,function(e,f){if(!e)for(var g=0;g<c.length;g++){var i=f[g],j=c[g],k=d[g];i?b.objects[k.index]=i:(i=h.get({_id:j}),i||(i=b._instance({_id:j},!b.disableevents)),b.objects[k.index]=i)}a(e)}):a()},function(a){var d=j.pluck(j.pluck(c,"datum"),b.model.id);d.length?(g("Looking up remoteIdentifiers: "+i.prettyPrint(d)),e.getMultipleRemote(d,b.model,function(e,f){if(!e){if(g.enabled){var j={};for(k=0;k<f.length;k++)j[d[k]]=f[k]?f[k]._id:null;g("Results for remoteIdentifiers: "+i.prettyPrint(j))}for(k=0;k<f.length;k++){var l=f[k],m=c[k];if(l)b.objects[m.index]=l;else{var n={},o=d[k];n[b.model.id]=o;var p={model:b.model};p[b.model.id]=o;var q=h.get(p);q?b.objects[m.index]=q:(b.objects[m.index]=b._instance(),b.objects[m.index][b.model.id]=o)}}}a(e)})):a()}],a)}.bind(this))},_lookupSingleton:function(a){return i.promise(a,function(a){var b,c=this,d=j.pluck(c.data,"_id");for(f=0;f<d.length;f++)if(d[f]){b={_id:d[f]};break}for(var e=h.getSingleton(this.model)||this._instance(b),f=0;f<c.data.length;f++)c.objects[f]=e;a()}.bind(this))},_instance:function(){var a=this.model,b=a._instance.apply(a,arguments);return this._newObjects.push(b),b},start:function(a){if(this.data.length){var b=this,c=[],d=this.model.singleton?this._lookupSingleton:this._lookup;c.push(j.bind(d,this)),c.push(j.bind(this._executeSubOperations,this)),i.async.parallel(c,function(){try{b._map();var c=this.fromStorage,d=j.reduce(b._newObjects,function(b,d){var e=d.model.init;if(e){var f=i.paramNames(e);f.length>1?b.push(j.bind(e,d,c,a)):e.call(d,c)}return b},[]);k.parallel(d,function(){a(b.errors.length?b.errors:null,b.objects)})}catch(e){console.error("Uncaught error when executing init funcitons on models.",e),a(e)}}.bind(this))}else a(null,[])},getRelatedData:function(a){for(var b=[],c=[],d=0;d<this.data.length;d++){var e=this.data[d];e&&e[a]&&(b.push(d),c.push(e[a]))}return{indexes:b,relatedData:c}},processErrorsFromTask:function(a,b,c){if(b.length)for(var d=this.getRelatedData(a).relatedData,e=i.unflattenArray(b,d),f=0;f<e.length;f++){var g=c[f],h=e[f],k=h;i.isArray(h)&&(k=j.reduce(h,function(a,b){return a||b},!1)),k&&(this.errors[g]||(this.errors[g]={}),this.errors[g][a]=h)}},_executeSubOperations:function(a){var b=this,c=j.keys(this.model.relationships);if(c.length){var e=j.reduce(c,function(a,c){var e=b.model.relationships[c],f=e.forwardName==c?e.reverseModel:e.forwardModel;f.singleton&&!e.isReverse&&this.data.forEach(function(a){a[c]||(a[c]={})});var g=this.getRelatedData(c),h=g.indexes,j=g.relatedData;if(j.length)var k=i.flattenArray(j),l=new d({model:f,data:k,disableevents:b.disableevents,_ignoreInstalled:b._ignoreInstalled,fromStorage:this.fromStorage});if(l){var m;m=function(a){l.start(function(d,e){b.subTaskResults[c]={errors:d,objects:e,indexes:h},b.processErrorsFromTask(c,l.errors,h),a()})},a.push(m)}return a}.bind(this),[]);k.parallel(e,function(b){a(b)})}else a()}}),b.exports=d}()},{"./ModelInstance":3,"./cache":11,"./log":18,"./store":22,"./util":24}],20:[function(a,b){!function(){function c(a){var b=this;this._opts=a?r.extend({},a):{},j.extendFromOpts(this,a,{methods:{},attributes:[],collection:function(a){return j.isString(a)&&(a=e[a]),a},id:"id",relationships:[],name:null,indexes:[],singleton:!1,statics:this.installStatics.bind(this),properties:{},init:null,remove:null}),this.attributes=c._processAttributes(this.attributes),this._instance=new p(this),r.extend(this,{_installed:!1,_relationshipsInstalled:!1,_reverseRelationshipsInstalled:!1,children:[]}),Object.defineProperties(this,{_relationshipNames:{get:function(){return Object.keys(b.relationships)},enumerable:!0},_attributeNames:{get:function(){var a=[];return b.id&&a.push(b.id),r.each(b.attributes,function(b){a.push(b.name)}),a},enumerable:!0,configurable:!0},installed:{get:function(){return b._installed&&b._relationshipsInstalled&&b._reverseRelationshipsInstalled},enumerable:!0,configurable:!0},descendants:{get:function(){return r.reduce(b.children,function(a,b){return Array.prototype.concat.call(a,b.descendants)}.bind(b),r.extend([],b.children))},enumerable:!0},dirty:{get:function(){if(siesta.ext.storageEnabled){var a=siesta.ext.storage._unsavedObjectsByCollection,b=(a[this.collectionName]||{})[this.name]||{};return!!Object.keys(b).length}return void 0},enumerable:!0},collectionName:{get:function(){return this.collection.name},enumerable:!0}}),n.ProxyEventEmitter.call(this,this.collectionName+":"+this.name)}var d=a("./log")("Model"),e=a("./collectionRegistry").CollectionRegistry,f=a("./error").InternalSiestaError,g=a("./RelationshipType"),h=a("./Query"),i=a("./mappingOperation"),j=(a("./ModelInstance"),a("./util")),k=a("./cache"),l=(a("./store"),a("./error")),m=a("extend"),n=(a("./modelEvents"),a("./events")),o=(a("./OneToOneProxy"),a("./ManyToManyProxy"),a("./ReactiveQuery")),p=a("./instanceFactory"),q=a("./ArrangedReactiveQuery"),r=j._;r.extend(c,{_processAttributes:function(a){return r.reduce(a,function(a,b){return a.push("string"==typeof b?{name:b}:b),a},[])}}),c.prototype=Object.create(n.ProxyEventEmitter.prototype),r.extend(c.prototype,{installStatics:function(a){return a&&r.each(Object.keys(a),function(b){this[b]?d('Static method with name "'+b+'" already exists. Ignoring it.'):this[b]=a[b].bind(this)}.bind(this)),a},_validateRelationshipType:function(a){return a.type||(a.type=this.singleton?g.OneToOne:g.OneToMany),this.singleton&&a.type==g.ManyToMany?"Singleton model cannot use ManyToMany relationship.":Object.keys(g).indexOf(a.type)<0?"Relationship type "+a.type+" does not exist":null},installRelationships:function(){if(this._relationshipsInstalled)throw new f('Relationships for "'+this.name+'" have already been installed');var a=this,b=null;if(a._relationships=[],a._opts.relationships)for(var g in a._opts.relationships)if(a._opts.relationships.hasOwnProperty(g)){var h=a._opts.relationships[g];if(!(h.isReverse||(d(this.name+": configuring relationship "+g,h),b=this._validateRelationshipType(h)))){var i=h.model;delete h.model;var j;if(i instanceof c)j=i;else{if(d("reverseModelName",i),!a.collection)throw new f("Model must have collection");var k=a.collection;if(!k)throw new f("Collection "+a.collectionName+" not registered");j=k[i]}if(!j){var l=i.split(".");if(2==l.length){var m=l[0];i=l[1];var n=e[m];if(!n)return'Collection with name "'+m+'" does not exist.';j=n[i]}}if(d("reverseModel",j),!j)return'Model with name "'+i.toString()+'" does not exist';r.extend(h,{reverseModel:j,forwardModel:this,forwardName:g,reverseName:h.reverse||"reverse_"+g,isReverse:!1}),delete h.reverse}}return b||(this._relationshipsInstalled=!0),b},installReverseRelationships:function(){if(this._reverseRelationshipsInstalled)throw new f('Reverse relationships for "'+this.name+'" have already been installed.');for(var a in this.relationships)if(this.relationships.hasOwnProperty(a)){var b=this.relationships[a];b=m(!0,{},b),b.isReverse=!0;var c=b.reverseModel,e=b.reverseName;if(c.singleton){if(b.type==g.ManyToMany)return"Singleton model cannot be related via reverse ManyToMany";if(b.type==g.OneToMany)return"Singleton model cannot be related via reverse OneToMany"}d(this.name+": configuring  reverse relationship "+e),c.relationships[e]=b}this._reverseRelationshipsInstalled=!0},_query:function(a){return new h(this,a||{})},query:function(a,b){return j.promise(b,function(b){return this.singleton?void this._query({__ignoreInstalled:!0}).execute(function(c,d){c?b(c):(a=r.extend({},a),a.__ignoreInstalled=!0,d.length?this._query(a).execute(b):this.graph({},function(c){c?b(c):this._query(a).execute(b)}.bind(this)))}.bind(this)):this._query(a).execute(b)}.bind(this))},reactiveQuery:function(a){return new o(new h(this,a||{}))},arrangedReactiveQuery:function(a){return new q(new h(this,a||{}))},one:function(a,b){return"function"==typeof a&&(b=a,a={}),j.promise(b,function(b){this.query(a,function(a,c){a?b(a):c.length>1?b(l("More than one instance returned when executing get query!")):(c=c.length?c[0]:null,b(null,c))})}.bind(this))},all:function(a,b){"function"==typeof a&&(b=a,a={}),a=a||{};var c={};return a.__order&&(c.__order=a.__order),this.query(a,b)},install:function(a){return d("Installing mapping "+this.name),j.promise(a,function(a){if(this._installed)throw new f('Model "'+this.name+'" has already been installed');this._installed=!0,a()}.bind(this))},graph:function(a,b,c){return"function"==typeof b&&(c=b),b=b||{},j.promise(c,function(c){var d=function(){var d=b.override;d&&(b.objects=j.isArray(d)?d:[d]),delete b.override,j.isArray(a)?this._mapBulk(a,b,c):this._mapBulk([a],b,function(b,d){var e;d&&d.length&&(e=d[0]),b=b?j.isArray(a)?b:j.isArray(b)?b[0]:b:null,c(b,e)})}.bind(this);b._ignoreInstalled?d():siesta._afterInstall(d)}.bind(this))},_mapBulk:function(a,b,c){r.extend(b,{model:this,data:a});var d=new i(b);d.start(function(a,b){a?c&&c(a):c(null,b||[])})},_countCache:function(){var a=k._localCacheByType[this.collectionName]||{},b=a[this.name]||{};return r.reduce(Object.keys(b),function(a,b){return a[b]={},a},{})},count:function(a){return j.promise(a,function(a){a(null,Object.keys(this._countCache()).length)}.bind(this))},_dump:function(a){var b={};return b.name=this.name,b.attributes=this.attributes,b.id=this.id,b.collection=this.collectionName,b.relationships=r.map(this.relationships,function(a){return a.isForward?a.forwardName:a.reverseName}),a?j.prettyPrint(b):b},toString:function(){return"Model["+this.name+"]"}}),r.extend(c.prototype,{child:function(a,b){"string"==typeof a?b.name=a:b=name,r.extend(b,{attributes:Array.prototype.concat.call(b.attributes||[],this._opts.attributes),relationships:r.extend(b.relationships||{},this._opts.relationships),methods:r.extend(r.extend({},this._opts.methods)||{},b.methods),statics:r.extend(r.extend({},this._opts.statics)||{},b.statics),properties:r.extend(r.extend({},this._opts.properties)||{},b.properties),id:b.id||this._opts.id,init:b.init||this._opts.init,remove:b.remove||this._opts.remove});var c=this.collection.model(b.name,b);return c.parent=this,this.children.push(c),c},isChildOf:function(a){return this.parent==a},isParentOf:function(a){return this.children.indexOf(a)>-1},isDescendantOf:function(a){for(var b=this.parent;b;){if(b==a)return!0;b=b.parent}return!1},isAncestorOf:function(a){return this.descendants.indexOf(a)>-1},hasAttributeNamed:function(a){return this._attributeNames.indexOf(a)>-1}}),b.exports=c}()},{"./ArrangedReactiveQuery":1,"./ManyToManyProxy":2,"./ModelInstance":3,"./OneToOneProxy":5,"./Query":6,"./ReactiveQuery":8,"./RelationshipType":10,"./cache":11,"./collectionRegistry":13,"./error":14,"./events":15,"./instanceFactory":17,"./log":18,"./mappingOperation":19,"./modelEvents":21,"./store":22,"./util":24,extend:33}],21:[function(a,b,c){!function(){function b(a){this._opts=a||{},Object.keys(a).forEach(function(b){this[b]=a[b]}.bind(this))}function d(a,b,c){i('Sending notification "'+a+'" of type '+c.type),g.emit(a,c);var d=a+":"+b;i('Sending notification "'+d+'" of type '+c.type),g.emit(d,c);var e="Siesta";i('Sending notification "'+e+'" of type '+c.type),g.emit(e,c);var f=c._id;i('Sending notification "'+f+'" of type '+c.type),g.emit(f,c);var j,l=k[a];if(!l)throw j='No such collection "'+a+'"',i(j,k),new h(j);var m=l[b];if(!m)throw j='No such model "'+b+'"',i(j,k),new h(j);if(m.id&&c.obj[m.id]){var n=a+":"+b+":"+c.obj[m.id];i('Sending notification "'+n+'" of type '+c.type),g.emit(n,c)}}function e(a){if(!a.model)throw new h("Must pass a model");if(!a.collection)throw new h("Must pass a collection");if(!a._id)throw new h("Must pass a local identifier");if(!a.obj)throw new h("Must pass the object")}function f(a){e(a);var c=a.collection,f=a.model,g=new b(a);return d(c,f,g),g}var g=a("./events"),h=a("./error").InternalSiestaError,i=a("./log")("ModelEvents"),j=a("./util")._.extend,k=a("./collectionRegistry").CollectionRegistry,l={Set:"Set",Splice:"Splice",New:"New",Remove:"Remove"};b.prototype._dump=function(a){var b={};return b.collection="string"==typeof this.collection?this.collection:this.collection._dump(),b.model="string"==typeof this.model?this.model:this.model.name,b._id=this._id,b.field=this.field,b.type=this.type,this.index&&(b.index=this.index),this.added&&(b.added=_.map(this.added,function(a){return a._dump()})),this.removed&&(b.removed=_.map(this.removed,function(a){return a._dump()})),this.old&&(b.old=this.old),this.new&&(b.new=this.new),a?util.prettyPrint(b):b},j(c,{ModelEvent:b,emit:f,validateEventOpts:e,ModelEventType:l})}()},{"./collectionRegistry":13,"./error":14,"./events":15,"./log":18,"./util":24}],22:[function(a,b){!function(){function c(a,b){h("get",a);var c;return i.promise(b,function(b){if(a._id){if(i.isArray(a._id))d(j.map(a._id,function(a){return{_id:a}}),b);else if(c=k.get(a))h.enabled&&h("Had cached object",{opts:a,obj:c}),b&&b(null,c);else if(i.isArray(a._id))d(j.map(a._id,function(a){return{_id:a}}),b);else if(b){var e=siesta.ext.storage;if(!e)throw new Error("Storage module not installed");e.store.getFromPouch(a,b)}}else{if(!a.model){var f={opts:a},l="Invalid options given to store";throw new g(l,f)}if(i.isArray(a[a.model.id]))d(j.map(a[a.model.id],function(b){var c={};return c[a.model.id]=b,c.model=a.model,c}),b);else if(c=k.get(a))h.enabled&&h("Had cached object",{opts:a,obj:c}),b&&b(null,c);else{var m=a.model;if(m.singleton)m.one(b);else{var n=m.id,o=a[n],p={};if(p[n]=o,!o)throw new g('Invalid options given to store. Missing "'+n.toString()+'."');m.one(p,function(a,c){a?b(a):c?b(null,c):b(null,null)})}}}}.bind(this))}function d(a,b){return i.promise(b,function(b){var d=[],e=[];j.each(a,function(f){c(f,function(c,f){c?e.push(c):d.push(f),d.length+e.length==a.length&&b&&(e.length?b(e):b(null,d))})})}.bind(this))}function e(a,b){return i.promise(b,function(b){function c(c){b&&(c?b(c):b(null,j.map(a,function(a){return d.cached[a]})))}var d=j.reduce(a,function(a,b){var c=k.get({_id:b});return c?a.cached[b]=c:a.notCached.push(b),a},{cached:{},notCached:[]});c()}.bind(this))}function f(a,b,c){return i.promise(c,function(c){function d(b){c&&(b?c(b):c(null,j.map(a,function(a){return e.cached[a]})))}var e=j.reduce(a,function(a,c){var d={model:b};d[b.id]=c;var e=k.get(d);return e?a.cached[c]=e:a.notCached.push(c),a},{cached:{},notCached:[]});d()}.bind(this))}var g=a("./error").InternalSiestaError,h=a("./log")("Store"),i=a("./util"),j=i._,k=a("./cache");b.exports={get:c,getMultiple:d,getMultipleLocal:e,getMultipleRemote:f}}()},{"./cache":11,"./error":14,"./log":18,"./util":24}],23:[function(a,b){!function(){function c(a){return function(){var b=Array.prototype.slice.call(arguments);return a.apply(null,[i].concat(b))}}function d(a,b){if(a.map)return a.map(b);var c=[];return i(a,function(a,d,e){c.push(b(a,d,e))}),c}function e(a,b,c,e){if(b=d(b,function(a,b){return{index:b,value:a}}),e){var f=[];a(b,function(a,b){c(a.value,function(c,d){f[a.index]=d,b(c)})},function(a){e(a,f)})}else a(b,function(a,b){c(a.value,function(a){b(a)})})}function f(a){return function(){var b=Array.prototype.slice.call(arguments);return a.apply(null,[g].concat(b))}}function g(a,b,c){if(c=c||function(){},!a.length)return c();var d=0,e=function(){b(a[d],function(b){b?(c(b),c=function(){}):(d+=1,d>=a.length?c():e())})};e()}function h(a,b){if(a.forEach)return a.forEach(b);for(var c=0;c<a.length;c+=1)b(a[c],c,a)}function i(a,b,c){function d(b){b?(c(b),c=function(){}):(e+=1,e>=a.length&&c())}if(c=c||function(){},!a.length)return c();var e=0;h(a,function(a){b(a,k(d))})}function j(a,b){if(b=b||function(){},n.isArray(a))q(a,function(a,b){a&&a(function(a){var c=Array.prototype.slice.call(arguments,1);c.length<=1&&(c=c[0]),b.call(null,a,c)})},b);else{var c={};g(o.keys(a),function(b,d){a[b](function(a){var e=Array.prototype.slice.call(arguments,1);e.length<=1&&(e=e[0]),c[b]=e,d(a)})},function(a){b(a,c)})}}function k(a){var b=!1;return function(){if(b)throw new Error("Callback was already called.");b=!0,a.apply(m,arguments)}}function l(a,b){r({map:p,each:i},a,b)}var m,n=a("./misc"),o=a("./underscore"),p=c(e),q=f(e),r=function(a,b,c){if(c=c||function(){},n.isArray(b))a.map(b,function(a,b){a&&a(function(a){var c=Array.prototype.slice.call(arguments,1);c.length<=1&&(c=c[0]),b.call(null,a,c)})},c);else{var d={};a.each(Object.keys(b),function(a,c){b[a](function(b){var e=Array.prototype.slice.call(arguments,1);e.length<=1&&(e=e[0]),d[a]=e,c(b)})},function(a){c(a,d)})}};b.exports={series:j,parallel:l}}()},{"./misc":25,"./underscore":26}],24:[function(a,b){!function(){var c=a("./underscore"),d=a("./async"),e=a("./misc");c.extend(b.exports,{_:c,async:d}),c.extend(b.exports,e)}()},{"./async":23,"./misc":25,"./underscore":26}],25:[function(a,b){!function(){function c(a,b){return function(c){a&&a.apply(a,arguments),b&&(c?b.reject(c):b.resolve.apply(b,Array.prototype.slice.call(arguments,1)))}}var d=a("../../vendor/observe-js/src/observe").Platform,e=a("./underscore"),f=a("lie"),g=a("argsarray"),h=a("./../error").InternalSiestaError,i=/^function\s*[^\(]*\(\s*([^\)]*)\)/m,j=/,/,k=/^\s*(_?)(.+?)\1\s*$/,l=/((\/\/.*$)|(\/\*[\s\S]*?\*\/))/gm,m=function(a){return"[object Array]"===e.toString.call(a)},n=Array.isArray||m,o=function(a){return"string"==typeof a||a instanceof String};e.extend(b.exports,{next:function(a){d.performMicrotaskCheckpoint(),setTimeout(a)},cb:c,guid:function(){function a(){return Math.floor(65536*(1+Math.random())).toString(16).substring(1)}return function(){return a()+a()+"-"+a()+"-"+a()+"-"+a()+"-"+a()+a()+a()}}(),assert:function(a,b,c){if(!a)throw b=b||"Assertion failed",c=c||{},new h(b,c)},thenBy:function(){function a(a){return a.thenBy=b,a}function b(b){var c=this;return a(function(a,d){return c(a,d)||b(a,d)})}return a}(),defineSubProperty:function(a,b,c){return Object.defineProperty(this,a,{get:function(){return c?b[c]:b[a]},set:function(d){c?b[c]=d:b[a]=d},enumerable:!0,configurable:!0})},defineSubPropertyNoSet:function(a,b,c){return Object.defineProperty(this,a,{get:function(){return c?b[c]:b[a]},enumerable:!0,configurable:!0})},_patchBind:function(){var a=Function.prototype.apply.bind(Function.prototype.bind);Object.defineProperty(Function.prototype,"bind",{value:function(b){var c=a(this,arguments);return Object.defineProperty(c,"__siesta_bound_object",{value:b,writable:!0,configurable:!0,enumerable:!1}),c}})},promise:function(a,b){return a=a||function(){},new f(function(c,d){var e=g(function(b){var e=b[0],f=b.slice(1);e?d(e):c(f[0]);var g=a.__siesta_bound_object||a;a.apply(g,b)});b(e)})},subProperties:function(a,b,c){n(c)||(c=Array.prototype.slice.call(arguments,2));for(var d=0;d<c.length;d++)!function(c){var d={set:!1,name:c,property:c};o(c)||e.extend(d,c);var f={get:function(){return b[d.property]},enumerable:!0,configurable:!0};d.set&&(f.set=function(a){b[d.property]=a}),Object.defineProperty(a,d.name,f)}(c[d])},capitaliseFirstLetter:function(a){return a.charAt(0).toUpperCase()+a.slice(1)},extendFromOpts:function(a,b,c,d){if(d=void 0==d?!0:d){var f=Object.keys(c),g=Object.keys(b),h=g.filter(function(a){return-1==f.indexOf(a)});if(h.length)throw Error("Unknown options: "+h.toString())}e.each(Object.keys(c),function(a){var d=c[a];"function"==typeof d&&(c[a]=d(b[a]),delete b[a])}),e.extend(c,b),e.extend(a,c)},isString:o,isArray:n,prettyPrint:function(a){return JSON.stringify(a,null,4)},flattenArray:function(a){return e.reduce(a,function(a,b){return n(b)?a=a.concat(b):a.push(b),a},[])},unflattenArray:function(a,b){for(var c=0,d=[],e=0;e<b.length;e++)if(n(b[e])){var f=[];d[e]=f;for(var g=0;g<b[e].length;g++)f.push(a[c]),c++}else d[e]=a[c],c++;return d},paramNames:function(a){var b,c,d=[];return b=a.toString().replace(l,""),c=b.match(i),c[1].split(j).forEach(function(a){a.replace(k,function(a,b,c){d.push(c)})}),d}})}()},{"../../vendor/observe-js/src/observe":53,"./../error":14,"./underscore":26,argsarray:27,lie:37}],26:[function(a,b){!function(){function a(a){if(Object.keys)return Object.keys(a);var b=[];for(var c in a)a.hasOwnProperty(c)&&b.push(c);return b}var c={},d=Array.prototype,e=Function.prototype,f=d.forEach,g=d.map,h=d.reduce,i=e.bind,j=d.slice,k={},l=function(){};c.keys=a,c.each=c.forEach=function(a,b,d){if(null==a)return a;if(f&&a.forEach===f)a.forEach(b,d);else if(a.length===+a.length){for(var e=0,g=a.length;g>e;e++)if(b.call(d,a[e],e,a)===k)return}else for(var h=c.keys(a),e=0,g=h.length;g>e;e++)if(b.call(d,a[h[e]],h[e],a)===k)return;return a},c.map=c.collect=function(a,b,d){var e=[];return null==a?e:g&&a.map===g?a.map(b,d):(c.each(a,function(a,c,f){e.push(b.call(d,a,c,f))}),e)};var m=function(a,b,c){if(void 0===b)return a;switch(null==c?3:c){case 1:return function(c){return a.call(b,c)};case 2:return function(c,d){return a.call(b,c,d)};case 3:return function(c,d,e){return a.call(b,c,d,e)};case 4:return function(c,d,e,f){return a.call(b,c,d,e,f)}}return function(){return a.apply(b,arguments)}};c.times=function(a,b,c){var d=new Array(Math.max(0,a));b=m(b,c,1);for(var e=0;a>e;e++)d[e]=b(e);return d},c.partial=function(a){var b=j.call(arguments,1);return function(){for(var d=0,e=b.slice(),f=0,g=e.length;g>f;f++)e[f]===c&&(e[f]=arguments[d++]);for(;d<arguments.length;)e.push(arguments[d++]);return a.apply(this,e)}},c.pluck=function(a,b){return c.map(a,c.property(b))};var n="Reduce of empty array with no initial value";c.reduce=c.foldl=c.inject=function(a,b,d,e){var f=arguments.length>2;if(null==a&&(a=[]),h&&a.reduce===h)return e&&(b=c.bind(b,e)),f?a.reduce(b,d):a.reduce(b);if(c.each(a,function(a,c,g){f?d=b.call(e,d,a,c,g):(d=a,f=!0)}),!f)throw new TypeError(n);return d},c.property=function(a){return function(b){return b[a]}},"function"!=typeof/./&&(c.isFunction=function(a){return"function"==typeof a}),c.isObject=function(a){var b=typeof a;return"function"===b||"object"===b&&!!a};var o=function(a){return null==a?c.identity:c.isFunction(a)?a:c.property(a)};c.sortBy=function(a,b,d){return b=o(b),c.pluck(c.map(a,function(a,c,e){return{value:a,index:c,criteria:b.call(d,a,c,e)}
}).sort(function(a,b){var c=a.criteria,d=b.criteria;if(c!==d){if(c>d||void 0===c)return 1;if(d>c||void 0===d)return-1}return a.index-b.index}),"value")},c.bind=function(a,b){var d,e;if(i&&a.bind===i)return i.apply(a,j.call(arguments,1));if(!c.isFunction(a))throw new TypeError;return d=j.call(arguments,2),e=function(){if(!(this instanceof e))return a.apply(b,d.concat(j.call(arguments)));l.prototype=a.prototype;var c=new l;l.prototype=null;var f=a.apply(c,d.concat(j.call(arguments)));return Object(f)===f?f:c}},c.identity=function(a){return a},c.zip=function(a){if(null==a)return[];for(var b=c.max(arguments,"length").length,d=Array(b),e=0;b>e;e++)d[e]=c.pluck(arguments,e);return d},c.max=function(a,b,d){var e,f,g=-1/0,h=-1/0;if(null==b&&null!=a){a=a.length===+a.length?a:c.values(a);for(var i=0,j=a.length;j>i;i++)e=a[i],e>g&&(g=e)}else b=c.iteratee(b,d),c.each(a,function(a,c,d){f=b(a,c,d),(f>h||f===-1/0&&g===-1/0)&&(g=a,h=f)});return g},c.iteratee=function(a,b,d){return null==a?c.identity:c.isFunction(a)?m(a,b,d):c.isObject(a)?c.matches(a):c.property(a)},c.pairs=function(a){for(var b=c.keys(a),d=b.length,e=Array(d),f=0;d>f;f++)e[f]=[b[f],a[b[f]]];return e},c.matches=function(a){var b=c.pairs(a),d=b.length;return function(a){if(null==a)return!d;a=new Object(a);for(var c=0;d>c;c++){var e=b[c],f=e[0];if(e[1]!==a[f]||!(f in a))return!1}return!0}},c.some=function(a,b,d){if(null==a)return!1;b=c.iteratee(b,d);var e,f,g=a.length!==+a.length&&c.keys(a),h=(g||a).length;for(e=0;h>e;e++)if(f=g?g[e]:e,b(a[f],f,a))return!0;return!1},c.extend=function(a){if(!c.isObject(a))return a;for(var b,d,e=1,f=arguments.length;f>e;e++){b=arguments[e];for(d in b)hasOwnProperty.call(b,d)&&(a[d]=b[d])}return a},b.exports=c}()},{}],27:[function(a,b){"use strict";function c(a){return function(){var b=arguments.length;if(b){for(var c=[],d=-1;++d<b;)c[d]=arguments[d];return a.call(this,c)}return a.call(this,[])}}b.exports=c},{}],28:[function(){},{}],29:[function(a,b){function c(){this._events=this._events||{},this._maxListeners=this._maxListeners||void 0}function d(a){return"function"==typeof a}function e(a){return"number"==typeof a}function f(a){return"object"==typeof a&&null!==a}function g(a){return void 0===a}b.exports=c,c.EventEmitter=c,c.prototype._events=void 0,c.prototype._maxListeners=void 0,c.defaultMaxListeners=10,c.prototype.setMaxListeners=function(a){if(!e(a)||0>a||isNaN(a))throw TypeError("n must be a positive number");return this._maxListeners=a,this},c.prototype.emit=function(a){var b,c,e,h,i,j;if(this._events||(this._events={}),"error"===a&&(!this._events.error||f(this._events.error)&&!this._events.error.length)){if(b=arguments[1],b instanceof Error)throw b;throw TypeError('Uncaught, unspecified "error" event.')}if(c=this._events[a],g(c))return!1;if(d(c))switch(arguments.length){case 1:c.call(this);break;case 2:c.call(this,arguments[1]);break;case 3:c.call(this,arguments[1],arguments[2]);break;default:for(e=arguments.length,h=new Array(e-1),i=1;e>i;i++)h[i-1]=arguments[i];c.apply(this,h)}else if(f(c)){for(e=arguments.length,h=new Array(e-1),i=1;e>i;i++)h[i-1]=arguments[i];for(j=c.slice(),e=j.length,i=0;e>i;i++)j[i].apply(this,h)}return!0},c.prototype.addListener=function(a,b){var e;if(!d(b))throw TypeError("listener must be a function");if(this._events||(this._events={}),this._events.newListener&&this.emit("newListener",a,d(b.listener)?b.listener:b),this._events[a]?f(this._events[a])?this._events[a].push(b):this._events[a]=[this._events[a],b]:this._events[a]=b,f(this._events[a])&&!this._events[a].warned){var e;e=g(this._maxListeners)?c.defaultMaxListeners:this._maxListeners,e&&e>0&&this._events[a].length>e&&(this._events[a].warned=!0,console.error("(node) warning: possible EventEmitter memory leak detected. %d listeners added. Use emitter.setMaxListeners() to increase limit.",this._events[a].length),"function"==typeof console.trace&&console.trace())}return this},c.prototype.on=c.prototype.addListener,c.prototype.once=function(a,b){function c(){this.removeListener(a,c),e||(e=!0,b.apply(this,arguments))}if(!d(b))throw TypeError("listener must be a function");var e=!1;return c.listener=b,this.on(a,c),this},c.prototype.removeListener=function(a,b){var c,e,g,h;if(!d(b))throw TypeError("listener must be a function");if(!this._events||!this._events[a])return this;if(c=this._events[a],g=c.length,e=-1,c===b||d(c.listener)&&c.listener===b)delete this._events[a],this._events.removeListener&&this.emit("removeListener",a,b);else if(f(c)){for(h=g;h-->0;)if(c[h]===b||c[h].listener&&c[h].listener===b){e=h;break}if(0>e)return this;1===c.length?(c.length=0,delete this._events[a]):c.splice(e,1),this._events.removeListener&&this.emit("removeListener",a,b)}return this},c.prototype.removeAllListeners=function(a){var b,c;if(!this._events)return this;if(!this._events.removeListener)return 0===arguments.length?this._events={}:this._events[a]&&delete this._events[a],this;if(0===arguments.length){for(b in this._events)"removeListener"!==b&&this.removeAllListeners(b);return this.removeAllListeners("removeListener"),this._events={},this}if(c=this._events[a],d(c))this.removeListener(a,c);else for(;c.length;)this.removeListener(a,c[c.length-1]);return delete this._events[a],this},c.prototype.listeners=function(a){var b;return b=this._events&&this._events[a]?d(this._events[a])?[this._events[a]]:this._events[a].slice():[]},c.listenerCount=function(a,b){var c;return c=a._events&&a._events[b]?d(a._events[b])?1:a._events[b].length:0}},{}],30:[function(a,b,c){function d(){return"WebkitAppearance"in document.documentElement.style||window.console&&(console.firebug||console.exception&&console.table)||navigator.userAgent.toLowerCase().match(/firefox\/(\d+)/)&&parseInt(RegExp.$1,10)>=31}function e(){var a=arguments,b=this.useColors;if(a[0]=(b?"%c":"")+this.namespace+(b?" %c":" ")+a[0]+(b?"%c ":" ")+"+"+c.humanize(this.diff),!b)return a;var d="color: "+this.color;a=[a[0],d,"color: inherit"].concat(Array.prototype.slice.call(a,1));var e=0,f=0;return a[0].replace(/%[a-z%]/g,function(a){"%%"!==a&&(e++,"%c"===a&&(f=e))}),a.splice(f,0,d),a}function f(){return"object"==typeof console&&console.log&&Function.prototype.apply.call(console.log,console,arguments)}function g(a){try{null==a?i.removeItem("debug"):i.debug=a}catch(b){}}function h(){var a;try{a=i.debug}catch(b){}return a}c=b.exports=a("./debug"),c.log=f,c.formatArgs=e,c.save=g,c.load=h,c.useColors=d;var i;i="undefined"!=typeof chrome&&"undefined"!=typeof chrome.storage?chrome.storage.local:window.localStorage,c.colors=["lightseagreen","forestgreen","goldenrod","dodgerblue","darkorchid","crimson"],c.formatters.j=function(a){return JSON.stringify(a)},c.enable(h())},{"./debug":31}],31:[function(a,b,c){function d(){return c.colors[k++%c.colors.length]}function e(a){function b(){}function e(){var a=e,b=+new Date,f=b-(j||b);a.diff=f,a.prev=j,a.curr=b,j=b,null==a.useColors&&(a.useColors=c.useColors()),null==a.color&&a.useColors&&(a.color=d());var g=Array.prototype.slice.call(arguments);g[0]=c.coerce(g[0]),"string"!=typeof g[0]&&(g=["%o"].concat(g));var h=0;g[0]=g[0].replace(/%([a-z%])/g,function(b,d){if("%%"===b)return b;h++;var e=c.formatters[d];if("function"==typeof e){var f=g[h];b=e.call(a,f),g.splice(h,1),h--}return b}),"function"==typeof c.formatArgs&&(g=c.formatArgs.apply(a,g));var i=e.log||c.log||console.log.bind(console);i.apply(a,g)}b.enabled=!1,e.enabled=!0;var f=c.enabled(a)?e:b;return f.namespace=a,f}function f(a){c.save(a);for(var b=(a||"").split(/[\s,]+/),d=b.length,e=0;d>e;e++)b[e]&&(a=b[e].replace(/\*/g,".*?"),"-"===a[0]?c.skips.push(new RegExp("^"+a.substr(1)+"$")):c.names.push(new RegExp("^"+a+"$")))}function g(){c.enable("")}function h(a){var b,d;for(b=0,d=c.skips.length;d>b;b++)if(c.skips[b].test(a))return!1;for(b=0,d=c.names.length;d>b;b++)if(c.names[b].test(a))return!0;return!1}function i(a){return a instanceof Error?a.stack||a.message:a}c=b.exports=e,c.coerce=i,c.disable=g,c.enable=f,c.enabled=h,c.humanize=a("ms"),c.names=[],c.skips=[],c.formatters={};var j,k=0},{ms:32}],32:[function(a,b){function c(a){var b=/^((?:\d+)?\.?\d+) *(ms|seconds?|s|minutes?|m|hours?|h|days?|d|years?|y)?$/i.exec(a);if(b){var c=parseFloat(b[1]),d=(b[2]||"ms").toLowerCase();switch(d){case"years":case"year":case"y":return c*k;case"days":case"day":case"d":return c*j;case"hours":case"hour":case"h":return c*i;case"minutes":case"minute":case"m":return c*h;case"seconds":case"second":case"s":return c*g;case"ms":return c}}}function d(a){return a>=j?Math.round(a/j)+"d":a>=i?Math.round(a/i)+"h":a>=h?Math.round(a/h)+"m":a>=g?Math.round(a/g)+"s":a+"ms"}function e(a){return f(a,j,"day")||f(a,i,"hour")||f(a,h,"minute")||f(a,g,"second")||a+" ms"}function f(a,b,c){return b>a?void 0:1.5*b>a?Math.floor(a/b)+" "+c:Math.ceil(a/b)+" "+c+"s"}var g=1e3,h=60*g,i=60*h,j=24*i,k=365.25*j;b.exports=function(a,b){return b=b||{},"string"==typeof a?c(a):b.long?e(a):d(a)}},{}],33:[function(a,b){var c,d=Object.prototype.hasOwnProperty,e=Object.prototype.toString,f=function(a){"use strict";if(!a||"[object Object]"!==e.call(a)||a.nodeType||a.setInterval)return!1;var b=d.call(a,"constructor"),f=a.constructor&&a.constructor.prototype&&d.call(a.constructor.prototype,"isPrototypeOf");if(a.constructor&&!b&&!f)return!1;var g;for(g in a);return g===c||d.call(a,g)};b.exports=function g(){"use strict";var a,b,d,e,h,i,j=arguments[0],k=1,l=arguments.length,m=!1;for("boolean"==typeof j?(m=j,j=arguments[1]||{},k=2):("object"!=typeof j&&"function"!=typeof j||j==c)&&(j={});l>k;++k)if(null!=(a=arguments[k]))for(b in a)d=j[b],e=a[b],j!==e&&(m&&e&&(f(e)||(h=Array.isArray(e)))?(h?(h=!1,i=d&&Array.isArray(d)?d:[]):i=d&&f(d)?d:{},j[b]=g(m,i,e)):e!==c&&(j[b]=e));return j}},{}],34:[function(a,b){"use strict";function c(){}b.exports=c},{}],35:[function(a,b){"use strict";function c(a){function b(a,b){function d(a){j[b]=a,++k===c&!i&&(i=!0,h.resolve(m,j))}f(a).then(d,function(a){i||(i=!0,h.reject(m,a))})}if("[object Array]"!==Object.prototype.toString.call(a))return e(new TypeError("must be an array"));var c=a.length,i=!1;if(!c)return f([]);for(var j=new Array(c),k=0,l=-1,m=new d(g);++l<c;)b(a[l],l);return m}var d=a("./promise"),e=a("./reject"),f=a("./resolve"),g=a("./INTERNAL"),h=a("./handlers");b.exports=c},{"./INTERNAL":34,"./handlers":36,"./promise":38,"./reject":41,"./resolve":42}],36:[function(a,b,c){"use strict";function d(a){var b=a&&a.then;return a&&"object"==typeof a&&"function"==typeof b?function(){b.apply(a,arguments)}:void 0}var e=a("./tryCatch"),f=a("./resolveThenable"),g=a("./states");c.resolve=function(a,b){var h=e(d,b);if("error"===h.status)return c.reject(a,h.value);var i=h.value;if(i)f.safely(a,i);else{a.state=g.FULFILLED,a.outcome=b;for(var j=-1,k=a.queue.length;++j<k;)a.queue[j].callFulfilled(b)}return a},c.reject=function(a,b){a.state=g.REJECTED,a.outcome=b;for(var c=-1,d=a.queue.length;++c<d;)a.queue[c].callRejected(b);return a}},{"./resolveThenable":43,"./states":44,"./tryCatch":45}],37:[function(a,b,c){b.exports=c=a("./promise"),c.resolve=a("./resolve"),c.reject=a("./reject"),c.all=a("./all"),c.race=a("./race")},{"./all":35,"./promise":38,"./race":40,"./reject":41,"./resolve":42}],38:[function(a,b){"use strict";function c(a){if(!(this instanceof c))return new c(a);if("function"!=typeof a)throw new TypeError("resolver must be a function");this.state=g.PENDING,this.queue=[],this.outcome=void 0,a!==e&&f.safely(this,a)}var d=a("./unwrap"),e=a("./INTERNAL"),f=a("./resolveThenable"),g=a("./states"),h=a("./queueItem");b.exports=c,c.prototype["catch"]=function(a){return this.then(null,a)},c.prototype.then=function(a,b){if("function"!=typeof a&&this.state===g.FULFILLED||"function"!=typeof b&&this.state===g.REJECTED)return this;var f=new c(e);if(this.state!==g.PENDING){var i=this.state===g.FULFILLED?a:b;d(f,i,this.outcome)}else this.queue.push(new h(f,a,b));return f}},{"./INTERNAL":34,"./queueItem":39,"./resolveThenable":43,"./states":44,"./unwrap":46}],39:[function(a,b){"use strict";function c(a,b,c){this.promise=a,"function"==typeof b&&(this.onFulfilled=b,this.callFulfilled=this.otherCallFulfilled),"function"==typeof c&&(this.onRejected=c,this.callRejected=this.otherCallRejected)}var d=a("./handlers"),e=a("./unwrap");b.exports=c,c.prototype.callFulfilled=function(a){d.resolve(this.promise,a)},c.prototype.otherCallFulfilled=function(a){e(this.promise,this.onFulfilled,a)},c.prototype.callRejected=function(a){d.reject(this.promise,a)},c.prototype.otherCallRejected=function(a){e(this.promise,this.onRejected,a)}},{"./handlers":36,"./unwrap":46}],40:[function(a,b){"use strict";function c(a){function b(a){f(a).then(function(a){i||(i=!0,h.resolve(k,a))},function(a){i||(i=!0,h.reject(k,a))})}if("[object Array]"!==Object.prototype.toString.call(a))return e(new TypeError("must be an array"));var c=a.length,i=!1;if(!c)return f([]);for(var j=-1,k=new d(g);++j<c;)b(a[j]);return k}var d=a("./promise"),e=a("./reject"),f=a("./resolve"),g=a("./INTERNAL"),h=a("./handlers");b.exports=c},{"./INTERNAL":34,"./handlers":36,"./promise":38,"./reject":41,"./resolve":42}],41:[function(a,b){"use strict";function c(a){var b=new d(e);return f.reject(b,a)}var d=a("./promise"),e=a("./INTERNAL"),f=a("./handlers");b.exports=c},{"./INTERNAL":34,"./handlers":36,"./promise":38}],42:[function(a,b){"use strict";function c(a){if(a)return a instanceof d?a:f.resolve(new d(e),a);var b=typeof a;switch(b){case"boolean":return g;case"undefined":return i;case"object":return h;case"number":return j;case"string":return k}}var d=a("./promise"),e=a("./INTERNAL"),f=a("./handlers");b.exports=c;var g=f.resolve(new d(e),!1),h=f.resolve(new d(e),null),i=f.resolve(new d(e),void 0),j=f.resolve(new d(e),0),k=f.resolve(new d(e),"")},{"./INTERNAL":34,"./handlers":36,"./promise":38}],43:[function(a,b,c){"use strict";function d(a,b){function c(b){h||(h=!0,e.reject(a,b))}function d(b){h||(h=!0,e.resolve(a,b))}function g(){b(d,c)}var h=!1,i=f(g);"error"===i.status&&c(i.value)}var e=a("./handlers"),f=a("./tryCatch");c.safely=d},{"./handlers":36,"./tryCatch":45}],44:[function(a,b,c){c.REJECTED=["REJECTED"],c.FULFILLED=["FULFILLED"],c.PENDING=["PENDING"]},{}],45:[function(a,b){"use strict";function c(a,b){var c={};try{c.value=a(b),c.status="success"}catch(d){c.status="error",c.value=d}return c}b.exports=c},{}],46:[function(a,b){"use strict";function c(a,b,c){d(function(){var d;try{d=b(c)}catch(f){return e.reject(a,f)}d===a?e.reject(a,new TypeError("Cannot resolve promise with itself")):e.resolve(a,d)})}var d=a("immediate"),e=a("./handlers");b.exports=c},{"./handlers":36,immediate:47}],47:[function(a,b){"use strict";function c(){e=!0;for(var a,b,c=h.length;c;){for(b=h,h=[],a=-1;++a<c;)b[a]();c=h.length}e=!1}function d(a){1!==h.push(a)||e||f()}for(var e,f,g=[a("./nextTick"),a("./mutation.js"),a("./messageChannel"),a("./stateChange"),a("./timeout")],h=[],i=-1,j=g.length;++i<j;)if(g[i]&&g[i].test&&g[i].test()){f=g[i].install(c);break}b.exports=d},{"./messageChannel":48,"./mutation.js":49,"./nextTick":28,"./stateChange":50,"./timeout":51}],48:[function(a,b,c){(function(a){"use strict";c.test=function(){return a.setImmediate?!1:"undefined"!=typeof a.MessageChannel},c.install=function(b){var c=new a.MessageChannel;return c.port1.onmessage=b,function(){c.port2.postMessage(0)}}}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{}],49:[function(a,b,c){(function(a){"use strict";var b=a.MutationObserver||a.WebKitMutationObserver;c.test=function(){return b},c.install=function(c){var d=0,e=new b(c),f=a.document.createTextNode("");return e.observe(f,{characterData:!0}),function(){f.data=d=++d%2}}}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{}],50:[function(a,b,c){(function(a){"use strict";c.test=function(){return"document"in a&&"onreadystatechange"in a.document.createElement("script")},c.install=function(b){return function(){var c=a.document.createElement("script");return c.onreadystatechange=function(){b(),c.onreadystatechange=null,c.parentNode.removeChild(c),c=null},a.document.documentElement.appendChild(c),b}}}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{}],51:[function(a,b,c){"use strict";c.test=function(){return!0},c.install=function(a){return function(){setTimeout(a,0)}}},{}],52:[function(a,b){!function(){function a(){return{dateFields:[]}}function c(a,b){return a+"."+b}function d(b){b.siesta_meta=a();for(var c in b)b.hasOwnProperty(c)&&b[c]instanceof Date&&(b.siesta_meta.dateFields.push(c),b[c]=b[c].getTime())}function e(b){var c=b.siesta_meta||a();c.dateFields.forEach(function(a){var c=b[a];c instanceof Date||(b[a]=new Date(c))}),delete b.siesta_meta}function f(a,b){var d=c(a,b),e={};return e[d]={map:function(a){"$1"==a.collection&&"$2"==a.model&&emit(a.collection+"."+a.model,a)}.toString().replace("$1",a).replace("$2",b)},{_id:"_design/"+d,views:e}}function g(){var a=[],b=siesta._internal.CollectionRegistry;return b.collectionNames.forEach(function(c){var d=b[c]._models;for(var e in d)d.hasOwnProperty(e)&&a.push(f(c,e))}),a}function h(a,b){C.bulkDocs(a).then(function(a){for(var c=[],d=0;d<a.length;d++){var e=a[d];if(!e.ok){var f=409==e.status;f||c.push(e)}}b(c.length?t("multiple errors",{errors:c}):null)}).catch(b)}function i(a){var b=g();h(b,a)}function j(a){var b=siesta._.extend({},a.__values);d(b),b.collection=a.collectionName,b.model=a.modelName,b._id=a._id,a.removed&&(b._deleted=!0);var c=a._rev;return c&&(b._rev=c),b=v.reduce(a._relationshipNames,function(b,c){var d=a[c];return siesta.isArray(d)?b[c]=v.pluck(d,"_id"):d&&(b[c]=d._id),b},b)}function k(a,b){e(a),delete a.collection,delete a.model;var c=b._relationshipNames;return v.each(c,function(b){var c=a[b];a[b]=siesta.isArray(c)?v.map(c,function(a){return{_id:a}}):{_id:c}}),a}function l(a,b){var d=a.collectionName,e=a.modelName,f=c(d,e);s("Loading instances for "+f);var g=r[d][e];s("Querying pouch"),C.query(f).then(function(a){s("Queried pouch successfully");var c=siesta._.map(siesta._.pluck(a.rows,"value"),function(a){return k(a,g)});s("Mapping data",c),g.graph(c,{disableevents:!0,_ignoreInstalled:!0,fromStorage:!0},function(a,c){a?s("Error loading models",a):s.enabled&&s(c.length.toString()),b(a,c)})}).catch(function(a){b(a)})}function m(a){if(F)throw new Error("not loaded yet how can i save");return u.promise(a,function(a){if(siesta.ext.storageEnabled){var b=r.collectionNames,c=[];v.each(b,function(a){var b=r[a],d=Object.keys(b._models);v.each(d,function(b){c.push(function(c){A._loadModel({collectionName:a,modelName:b},c)})})}),siesta.async.series(c,function(b,c){var d;if(!b){var e=[];siesta._.each(c,function(a){e=e.concat(a)}),d=e.length,s&&s("Loaded "+d.toString()+" instances")}a(b,d)})}else a()}.bind(this))}function n(a,b){C.allDocs({keys:v.pluck(a,"_id")}).then(function(c){for(var d=0;d<c.rows.length;d++)a[d]._rev=c.rows[d].value.rev;o(a,b)}).catch(function(a){b(a)})}function o(a,b){var c=[];C.bulkDocs(v.map(a,j)).then(function(d){for(var e=0;e<d.length;e++){var f=d[e],g=a[e];f.ok?g._rev=f.rev:409==f.status?c.push(g):s('Error saving object with _id="'+g._id+'"',f)}c.length?n(c,b):b()},function(a){b(a)})}function p(a){return u.promise(a,function(a){siesta._afterInstall(function(){var b=x;x=[],y={},z={},s&&s("Saving objects",v.map(b,function(a){return a._dump()})),o(b,a)})}.bind(this))}if("undefined"==typeof siesta&&"undefined"==typeof b)throw new Error("Could not find window.siesta. Make sure you include siesta.core.js first.");var q=siesta._internal,r=(q.cache,q.CollectionRegistry),s=q.log("Storage"),t=q.error,u=q.util,v=u._,w=q.events,x=[],y={},z={},A={};if("undefined"==typeof PouchDB)siesta.ext.storageEnabled=!1,console.log("PouchDB is not present therefore storage is disabled.");else{var B="siesta",C=new PouchDB(B,{auto_compaction:!0}),D=function(a){var b=a.obj,c=b._id;if(!b)throw new q.error.InternalSiestaError("No obj field in notification received by storage extension");if(!(c in y)){y[c]=b,x.push(b);var d=b.collectionName;z[d]||(z[d]={});var e=b.model.name;z[d][e]||(z[d][e]={}),z[d][e][c]=b}};siesta.on("Siesta",D),v.extend(A,{_load:m,_loadModel:l,save:p,_serialise:j,ensureIndexesForAll:i,_reset:function(a){siesta.removeListener("Siesta",D),x=[],y={},C.destroy(function(b){b||(C=new PouchDB(B)),siesta.on("Siesta",D),s("Reset complete"),a(b)})}}),Object.defineProperties(A,{_unsavedObjects:{get:function(){return x}},_unsavedObjectsHash:{get:function(){return y}},_unsavedObjectsByCollection:{get:function(){return z}},_pouch:{get:function(){return C}}}),siesta.ext||(siesta.ext={}),siesta.ext.storage=A,Object.defineProperties(siesta.ext,{storageEnabled:{get:function(){return void 0!==siesta.ext._storageEnabled?siesta.ext._storageEnabled:!!siesta.ext.storage},set:function(a){siesta.ext._storageEnabled=a},enumerable:!0}});var E,F,G=1e3;Object.defineProperties(siesta,{autosave:{get:function(){return!!E},set:function(a){a?E||(E=setInterval(function(){F||(F=!0,siesta.save(function(a){a||w.emit("saved"),F=!1}))},siesta.autosaveInterval)):E&&(clearInterval(E),E=null)}},autosaveInterval:{get:function(){return G},set:function(a){G=a,E&&(siesta.autosave=!1,siesta.autosave=!0)}},dirty:{get:function(){var a=siesta.ext.storage._unsavedObjectsByCollection;return!!Object.keys(a).length},enumerable:!0}}),v.extend(siesta,{save:p,setPouch:function(a){if(!siesta._canChange)throw new Error("Cannot change PouchDB instance when an object graph exists.");C=a}})}b.exports=A}()},{}],53:[function(require,module,exports){(function(global){!function(global){"use strict";function detectObjectObserve(){function a(a){b=a}if("function"!=typeof Object.observe||"function"!=typeof Array.observe)return!1;var b=[],c={},d=[];return Object.observe(c,a),Array.observe(d,a),c.id=1,c.id=2,delete c.id,d.push(1,2),d.length=0,Object.deliverChangeRecords(a),5!==b.length?!1:"add"!=b[0].type||"update"!=b[1].type||"delete"!=b[2].type||"splice"!=b[3].type||"splice"!=b[4].type?!1:(Object.unobserve(c,a),Array.unobserve(d,a),!0)}function detectEval(){if("undefined"!=typeof chrome&&chrome.app&&chrome.app.runtime)return!1;if(navigator.getDeviceStorage)return!1;try{var a=new Function("","return true;");return a()}catch(b){return!1}}function isIndex(a){return+a===a>>>0&&""!==a}function toNumber(a){return+a}function dirtyCheck(a){for(var b=0;MAX_DIRTY_CHECK_CYCLES>b&&a.check_();)b++;return testingExposeCycleCount&&(global.dirtyCheckCycleCount=b),b>0}function objectIsEmpty(a){for(var b in a)return!1;return!0}function diffIsEmpty(a){return objectIsEmpty(a.added)&&objectIsEmpty(a.removed)&&objectIsEmpty(a.changed)}function diffObjectFromOldObject(a,b){var c={},d={},e={};for(var f in b){var g=a[f];(void 0===g||g!==b[f])&&(f in a?g!==b[f]&&(e[f]=g):d[f]=void 0)}for(var f in a)f in b||(c[f]=a[f]);return Array.isArray(a)&&a.length!==b.length&&(e.length=a.length),{added:c,removed:d,changed:e}}function runEOMTasks(){if(!eomTasks.length)return!1;for(var a=0;a<eomTasks.length;a++)eomTasks[a]();return eomTasks.length=0,!0}function newObservedObject(){function a(a){b&&b.state_===OPENED&&!d&&b.check_(a)}var b,c,d=!1,e=!0;return{open:function(c){if(b)throw Error("ObservedObject in use");e||Object.deliverChangeRecords(a),b=c,e=!1},observe:function(b,d){c=b,d?Array.observe(c,a):Object.observe(c,a)},deliver:function(b){d=b,Object.deliverChangeRecords(a),d=!1},close:function(){b=void 0,Object.unobserve(c,a),observedObjectCache.push(this)}}}function getObservedObject(a,b,c){var d=observedObjectCache.pop()||newObservedObject();return d.open(a),d.observe(b,c),d}function newObservedSet(){function a(b,f){b&&(b===d&&(e[f]=!0),h.indexOf(b)<0&&(h.push(b),Object.observe(b,c)),a(Object.getPrototypeOf(b),f))}function b(a){for(var b=0;b<a.length;b++){var c=a[b];if(c.object!==d||e[c.name]||"setPrototype"===c.type)return!1}return!0}function c(c){if(!b(c)){for(var d,e=0;e<g.length;e++)d=g[e],d.state_==OPENED&&d.iterateObjects_(a);for(var e=0;e<g.length;e++)d=g[e],d.state_==OPENED&&d.check_()}}var d,e,f=0,g=[],h=[],i={object:void 0,objects:h,open:function(b,c){d||(d=c,e={}),g.push(b),f++,b.iterateObjects_(a)},close:function(){if(f--,!(f>0)){for(var a=0;a<h.length;a++)Object.unobserve(h[a],c),Observer.unobservedCount++;g.length=0,h.length=0,d=void 0,e=void 0,observedSetCache.push(this)}}};return i}function Observer(){this.state_=UNOPENED,this.callback_=void 0,this.target_=void 0,this.directObserver_=void 0,this.value_=void 0,this.id_=nextObserverId++}function addToAll(a){Observer._allObserversCount++,collectObservers&&allObservers.push(a)}function removeFromAll(){Observer._allObserversCount--}function ObjectObserver(a){Observer.call(this),this.value_=a,this.oldObject_=void 0}function ArrayObserver(a){if(!Array.isArray(a))throw Error("Provided object is not an Array");ObjectObserver.call(this,a)}function diffObjectFromChangeRecords(a,b,c){for(var d={},e={},f=0;f<b.length;f++){var g=b[f];expectedRecordTypes[g.type]?(g.name in c||(c[g.name]=g.oldValue),"update"!=g.type&&("add"!=g.type?g.name in d?(delete d[g.name],delete c[g.name]):e[g.name]=!0:g.name in e?delete e[g.name]:d[g.name]=!0)):(console.error("Unknown changeRecord type: "+g.type),console.error(g))}for(var h in d)d[h]=a[h];for(var h in e)e[h]=void 0;var i={};for(var h in c)if(!(h in d||h in e)){var j=a[h];c[h]!==j&&(i[h]=j)}return{added:d,removed:e,changed:i}}function newSplice(a,b,c){return{index:a,removed:b,addedCount:c}}function ArraySplice(){}function calcSplices(a,b,c,d,e,f){return arraySplice.calcSplices(a,b,c,d,e,f)}function intersect(a,b,c,d){return c>b||a>d?-1:b==c||d==a?0:c>a?d>b?b-c:d-c:b>d?d-a:b-a}function mergeSplice(a,b,c,d){for(var e=newSplice(b,c,d),f=!1,g=0,h=0;h<a.length;h++){var i=a[h];if(i.index+=g,!f){var j=intersect(e.index,e.index+e.removed.length,i.index,i.index+i.addedCount);if(j>=0){a.splice(h,1),h--,g-=i.addedCount-i.removed.length,e.addedCount+=i.addedCount-j;var k=e.removed.length+i.removed.length-j;if(e.addedCount||k){var c=i.removed;if(e.index<i.index){var l=e.removed.slice(0,i.index-e.index);Array.prototype.push.apply(l,c),c=l}if(e.index+e.removed.length>i.index+i.addedCount){var m=e.removed.slice(i.index+i.addedCount-e.index);Array.prototype.push.apply(c,m)}e.removed=c,i.index<e.index&&(e.index=i.index)}else f=!0}else if(e.index<i.index){f=!0,a.splice(h,0,e),h++;var n=e.addedCount-e.removed.length;i.index+=n,g+=n}}}f||a.push(e)}function createInitialSplices(a,b){for(var c=[],d=0;d<b.length;d++){var e=b[d];switch(e.type){case"splice":mergeSplice(c,e.index,e.removed.slice(),e.addedCount);break;case"add":case"update":case"delete":if(!isIndex(e.name))continue;var f=toNumber(e.name);if(0>f)continue;mergeSplice(c,f,[e.oldValue],1);break;default:console.error("Unexpected record type: "+JSON.stringify(e))}}return c}function projectArraySplices(a,b){var c=[];return createInitialSplices(a,b).forEach(function(b){return 1==b.addedCount&&1==b.removed.length?void(b.removed[0]!==a[b.index]&&c.push(b)):void(c=c.concat(calcSplices(a,b.index,b.index+b.addedCount,b.removed,0,b.removed.length)))}),c}var testingExposeCycleCount=global.testingExposeCycleCount,hasObserve=detectObjectObserve(),hasEval=detectEval(),numberIsNaN=global.Number.isNaN||function(a){return"number"==typeof a&&global.isNaN(a)},createObject="__proto__"in{}?function(a){return a}:function(a){var b=a.__proto__;if(!b)return a;var c=Object.create(b);return Object.getOwnPropertyNames(a).forEach(function(b){Object.defineProperty(c,b,Object.getOwnPropertyDescriptor(a,b))}),c},identStart="[$_a-zA-Z]",identPart="[$_a-zA-Z0-9]",MAX_DIRTY_CHECK_CYCLES=1e3,eomTasks=[],runEOM=hasObserve?function(){var a={pingPong:!0},b=!1;return Object.observe(a,function(){runEOMTasks(),b=!1}),function(c){eomTasks.push(c),b||(b=!0,a.pingPong=!a.pingPong)}}():function(){return function(a){eomTasks.push(a)}}(),observedObjectCache=[],observedSetCache=[],lastObservedSet,UNOPENED=0,OPENED=1,CLOSED=2,nextObserverId=1;Observer.prototype={open:function(a,b){if(this.state_!=UNOPENED)throw Error("Observer has already been opened.");return addToAll(this),this.callback_=a,this.target_=b,this.connect_(),this.state_=OPENED,this.value_},close:function(){this.state_==OPENED&&(removeFromAll(this),this.disconnect_(),this.value_=void 0,this.callback_=void 0,this.target_=void 0,this.state_=CLOSED)},deliver:function(){this.state_==OPENED&&dirtyCheck(this)},report_:function(a){try{this.callback_.apply(this.target_,a)}catch(b){Observer._errorThrownDuringCallback=!0,console.error("Exception caught during observer callback: "+(b.stack||b))}},discardChanges:function(){return this.check_(void 0,!0),this.value_}};var collectObservers=!hasObserve,allObservers;Observer._allObserversCount=0,collectObservers&&(allObservers=[]);var runningMicrotaskCheckpoint=!1,hasDebugForceFullDelivery=hasObserve&&hasEval&&function(){try{return eval("%RunMicrotasks()"),!0}catch(ex){return!1}}();global.Platform=global.Platform||{},global.Platform.performMicrotaskCheckpoint=function(){if(!runningMicrotaskCheckpoint){if(hasDebugForceFullDelivery)return void eval("%RunMicrotasks()");if(collectObservers){runningMicrotaskCheckpoint=!0;var cycles=0,anyChanged,toCheck;do{cycles++,toCheck=allObservers,allObservers=[],anyChanged=!1;for(var i=0;i<toCheck.length;i++){var observer=toCheck[i];observer.state_==OPENED&&(observer.check_()&&(anyChanged=!0),allObservers.push(observer))}runEOMTasks()&&(anyChanged=!0)}while(MAX_DIRTY_CHECK_CYCLES>cycles&&anyChanged);testingExposeCycleCount&&(global.dirtyCheckCycleCount=cycles),runningMicrotaskCheckpoint=!1}}},collectObservers&&(global.Platform.clearObservers=function(){allObservers=[]}),ObjectObserver.prototype=createObject({__proto__:Observer.prototype,arrayObserve:!1,connect_:function(){hasObserve?this.directObserver_=getObservedObject(this,this.value_,this.arrayObserve):this.oldObject_=this.copyObject(this.value_)},copyObject:function(a){var b=Array.isArray(a)?[]:{};for(var c in a)b[c]=a[c];return Array.isArray(a)&&(b.length=a.length),b},check_:function(a){var b,c;if(hasObserve){if(!a)return!1;c={},b=diffObjectFromChangeRecords(this.value_,a,c)}else c=this.oldObject_,b=diffObjectFromOldObject(this.value_,this.oldObject_);return diffIsEmpty(b)?!1:(hasObserve||(this.oldObject_=this.copyObject(this.value_)),this.report_([b.added||{},b.removed||{},b.changed||{},function(a){return c[a]}]),!0)},disconnect_:function(){hasObserve?(this.directObserver_.close(),this.directObserver_=void 0):this.oldObject_=void 0},deliver:function(){this.state_==OPENED&&(hasObserve?this.directObserver_.deliver(!1):dirtyCheck(this))},discardChanges:function(){return this.directObserver_?this.directObserver_.deliver(!0):this.oldObject_=this.copyObject(this.value_),this.value_}}),ArrayObserver.prototype=createObject({__proto__:ObjectObserver.prototype,arrayObserve:!0,copyObject:function(a){return a.slice()},check_:function(a){var b;if(hasObserve){if(!a)return!1;b=projectArraySplices(this.value_,a)}else b=calcSplices(this.value_,0,this.value_.length,this.oldObject_,0,this.oldObject_.length);return b&&b.length?(hasObserve||(this.oldObject_=this.copyObject(this.value_)),this.report_([b]),!0):!1}}),ArrayObserver.applySplices=function(a,b,c){c.forEach(function(c){for(var d=[c.index,c.removed.length],e=c.index;e<c.index+c.addedCount;)d.push(b[e]),e++;Array.prototype.splice.apply(a,d)})};var observerSentinel={},expectedRecordTypes={add:!0,update:!0,"delete":!0},EDIT_LEAVE=0,EDIT_UPDATE=1,EDIT_ADD=2,EDIT_DELETE=3;ArraySplice.prototype={calcEditDistances:function(a,b,c,d,e,f){for(var g=f-e+1,h=c-b+1,i=new Array(g),j=0;g>j;j++)i[j]=new Array(h),i[j][0]=j;for(var k=0;h>k;k++)i[0][k]=k;for(var j=1;g>j;j++)for(var k=1;h>k;k++)if(this.equals(a[b+k-1],d[e+j-1]))i[j][k]=i[j-1][k-1];else{var l=i[j-1][k]+1,m=i[j][k-1]+1;i[j][k]=m>l?l:m}return i},spliceOperationsFromEditDistances:function(a){for(var b=a.length-1,c=a[0].length-1,d=a[b][c],e=[];b>0||c>0;)if(0!=b)if(0!=c){var f,g=a[b-1][c-1],h=a[b-1][c],i=a[b][c-1];f=i>h?g>h?h:g:g>i?i:g,f==g?(g==d?e.push(EDIT_LEAVE):(e.push(EDIT_UPDATE),d=g),b--,c--):f==h?(e.push(EDIT_DELETE),b--,d=h):(e.push(EDIT_ADD),c--,d=i)
}else e.push(EDIT_DELETE),b--;else e.push(EDIT_ADD),c--;return e.reverse(),e},calcSplices:function(a,b,c,d,e,f){var g=0,h=0,i=Math.min(c-b,f-e);if(0==b&&0==e&&(g=this.sharedPrefix(a,d,i)),c==a.length&&f==d.length&&(h=this.sharedSuffix(a,d,i-g)),b+=g,e+=g,c-=h,f-=h,c-b==0&&f-e==0)return[];if(b==c){for(var j=newSplice(b,[],0);f>e;)j.removed.push(d[e++]);return[j]}if(e==f)return[newSplice(b,[],c-b)];for(var k=this.spliceOperationsFromEditDistances(this.calcEditDistances(a,b,c,d,e,f)),j=void 0,l=[],m=b,n=e,o=0;o<k.length;o++)switch(k[o]){case EDIT_LEAVE:j&&(l.push(j),j=void 0),m++,n++;break;case EDIT_UPDATE:j||(j=newSplice(m,[],0)),j.addedCount++,m++,j.removed.push(d[n]),n++;break;case EDIT_ADD:j||(j=newSplice(m,[],0)),j.addedCount++,m++;break;case EDIT_DELETE:j||(j=newSplice(m,[],0)),j.removed.push(d[n]),n++}return j&&l.push(j),l},sharedPrefix:function(a,b,c){for(var d=0;c>d;d++)if(!this.equals(a[d],b[d]))return d;return c},sharedSuffix:function(a,b,c){for(var d=a.length,e=b.length,f=0;c>f&&this.equals(a[--d],b[--e]);)f++;return f},calculateSplices:function(a,b){return this.calcSplices(a,0,a.length,b,0,b.length)},equals:function(a,b){return a===b}};var arraySplice=new ArraySplice,expose=global;"undefined"!=typeof exports&&("undefined"!=typeof module&&module.exports&&(expose=exports=module.exports),expose=exports),expose.Observer=Observer,expose.Observer.runEOM_=runEOM,expose.Observer.observerSentinel_=observerSentinel,expose.Observer.hasObjectObserve=hasObserve,expose.ArrayObserver=ArrayObserver,expose.ArrayObserver.calculateSplices=function(a,b){return arraySplice.calculateSplices(a,b)},expose.Platform=global.Platform,expose.ArraySplice=ArraySplice,expose.ObjectObserver=ObjectObserver}("undefined"!=typeof global&&global&&"undefined"!=typeof module&&module?global:this||window)}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{}]},{},[16]);